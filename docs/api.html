<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mongoose API v3.0.0alpha2</title><link href="http://fonts.googleapis.com/css?family=Anonymous+Pro:400,700|Droid+Sans+Mono|Open+Sans:400,700|Linden+Hill|Quattrocento:400,700|News+Cycle:400,700|Antic+Slab|Cabin+Condensed:400,700" rel="stylesheet" type="text/css"><link href="/docs/css/default.css" rel="stylesheet" type="text/css"><style>body {
  background: #d8e2d8 url(/docs/images/square_bg.png) fixed;
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  color: #333;
  -webkit-font-smoothing: antialiased;
  -webkit-text-size-adjust: 100%;
  padding: 0;
  margin: 0;
  font-size: 14px;
  line-height: 22px;
}
a {
  color: #800;
  -webkit-transition-property: opacity, -webkit-transform, color, background-color, padding, -webkit-box-shadow;
  -webkit-transition-duration: 0.15s;
  -webkit-transition-timing-function: ease-out;
}
a:hover {
  opacity: 0.8;
}
#wrap {
}
h1 {
  font-family: 'Helvetica Nueue', Helvetica, Arial, FreeSans, sans-serif;
  text-rendering: geometricPrecision;
}
pre {
  background: rgba(255,255,255,.8);
  border: 1px solid #bbb;
  padding:5px;
  border-radius: 3px;
  box-shadow: 1px 3px 6px #ddd;
}
code {
  background: rgba(255,255,255,.8);
  color: #333;
  border-radius: 3px;
  font-size: 13px;
  font-family: Monaco;
  /*text-shadow: 1px 2px 2px #555;*/
}
pre code {
  border: 0 none;
  padding: 1.2em;
  overflow-x: auto;
}
h3 code {
  font-weight: normal;
}
hr {
  display: none;
  height: 1px;
  border: 0 none;
  padding: 0;
  margin: 90px 0;
  background: -webkit-gradient(linear, left top, right top, from(rgba(57, 172, 57, 0.0)), color-stop(0.5, rgba(57, 172, 57, 0.33)), to(rgba(57, 172, 57, 0.0)))
}
.doclinks hr {
  margin: 10px 0;
}
li {
  list-style: square;
}
#header {
  padding-top: 12px;
  padding-bottom: 25px;
}
#header h1 {
  margin-top: 0;
  margin-bottom: 0;
}
#header h1 a {
  text-decoration: none;
}
#header .mongoose {
  font-size: 50px;
  font-weight: 100;
  color: #fff;
  text-shadow: 4px 4px 5px #777, -3px 0px 2px white;
  letter-spacing: -7px;
}
#links {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  width: 210px;
  overflow-x: hidden;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 15px 0 30px 20px;
  border-right: 1px solid #ddd;
  background: -webkit-gradient(linear, left top, right top, from(transparent), color-stop(0.92, transparent), color-stop(0.9201, rgba(172,172,172, 0.0)), to(rgba(172,172,172, 0.4))), transparent;
}
#docs {
  padding: 0;
  margin: 0 0 30px 230px;
  overflow-x: hidden;
}
#docs p {
  word-wrap: break-word;
}
#docs > ul {
  margin: 0;
  padding: 0;
}
.private {
  display: none;
}
.module {
  list-style: none;
  padding: 30px 0 30px 30px;
  border-color: #eee;
  border-width: 9px 10px;
  border-style: solid;
  background-color: #fff;
}
.module > * {
  max-width: 700px;
}
.method, .property {
  margin-bottom: 175px;
}
.property h3 span {
  color: #444;
}
.sourcecode {
  display: none;
}
.showcode {
  font-size: 12px;
  cursor: pointer;
  display: none;
}
.load .showcode {
  display: block;
}
.types a {
  text-decoration: none;
}
@media only screen and (device-width: 768px) {

}
@media only screen and (max-width: 480px) {
  #links { display: none; }
  #docs { margin-left: 0; }
  .module {
    padding-left: 5px;
    border-width: 3px;
  }
}</style></head><body class="api"><a href="http://github.com/learnboost/mongoose"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a><div id="links"><div id="header"><h1><a href="https://github.com/learnboost/mongoose" target="blank"><div class="mongoose">Mongoose</div></a></h1></div><div class="doclinks"><ul><li>plugins</li><li>support</li><li>home</li><li>fork</li><li>guide</li><li>change log</li><li>contributors</li></ul><hr><a href="#lib/collection.js" class="section">lib/collection.js</a><ul><li class=""><a href="#function Object() { [native code] }-Collection">Collection</a></li><li class="private"><a href="#Collection-onOpen">onOpen</a></li><li class="private"><a href="#Collection-onClose">onClose</a></li><li class="private"><a href="#Collection-addQueue">addQueue</a></li><li class="private"><a href="#Collection-doQueue">doQueue</a></li><li class=""><a href="#Collection-ensureIndex">ensureIndex</a></li><li class=""><a href="#Collection-findAndModify">findAndModify</a></li><li class=""><a href="#Collection-findOne">findOne</a></li><li class=""><a href="#Collection-find">find</a></li><li class=""><a href="#Collection-insert">insert</a></li><li class=""><a href="#Collection-save">save</a></li><li class=""><a href="#Collection-update">update</a></li><li class=""><a href="#Collection-getIndexes">getIndexes</a></li><li class=""><a href="#Collection-mapReduce">mapReduce</a></li><li><a href="#Collection-conn">conn</a></li><li><a href="#Collection-name">name</a></li></ul><a href="#lib/connection.js" class="section">lib/connection.js</a><ul><li class=""><a href="#function Object() { [native code] }-Connection">Connection</a></li><li class=""><a href="#Connection-open">open</a></li><li class=""><a href="#Connection-openSet">openSet</a></li><li class="private"><a href="#Connection-error">error</a></li><li class="private"><a href="#Connection-_open">_open</a></li><li class="private"><a href="#Connection-onOpen">onOpen</a></li><li class=""><a href="#Connection-close">close</a></li><li class="private"><a href="#Connection-onClose">onClose</a></li><li class=""><a href="#Connection-collection">collection</a></li><li class=""><a href="#Connection-model">model</a></li><li class=""><a href="#Connection-setProfiling">setProfiling</a></li><li class="private"><a href="#Connection-defaultOptions">defaultOptions</a></li><li><a href="#Connection-db">db</a></li><li><a href="#Connection-collections">collections</a></li><li><a href="#Connection-readyState">readyState</a></li></ul><a href="#lib/connectionstate.js" class="section">lib/connectionstate.js</a><ul></ul><a href="#lib/document.js" class="section">lib/document.js</a><ul><li class="private"><a href="#function Object() { [native code] }-Document">Document</a></li><li class="private"><a href="#Document-_buildDoc">_buildDoc</a></li><li class="private"><a href="#Document-init">init</a></li><li class="private"><a href="#function Object() { [native code] }-init">init</a></li><li class="private"><a href="#Document-_storeShard">_storeShard</a></li><li class=""><a href="#Document-update">update</a></li><li class=""><a href="#Document-set">set</a></li><li class="private"><a href="#Document-_set">_set</a></li><li class="private"><a href="#Document-getValue">getValue</a></li><li class="private"><a href="#Document-setValue">setValue</a></li><li class=""><a href="#Document-get">get</a></li><li class="private"><a href="#Document-_path">_path</a></li><li class=""><a href="#Document-markModified">markModified</a></li><li class="private"><a href="#Document-try">try</a></li><li class=""><a href="#Document-modifiedPaths">modifiedPaths</a></li><li class=""><a href="#Document-isModified">isModified</a></li><li class=""><a href="#Document-isDirectModified">isDirectModified</a></li><li class=""><a href="#Document-isInit">isInit</a></li><li class=""><a href="#Document-isSelected">isSelected</a></li><li class=""><a href="#Document-validate">validate</a></li><li class=""><a href="#Document-invalidate">invalidate</a></li><li class="private"><a href="#Document-_reset">_reset</a></li><li class="private"><a href="#Document-_dirty">_dirty</a></li><li class="private"><a href="#function Object() { [native code] }-compile">compile</a></li><li class="private"><a href="#function Object() { [native code] }-define">define</a></li><li class="private"><a href="#Document-_setSchema">_setSchema</a></li><li class="private"><a href="#Document-_registerHooks">_registerHooks</a></li><li class="private"><a href="#Document-_error">_error</a></li><li class="private"><a href="#Document-_doQueue">_doQueue</a></li><li class=""><a href="#Document-toObject">toObject</a></li><li class="private"><a href="#function Object() { [native code] }-applyGetters">applyGetters</a></li><li class=""><a href="#Document-toJSON">toJSON</a></li><li class=""><a href="#Document-equals">equals</a></li><li><a href="#Document-errors">errors</a></li><li><a href="#Document-isNew">isNew</a></li><li><a href="#Document-schema">schema</a></li></ul><a href="#lib/drivers/node-mongodb-native/binary.js" class="section">lib/drivers/node-mongodb-native/binary.js</a><ul></ul><a href="#lib/drivers/node-mongodb-native/collection.js" class="section">lib/drivers/node-mongodb-native/collection.js</a><ul><li class="private"><a href="#function Object() { [native code] }-MongooseCollection">MongooseCollection</a></li><li class="private"><a href="#MongooseCollection-onOpen">onOpen</a></li><li class="private"><a href="#MongooseCollection-onClose">onClose</a></li></ul><a href="#lib/drivers/node-mongodb-native/connection.js" class="section">lib/drivers/node-mongodb-native/connection.js</a><ul><li class="private"><a href="#function Object() { [native code] }-NativeConnection">NativeConnection</a></li><li class="private"><a href="#NativeConnection-doOpen">doOpen</a></li><li class="private"><a href="#NativeConnection-doOpenSet">doOpenSet</a></li><li class="private"><a href="#NativeConnection-doClose">doClose</a></li></ul><a href="#lib/drivers/node-mongodb-native/objectid.js" class="section">lib/drivers/node-mongodb-native/objectid.js</a><ul><li class="private"><a href="#function Object() { [native code] }-ObjectIdToString">ObjectIdToString</a></li><li class="private"><a href="#function Object() { [native code] }-fromString">fromString</a></li><li class="private"><a href="#function Object() { [native code] }-toString">toString</a></li></ul><a href="#lib/error.js" class="section">lib/error.js</a><ul><li class="private"><a href="#function Object() { [native code] }-MongooseError">MongooseError</a></li></ul><a href="#lib/errors/document.js" class="section">lib/errors/document.js</a><ul><li class="private"><a href="#function Object() { [native code] }-DocumentError">DocumentError</a></li><li class=""><a href="#DocumentError-__proto__">__proto__</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/errors/validation.js" class="section">lib/errors/validation.js</a><ul><li class="private"><a href="#function Object() { [native code] }-ValidationError">ValidationError</a></li><li class=""><a href="#ValidationError-__proto__">__proto__</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/index.js" class="section">lib/index.js</a><ul><li class=""><a href="#function Object() { [native code] }-Mongoose">Mongoose</a></li><li class=""><a href="#Mongoose-createConnection">createConnection</a></li><li class=""><a href="#Mongoose-connect">connect</a></li><li class=""><a href="#Mongoose-disconnect">disconnect</a></li><li class=""><a href="#Mongoose-model">model</a></li><li class=""><a href="#Mongoose-plugin">plugin</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li><li class=""><a href="#function Object() { [native code] }-Collection">Collection</a></li><li class=""><a href="#function Object() { [native code] }-Connection">Connection</a></li><li class=""><a href="#function Object() { [native code] }-version">version</a></li><li class=""><a href="#function Object() { [native code] }-Mongoose">Mongoose</a></li><li class=""><a href="#function Object() { [native code] }-Schema">Schema</a></li><li class=""><a href="#function Object() { [native code] }-SchemaType">SchemaType</a></li><li class=""><a href="#function Object() { [native code] }-VirtualType">VirtualType</a></li><li class=""><a href="#function Object() { [native code] }-Types">Types</a></li><li class=""><a href="#function Object() { [native code] }-Query">Query</a></li><li class=""><a href="#function Object() { [native code] }-Promise">Promise</a></li><li class=""><a href="#function Object() { [native code] }-Model">Model</a></li><li class=""><a href="#function Object() { [native code] }-Document">Document</a></li><li class=""><a href="#function Object() { [native code] }-Error">Error</a></li><li class=""><a href="#function Object() { [native code] }-mongo">mongo</a></li><li><a href="#Mongoose-connection">connection</a></li></ul><a href="#lib/model.js" class="section">lib/model.js</a><ul><li class=""><a href="#function Object() { [native code] }-Model">Model</a></li><li class="private"><a href="#Model-_getPopulationKeys">_getPopulationKeys</a></li><li class="private"><a href="#Model-_populate">_populate</a></li><li class="private"><a href="#Model-init">init</a></li><li class=""><a href="#Model-save">save</a></li><li class="private"><a href="#Model-_delta">_delta</a></li><li class="private"><a href="#Model-_version">_version</a></li><li class=""><a href="#Model-increment">increment</a></li><li class="private"><a href="#Model-_where">_where</a></li><li class=""><a href="#Model-remove">remove</a></li><li class="private"><a href="#Model-_registerHooks">_registerHooks</a></li><li class=""><a href="#Model-model">model</a></li><li class="private"><a href="#function Object() { [native code] }-init">init</a></li><li class=""><a href="#function Object() { [native code] }-ensureIndexes">ensureIndexes</a></li><li class=""><a href="#function Object() { [native code] }-remove">remove</a></li><li class=""><a href="#function Object() { [native code] }-find">find</a></li><li class="private"><a href="#function Object() { [native code] }-_applyNamedScope">_applyNamedScope</a></li><li class=""><a href="#function Object() { [native code] }-findById">findById</a></li><li class=""><a href="#function Object() { [native code] }-findOne">findOne</a></li><li class=""><a href="#function Object() { [native code] }-count">count</a></li><li class=""><a href="#function Object() { [native code] }-distinct">distinct</a></li><li class=""><a href="#function Object() { [native code] }-where">where</a></li><li class=""><a href="#function Object() { [native code] }-findOneAndUpdate">findOneAndUpdate</a></li><li class=""><a href="#function Object() { [native code] }-findByIdAndUpdate">findByIdAndUpdate</a></li><li class=""><a href="#function Object() { [native code] }-findOneAndRemove">findOneAndRemove</a></li><li class=""><a href="#function Object() { [native code] }-findByIdAndRemove">findByIdAndRemove</a></li><li class=""><a href="#function Object() { [native code] }-create">create</a></li><li class=""><a href="#function Object() { [native code] }-update">update</a></li><li class=""><a href="#function Object() { [native code] }-mapReduce">mapReduce</a></li><li class="private"><a href="#function Object() { [native code] }-compile">compile</a></li><li><a href="#Model-modelName">modelName</a></li><li><a href="#Model-collection">collection</a></li><li><a href="#Model-db">db</a></li></ul><a href="#lib/namedscope.js" class="section">lib/namedscope.js</a><ul><li class="private"><a href="#NamedScope-decorate">decorate</a></li></ul><a href="#lib/promise.js" class="section">lib/promise.js</a><ul><li class=""><a href="#function Object() { [native code] }-Promise">Promise</a></li><li class=""><a href="#Promise-__proto__">__proto__</a></li><li class=""><a href="#Promise-on">on</a></li><li class="private"><a href="#Promise-emit">emit</a></li><li class=""><a href="#Promise-complete">complete</a></li><li class=""><a href="#Promise-error">error</a></li><li class=""><a href="#Promise-addCallback">addCallback</a></li><li class=""><a href="#Promise-addErrback">addErrback</a></li><li class="private"><a href="#Promise-addBack">addBack</a></li><li class=""><a href="#Promise-resolve">resolve</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/query.js" class="section">lib/query.js</a><ul><li class="private"><a href="#function Object() { [native code] }-Query">Query</a></li><li class=""><a href="#Query-setOptions">setOptions</a></li><li class=""><a href="#Query-bind">bind</a></li><li class=""><a href="#Query-exec">exec</a></li><li class=""><a href="#Query-find">find</a></li><li class=""><a href="#Query-cast">cast</a></li><li class="private"><a href="#Query-_optionsForExec">_optionsForExec</a></li><li class="private"><a href="#Query-_applyPaths">_applyPaths</a></li><li class=""><a href="#Query-$where">$where</a></li><li class=""><a href="#Query-where">where</a></li><li class=""><a href="#Query-equals">equals</a></li><li class=""><a href="#Query-or">or</a></li><li class=""><a href="#Query-nor">nor</a></li><li class=""><a href="#Query-gt">gt</a></li><li class=""><a href="#Query-gte">gte</a></li><li class=""><a href="#Query-lt">lt</a></li><li class=""><a href="#Query-lte">lte</a></li><li class=""><a href="#Query-ne">ne</a></li><li class=""><a href="#Query-in">in</a></li><li class=""><a href="#Query-nin">nin</a></li><li class=""><a href="#Query-all">all</a></li><li class=""><a href="#Query-size">size</a></li><li class=""><a href="#Query-regex">regex</a></li><li class=""><a href="#Query-maxDistance">maxDistance</a></li><li class=""><a href="#Query-near">near</a></li><li class=""><a href="#Query-mod">mod</a></li><li class=""><a href="#Query-exists">exists</a></li><li class=""><a href="#Query-elemMatch">elemMatch</a></li><li class=""><a href="#Query-box">box</a></li><li class=""><a href="#Query-center">center</a></li><li class=""><a href="#Query-centerSphere">centerSphere</a></li><li class=""><a href="#Query-select">select</a></li><li class=""><a href="#Query-slice">slice</a></li><li class=""><a href="#Query-sort">sort</a></li><li class=""><a href="#Query-limit">limit</a></li><li class=""><a href="#Query-skip">skip</a></li><li class=""><a href="#Query-maxscan">maxscan</a></li><li class=""><a href="#Query-batchSize">batchSize</a></li><li class=""><a href="#Query-comment">comment</a></li><li class=""><a href="#Query-snapshot">snapshot</a></li><li class=""><a href="#Query-hint">hint</a></li><li class=""><a href="#Query-slaveOk">slaveOk</a></li><li class=""><a href="#Query-tailable">tailable</a></li><li class="private"><a href="#Query-execFind">execFind</a></li><li class=""><a href="#Query-findOne">findOne</a></li><li class=""><a href="#Query-count">count</a></li><li class=""><a href="#Query-distinct">distinct</a></li><li class=""><a href="#Query-update">update</a></li><li class="private"><a href="#Query-_castUpdate">_castUpdate</a></li><li class="private"><a href="#Query-_walkUpdatePath">_walkUpdatePath</a></li><li class="private"><a href="#Query-_castUpdateVal">_castUpdateVal</a></li><li class="private"><a href="#Query-_getSchema">_getSchema</a></li><li class=""><a href="#Query-remove">remove</a></li><li class=""><a href="#Query-findOneAndUpdate">findOneAndUpdate</a></li><li class=""><a href="#Query-findOneAndRemove">findOneAndRemove</a></li><li class="private"><a href="#Query-_findAndModify">_findAndModify</a></li><li class=""><a href="#Query-populate">populate</a></li><li class=""><a href="#Query-stream">stream</a></li><li class="private"><a href="#function Object() { [native code] }-castDoc">castDoc</a></li><li class="private"><a href="#function Object() { [native code] }-castQuery">castQuery</a></li><li><a href="#Query-within">within</a></li></ul><a href="#lib/querystream.js" class="section">lib/querystream.js</a><ul><li class=""><a href="#function Object() { [native code] }-QueryStream">QueryStream</a></li><li class="private"><a href="#QueryStream-__proto__">__proto__</a></li><li class="private"><a href="#QueryStream-_init">_init</a></li><li class="private"><a href="#QueryStream-_next">_next</a></li><li class="private"><a href="#QueryStream-__next">__next</a></li><li class="private"><a href="#QueryStream-_onNextObject">_onNextObject</a></li><li class=""><a href="#QueryStream-pause">pause</a></li><li class=""><a href="#QueryStream-resume">resume</a></li><li class=""><a href="#QueryStream-destroy">destroy</a></li><li><a href="#QueryStream-paused">paused</a></li><li><a href="#QueryStream-readable">readable</a></li></ul><a href="#lib/schema/array.js" class="section">lib/schema/array.js</a><ul><li class="private"><a href="#function Object() { [native code] }-SchemaArray">SchemaArray</a></li><li class=""><a href="#SchemaArray-__proto__">__proto__</a></li><li class="private"><a href="#SchemaArray-checkRequired">checkRequired</a></li><li class="private"><a href="#SchemaArray-applyGetters">applyGetters</a></li><li class="private"><a href="#SchemaArray-cast">cast</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema/boolean.js" class="section">lib/schema/boolean.js</a><ul><li class="private"><a href="#function Object() { [native code] }-SchemaBoolean">SchemaBoolean</a></li><li class=""><a href="#SchemaBoolean-__proto__">__proto__</a></li><li class="private"><a href="#SchemaBoolean-checkRequired">checkRequired</a></li><li class="private"><a href="#SchemaBoolean-cast">cast</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema/buffer.js" class="section">lib/schema/buffer.js</a><ul><li class="private"><a href="#function Object() { [native code] }-SchemaBuffer">SchemaBuffer</a></li><li class=""><a href="#SchemaBuffer-__proto__">__proto__</a></li><li class="private"><a href="#SchemaBuffer-checkRequired">checkRequired</a></li><li class="private"><a href="#SchemaBuffer-cast">cast</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema/date.js" class="section">lib/schema/date.js</a><ul><li class="private"><a href="#function Object() { [native code] }-SchemaDate">SchemaDate</a></li><li class=""><a href="#SchemaDate-__proto__">__proto__</a></li><li class="private"><a href="#SchemaDate-checkRequired">checkRequired</a></li><li class="private"><a href="#SchemaDate-cast">cast</a></li><li class="private"><a href="#function Object() { [native code] }-handleSingle">handleSingle</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema/documentarray.js" class="section">lib/schema/documentarray.js</a><ul><li class="private"><a href="#function Object() { [native code] }-DocumentArray">DocumentArray</a></li><li class=""><a href="#DocumentArray-__proto__">__proto__</a></li><li class="private"><a href="#DocumentArray-doValidate">doValidate</a></li><li class="private"><a href="#DocumentArray-cast">cast</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema/index.js" class="section">lib/schema/index.js</a><ul></ul><a href="#lib/schema/mixed.js" class="section">lib/schema/mixed.js</a><ul><li class="private"><a href="#function Object() { [native code] }-Mixed">Mixed</a></li><li class=""><a href="#Mixed-__proto__">__proto__</a></li><li class="private"><a href="#Mixed-checkRequired">checkRequired</a></li><li class="private"><a href="#Mixed-cast">cast</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema/number.js" class="section">lib/schema/number.js</a><ul><li class="private"><a href="#function Object() { [native code] }-SchemaNumber">SchemaNumber</a></li><li class=""><a href="#SchemaNumber-__proto__">__proto__</a></li><li class="private"><a href="#SchemaNumber-checkRequired">checkRequired</a></li><li class=""><a href="#SchemaNumber-min">min</a></li><li class=""><a href="#SchemaNumber-max">max</a></li><li class="private"><a href="#SchemaNumber-cast">cast</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema/objectid.js" class="section">lib/schema/objectid.js</a><ul><li class="private"><a href="#function Object() { [native code] }-ObjectId">ObjectId</a></li><li class=""><a href="#ObjectId-__proto__">__proto__</a></li><li class="private"><a href="#ObjectId-checkRequired">checkRequired</a></li><li class="private"><a href="#ObjectId-cast">cast</a></li><li class="private"><a href="#ObjectId-auto">auto</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema/string.js" class="section">lib/schema/string.js</a><ul><li class="private"><a href="#function Object() { [native code] }-SchemaString">SchemaString</a></li><li class=""><a href="#SchemaString-__proto__">__proto__</a></li><li class=""><a href="#SchemaString-enum">enum</a></li><li class=""><a href="#SchemaString-lowercase">lowercase</a></li><li class=""><a href="#SchemaString-uppercase">uppercase</a></li><li class=""><a href="#SchemaString-trim">trim</a></li><li class=""><a href="#SchemaString-match">match</a></li><li class="private"><a href="#SchemaString-checkRequired">checkRequired</a></li><li class="private"><a href="#SchemaString-cast">cast</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schema.js" class="section">lib/schema.js</a><ul><li class=""><a href="#function Object() { [native code] }-Schema">Schema</a></li><li class=""><a href="#Schema-__proto__">__proto__</a></li><li class=""><a href="#Schema-add">add</a></li><li class=""><a href="#function Object() { [native code] }-reserved">reserved</a></li><li class=""><a href="#Schema-path">path</a></li><li class=""><a href="#function Object() { [native code] }-interpretAsType">interpretAsType</a></li><li class=""><a href="#Schema-eachPath">eachPath</a></li><li class=""><a href="#Schema-requiredPaths">requiredPaths</a></li><li class=""><a href="#Schema-pathType">pathType</a></li><li class="private"><a href="#Schema-queue">queue</a></li><li class=""><a href="#Schema-pre">pre</a></li><li class=""><a href="#Schema-post">post</a></li><li class=""><a href="#Schema-plugin">plugin</a></li><li class=""><a href="#Schema-method">method</a></li><li class=""><a href="#Schema-static">static</a></li><li class=""><a href="#Schema-index">index</a></li><li class=""><a href="#Schema-set">set</a></li><li class=""><a href="#Schema-indexes">indexes</a></li><li class=""><a href="#function Object() { [native code] }-fixSubIndexPaths">fixSubIndexPaths</a></li><li class=""><a href="#Schema-virtual">virtual</a></li><li class=""><a href="#Schema-virtualpath">virtualpath</a></li><li class=""><a href="#function Object() { [native code] }-ObjectId">ObjectId</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/schemadefault.js" class="section">lib/schemadefault.js</a><ul></ul><a href="#lib/schematype.js" class="section">lib/schematype.js</a><ul><li class=""><a href="#function Object() { [native code] }-SchemaType">SchemaType</a></li><li class=""><a href="#SchemaType-default">default</a></li><li class=""><a href="#SchemaType-index">index</a></li><li class="private"><a href="#SchemaType-unique">unique</a></li><li class="private"><a href="#SchemaType-sparse">sparse</a></li><li class=""><a href="#SchemaType-set">set</a></li><li class=""><a href="#SchemaType-get">get</a></li><li class=""><a href="#SchemaType-validate">validate</a></li><li class=""><a href="#SchemaType-required">required</a></li><li class="private"><a href="#SchemaType-getDefault">getDefault</a></li><li class="private"><a href="#SchemaType-applySetters">applySetters</a></li><li class="private"><a href="#SchemaType-applyGetters">applyGetters</a></li><li class=""><a href="#SchemaType-select">select</a></li><li class="private"><a href="#SchemaType-doValidate">doValidate</a></li><li class=""><a href="#function Object() { [native code] }-_isRef">_isRef</a></li><li class="private"><a href="#function Object() { [native code] }-ValidatorError">ValidatorError</a></li><li class=""><a href="#ValidatorError-__proto__">__proto__</a></li><li class="private"><a href="#function Object() { [native code] }-CastError">CastError</a></li><li class=""><a href="#CastError-__proto__">__proto__</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/statemachine.js" class="section">lib/statemachine.js</a><ul><li class="private"><a href="#function Object() { [native code] }-StateMachine">StateMachine</a></li><li class=""><a href="#function Object() { [native code] }-ctor">ctor</a></li><li class="private"><a href="#StateMachine-_changeState">_changeState</a></li><li class=""><a href="#StateMachine-some">some</a></li><li class="private"><a href="#StateMachine-_iter">_iter</a></li><li class=""><a href="#StateMachine-forEach">forEach</a></li><li class=""><a href="#StateMachine-map">map</a></li></ul><a href="#lib/types/array.js" class="section">lib/types/array.js</a><ul><li class="private"><a href="#function Object() { [native code] }-MongooseArray">MongooseArray</a></li><li class=""><a href="#function Object() { [native code] }-prototype">prototype</a></li><li class="private"><a href="#MongooseArray-_cast">_cast</a></li><li class=""><a href="#MongooseArray-_markModified">_markModified</a></li><li class="private"><a href="#MongooseArray-_registerAtomic">_registerAtomic</a></li><li class=""><a href="#MongooseArray-hasAtomics">hasAtomics</a></li><li class=""><a href="#MongooseArray-push">push</a></li><li class=""><a href="#MongooseArray-nonAtomicPush">nonAtomicPush</a></li><li class=""><a href="#MongooseArray-pop">pop</a></li><li class=""><a href="#MongooseArray-shift">shift</a></li><li class=""><a href="#MongooseArray-remove">remove</a></li><li class=""><a href="#MongooseArray-pull">pull</a></li><li class=""><a href="#MongooseArray-splice">splice</a></li><li class=""><a href="#MongooseArray-unshift">unshift</a></li><li class=""><a href="#MongooseArray-sort">sort</a></li><li class=""><a href="#MongooseArray-addToSet">addToSet</a></li><li class=""><a href="#MongooseArray-toObject">toObject</a></li><li class=""><a href="#MongooseArray-inspect">inspect</a></li><li class=""><a href="#MongooseArray-indexOf">indexOf</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/types/buffer.js" class="section">lib/types/buffer.js</a><ul><li class="private"><a href="#function Object() { [native code] }-MongooseBuffer">MongooseBuffer</a></li><li class=""><a href="#function Object() { [native code] }-prototype">prototype</a></li><li class=""><a href="#MongooseBuffer-_markModified">_markModified</a></li><li class=""><a href="#MongooseBuffer-write">write</a></li><li class=""><a href="#MongooseBuffer-copy">copy</a></li><li class=""><a href="#MongooseBuffer-toObject">toObject</a></li><li class=""><a href="#function Object() { [native code] }-Binary">Binary</a></li></ul><a href="#lib/types/documentarray.js" class="section">lib/types/documentarray.js</a><ul><li class="private"><a href="#function Object() { [native code] }-MongooseDocumentArray">MongooseDocumentArray</a></li><li class=""><a href="#MongooseDocumentArray-__proto__">__proto__</a></li><li class="private"><a href="#MongooseDocumentArray-_cast">_cast</a></li><li class=""><a href="#MongooseDocumentArray-id">id</a></li><li class=""><a href="#MongooseDocumentArray-toObject">toObject</a></li><li class=""><a href="#MongooseDocumentArray-inspect">inspect</a></li><li class=""><a href="#MongooseDocumentArray-create">create</a></li><li class="private"><a href="#MongooseDocumentArray-notify">notify</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/types/embedded.js" class="section">lib/types/embedded.js</a><ul><li class="private"><a href="#function Object() { [native code] }-EmbeddedDocument">EmbeddedDocument</a></li><li class=""><a href="#EmbeddedDocument-__proto__">__proto__</a></li><li class=""><a href="#EmbeddedDocument-save">save</a></li><li class=""><a href="#EmbeddedDocument-remove">remove</a></li><li class=""><a href="#EmbeddedDocument-inspect">inspect</a></li><li class=""><a href="#EmbeddedDocument-invalidate">invalidate</a></li><li class=""><a href="#function Object() { [native code] }-exports">exports</a></li></ul><a href="#lib/types/index.js" class="section">lib/types/index.js</a><ul></ul><a href="#lib/types/objectid.js" class="section">lib/types/objectid.js</a><ul></ul><a href="#lib/utils.js" class="section">lib/utils.js</a><ul><li class="private"><a href="#function Object() { [native code] }-toCollectionName">toCollectionName</a></li><li class=""><a href="#function Object() { [native code] }-rules">rules</a></li><li class=""><a href="#function Object() { [native code] }-uncountables">uncountables</a></li><li class="private"><a href="#function Object() { [native code] }-pluralize">pluralize</a></li><li class="private"><a href="#function Object() { [native code] }-Events">Events</a></li><li class=""><a href="#Events-__proto__">__proto__</a></li><li class=""><a href="#Events-once">once</a></li><li class="private"><a href="#function Object() { [native code] }-clone">clone</a></li><li class="private"><a href="#function Object() { [native code] }-options">options</a></li><li class="private"><a href="#function Object() { [native code] }-random">random</a></li><li class=""><a href="#function Object() { [native code] }-merge">merge</a></li><li class=""><a href="#function Object() { [native code] }-args">args</a></li><li class="private"><a href="#function Object() { [native code] }-tick">tick</a></li><li class=""><a href="#function Object() { [native code] }-isMongooseObject">isMongooseObject</a></li></ul><a href="#lib/virtualtype.js" class="section">lib/virtualtype.js</a><ul><li class=""><a href="#function Object() { [native code] }-VirtualType">VirtualType</a></li><li class=""><a href="#VirtualType-get">get</a></li><li class=""><a href="#VirtualType-set">set</a></li><li class=""><a href="#VirtualType-applyGetters">applyGetters</a></li><li class=""><a href="#VirtualType-applySetters">applySetters</a></li></ul></div></div><div id="docs"><ul><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/collection.js">lib/collection.js</a><div class="method "><h3 id="Collection">Collection(<code>name</code>, <code>conn</code>, <code>opts</code>)</h3><p>Abstract Collection constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Collection</span> <span class="params">(name, conn, opts)</span> {</span>
  <span class="keyword">this</span>.name = name;
  <span class="keyword">this</span>.conn = conn;
  <span class="keyword">this</span>.buffer = <span class="literal">true</span>;
  <span class="keyword">this</span>.queue = [];

  <span class="keyword">if</span> (<span class="string">'number'</span> == <span class="keyword">typeof</span> opts) opts = { size: opts };
  <span class="keyword">this</span>.opts = opts || {};

  <span class="keyword">if</span> (STATES.connected == <span class="keyword">this</span>.conn.readyState) {
    <span class="keyword">this</span>.onOpen();
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of the collection</span></li><li><code>conn</code><span class="types"> &lt;<a href="#Connection">Connection</a>&gt; </span><span>A MongooseConnection instance</span></li><li><code>opts</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional collection options</span></li></ul></div><p>This is the base class that drivers inherit from<br />and implement.</p></div><hr class=""><div class="method private"><h3 id="Collection-onOpen">Collection#onOpen()</h3><p>Called when the database connects</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.onOpen = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">this</span>.buffer = <span class="literal">false</span>;
  self.doQueue();
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="Collection-onClose">Collection#onClose()</h3><p>Called when the database disconnects</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.onClose = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.buffer = <span class="literal">true</span>;
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="Collection-addQueue">Collection#addQueue(<code>name</code>, <code>args</code>)</h3><p>Queues a method for later execution when its<br />database connection opens.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.addQueue = <span class="function"><span class="keyword">function</span> <span class="params">(name, args)</span> {</span>
  <span class="keyword">this</span>.queue.push([name, args]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of the method to queue</span></li><li><code>args</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>arguments to pass to the method when executed</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Collection-doQueue">Collection#doQueue()</h3><p>Executes all queued methods and clears the queue.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.doQueue = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.queue.length; i &lt; l; i++){
    <span class="keyword">this</span>[<span class="keyword">this</span>.queue[i][<span class="number">0</span>]].apply(<span class="keyword">this</span>, <span class="keyword">this</span>.queue[i][<span class="number">1</span>]);
  }
  <span class="keyword">this</span>.queue = [];
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="Collection-ensureIndex">Collection#ensureIndex()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.ensureIndex = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#ensureIndex unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Collection-findAndModify">Collection#findAndModify()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.findAndModify = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#findAndModify unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Collection-findOne">Collection#findOne()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.findOne = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#findOne unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Collection-find">Collection#find()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.find = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#find unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Collection-insert">Collection#insert()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.insert = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#insert unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Collection-save">Collection#save()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.save = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#save unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Collection-update">Collection#update()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.update = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#update unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Collection-getIndexes">Collection#getIndexes()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.getIndexes = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#getIndexes unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Collection-mapReduce">Collection#mapReduce()</h3><p>Abstract method that drivers must implement.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.mapReduce = <span class="keyword">function</span>(){
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#mapReduce unimplemented by driver'</span>);
};</code></pre></div></div><hr class=""><div class="property "><h3 id="Collection-conn">Collection#<span>conn</span></h3><p>The Connection instance</p></div><hr><div class="property "><h3 id="Collection-name">Collection#<span>name</span></h3><p>The collection name</p></div><hr></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/connection.js">lib/connection.js</a><div class="method "><h3 id="Connection">Connection(<code>base</code>)</h3><p>Connection constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Connection</span> <span class="params">(base)</span> {</span>
  <span class="keyword">this</span>.base = base;
  <span class="keyword">this</span>.collections = {};
  <span class="keyword">this</span>.models = {};
  <span class="keyword">this</span>.replica = <span class="literal">false</span>;
  <span class="keyword">this</span>.host = <span class="literal">null</span>;
  <span class="keyword">this</span>.port = <span class="literal">null</span>;
  <span class="keyword">this</span>.user = <span class="literal">null</span>;
  <span class="keyword">this</span>.pass = <span class="literal">null</span>;
  <span class="keyword">this</span>.name = <span class="literal">null</span>;
  <span class="keyword">this</span>.options = <span class="literal">null</span>;
  <span class="keyword">this</span>._readyState = STATES.disconnected;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>base</code><span class="types"> &lt;<a href="#Mongoose">Mongoose</a>&gt; </span><span>a mongoose instance</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li>EventEmitter</li></ul></div><p>For practical reasons, a Connection equals a Db.</p></div><hr class=""><div class="method "><h3 id="Connection-open">Connection#open(<code>connection_string</code>, <code>[database]</code>, <code>[port]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Opens the connection to MongoDB.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.open = <span class="function"><span class="keyword">function</span> <span class="params">(host, database, port, options, callback)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>
    , uri;

  <span class="keyword">if</span> (<span class="string">'string'</span> === <span class="keyword">typeof</span> database) {
    <span class="keyword">switch</span> (arguments.length) {
      <span class="keyword">case</span> <span class="number">2</span>:
        port = <span class="number">27017</span>;
      <span class="keyword">case</span> <span class="number">3</span>:
        <span class="keyword">switch</span> (<span class="keyword">typeof</span> port) {
          <span class="keyword">case</span> <span class="string">'function'</span>:
            callback = port, port = <span class="number">27017</span>;
            <span class="keyword">break</span>;
          <span class="keyword">case</span> <span class="string">'object'</span>:
            options = port, port = <span class="number">27017</span>;
            <span class="keyword">break</span>;
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="number">4</span>:
        <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> options)
          callback = options, options = {};
    }
  } <span class="keyword">else</span> {
    <span class="keyword">switch</span> (<span class="keyword">typeof</span> database) {
      <span class="keyword">case</span> <span class="string">'function'</span>:
        callback = database, database = <span class="literal">undefined</span>;
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'object'</span>:
        options = database;
        database = <span class="literal">undefined</span>;
        callback = port;
        <span class="keyword">break</span>;
    }

    <span class="keyword">if</span> (!rgxProtocol.test(host)) {
      host = <span class="string">'mongodb://'</span> + host;
    }

    uri = url.parse(host);
    host = uri.hostname;
    port = uri.port || <span class="number">27017</span>;
    database = uri.pathname &amp;&amp; uri.pathname.replace(<span class="regexp">/\//g</span>, <span class="string">''</span>);
  }

  <span class="keyword">this</span>.options = <span class="keyword">this</span>.defaultOptions(options);

  <span class="comment">// make sure we can open</span>
  <span class="keyword">if</span> (STATES.disconnected !== <span class="keyword">this</span>.readyState) {
    <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">'Trying to open unclosed connection.'</span>);
    err.state = <span class="keyword">this</span>.readyState;
    <span class="keyword">this</span>.error(err, callback);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">if</span> (!host) {
    <span class="keyword">this</span>.error(<span class="keyword">new</span> Error(<span class="string">'Missing connection hostname.'</span>), callback);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">if</span> (!database) {
    <span class="keyword">this</span>.error(<span class="keyword">new</span> Error(<span class="string">'Missing connection database.'</span>), callback);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="comment">// handle authentication</span>
  <span class="keyword">if</span> (uri &amp;&amp; uri.auth) {
    <span class="keyword">var</span> auth = uri.auth.split(<span class="string">':'</span>);
    <span class="keyword">this</span>.user = auth[<span class="number">0</span>];
    <span class="keyword">this</span>.pass = auth[<span class="number">1</span>];

  <span class="comment">// Check hostname for user/pass</span>
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/@/</span>.test(host) &amp;&amp; <span class="regexp">/:/</span>.test(host.split(<span class="string">'@'</span>)[<span class="number">0</span>])) {
    host = host.split(<span class="string">'@'</span>);
    <span class="keyword">var</span> auth = host.shift().split(<span class="string">':'</span>);
    host = host.pop();
    <span class="keyword">this</span>.user = auth[<span class="number">0</span>];
    <span class="keyword">this</span>.pass = auth[<span class="number">1</span>];

  <span class="comment">// user/pass options</span>
  } <span class="keyword">else</span> <span class="keyword">if</span> (options &amp;&amp; options.user &amp;&amp; options.pass) {
    <span class="keyword">this</span>.user = options.user;
    <span class="keyword">this</span>.pass = options.pass;

  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.user = <span class="keyword">this</span>.pass = <span class="literal">undefined</span>;
  }

  <span class="keyword">this</span>.name = database;
  <span class="keyword">this</span>.host = host;
  <span class="keyword">this</span>.port = port;

  <span class="keyword">this</span>._open(callback);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>connection_string</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>mongodb://uri or the host to which you are connecting</span></li><li><code>[database]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>database name</span></li><li><code>[port]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>database port</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/mongodb/node-mongodb-native" title="node-mongodb-native">node-mongodb-native</a></li></ul></div><p><code>options</code> is a hash with the following possible properties:</p>

<pre><code>db      - passed to the connection db instance
server  - passed to the connection server instance(s)
replset - passed to the connection ReplSetServer instance
user    - username <span class="keyword">for</span> authentication
pass    - password <span class="keyword">for</span> authentication</code></pre>

<h4>Notes:</h4>

<p>Mongoose forces the db option <code>forceServerObjectId</code> false and cannot be overridden.<br />Mongoose defaults the server <code>auto_reconnect</code> options to true which can be overridden.<br />See the node-mongodb-native driver instance for options that it understands.</p></div><hr class=""><div class="method "><h3 id="Connection-openSet">Connection#openSet(<code>uris</code>, <code>[database]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Connects to a replica set.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.openSet = <span class="function"><span class="keyword">function</span> <span class="params">(uris, database, options, callback)</span> {</span>
  <span class="keyword">var</span> uris = uris.split(<span class="string">','</span>)
    , self = <span class="keyword">this</span>;

  <span class="keyword">switch</span> (arguments.length) {
    <span class="keyword">case</span> <span class="number">3</span>:
      <span class="keyword">this</span>.name = database;
      <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> options) callback = options, options = {};
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="number">2</span>:
      <span class="keyword">switch</span> (<span class="keyword">typeof</span> database) {
        <span class="keyword">case</span> <span class="string">'string'</span>:
          <span class="keyword">this</span>.name = database;
        <span class="keyword">case</span> <span class="string">'function'</span>:
          callback = database, database = <span class="literal">null</span>;
          <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="string">'object'</span>:
          options = database, database = <span class="literal">null</span>;
          <span class="keyword">break</span>;
      }
  }

  <span class="keyword">this</span>.options = options = <span class="keyword">this</span>.defaultOptions(options);

  <span class="keyword">if</span> (uris.length &lt; <span class="number">2</span>) {
    <span class="keyword">this</span>.error(<span class="keyword">new</span> Error(<span class="string">'Please provide comma-separated URIs'</span>), callback);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">this</span>.replica = <span class="literal">true</span>;
  <span class="keyword">this</span>.host = [];
  <span class="keyword">this</span>.port = [];

  uris.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(uri)</span> {</span>
    <span class="comment">// handle missing protocols</span>
    <span class="keyword">if</span> (!rgxProtocol.test(uri))
      uri = <span class="string">'mongodb://'</span> + uri;

    <span class="keyword">var</span> uri = url.parse(uri);

    self.host.push(uri.hostname);
    self.port.push(uri.port || <span class="number">27017</span>);

    <span class="keyword">if</span> (!self.name &amp;&amp; uri.pathname &amp;&amp; uri.pathname.replace(<span class="regexp">/\//g</span>, <span class="string">''</span>))
      self.name = uri.pathname.replace(<span class="regexp">/\//g</span>, <span class="string">''</span>);

    <span class="keyword">if</span> (!self.user &amp;&amp; uri.auth) {
      <span class="keyword">var</span> auth = uri.auth.split(<span class="string">':'</span>);
      self.user = auth[<span class="number">0</span>];
      self.pass = auth[<span class="number">1</span>];
    }
  });

  <span class="keyword">if</span> (!<span class="keyword">this</span>.name) {
    <span class="keyword">this</span>.error(<span class="keyword">new</span> Error(<span class="string">'No database name provided for replica set'</span>), callback);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">this</span>._open(callback);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>uris</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>comma-separated mongodb:// URIs</span></li><li><code>[database]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional database name</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>optional</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/mongodb/node-mongodb-native" title="node-mongodb-native">node-mongodb-native</a></li></ul></div><p>Supply a comma-separted list of mongodb:// URIs. You only need to specify<br />the database name and/or auth to one of them.</p>

<p>The options parameter is passed to the low level connection. See the<br />node-mongodb-native driver instance for detail.</p></div><hr class=""><div class="method private"><h3 id="Connection-error">Connection#error(<code>err</code>, <code>callback</code>)</h3><p>error</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.error = <span class="function"><span class="keyword">function</span> <span class="params">(err, callback)</span> {</span>
  <span class="keyword">if</span> (callback) <span class="keyword">return</span> callback(err);
  <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>optional</span></li></ul></div><p>Graceful error handling, passes error to callback<br />if available, else emits error on the connection.</p></div><hr class="private"><div class="method private"><h3 id="Connection-_open">Connection#_open(<code>callback</code>)</h3><p>_open</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype._open = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  <span class="keyword">this</span>.readyState = STATES.connecting;

  <span class="keyword">var</span> self = <span class="keyword">this</span>;

  <span class="keyword">var</span> method = <span class="keyword">this</span>.replica
    ? <span class="string">'doOpenSet'</span>
    : <span class="string">'doOpen'</span>;

  <span class="comment">// open connection</span>
  <span class="keyword">this</span>[method](<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
    <span class="keyword">if</span> (err) {
      self.readyState = STATES.disconnected;
      self.error(err, callback);
      <span class="keyword">return</span>;
    }

    self.onOpen();
    callback &amp;&amp; callback();
  });
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><p>Handles opening the connection with the appropriate<br />method based on connection type.</p></div><hr class="private"><div class="method private"><h3 id="Connection-onOpen">Connection#onOpen()</h3><p>Called when the connection is opened</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.onOpen = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">open</span> <span class="params">()</span> {</span>
    self.readyState = STATES.connected;

    <span class="comment">// avoid having the collection subscribe to our event emitter</span>
    <span class="comment">// to prevent 0.3 warning</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> self.collections)
      self.collections[i].onOpen();

    self.emit(<span class="string">'open'</span>);
  };

  <span class="comment">// re-authenticate</span>
  <span class="keyword">if</span> (self.user &amp;&amp; self.pass)
    self.db.authenticate(self.user, self.pass, open);
  <span class="keyword">else</span>
    open();
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="Connection-close">Connection#close(<code>[callback]</code>)</h3><p>Closes the connection</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.close = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;

  <span class="keyword">switch</span> (<span class="keyword">this</span>.readyState){
    <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// disconnected</span>
      callback &amp;&amp; callback();
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// connected</span>
      <span class="keyword">this</span>.readyState = STATES.disconnecting;
      <span class="keyword">this</span>.doClose(<span class="keyword">function</span>(err){
        <span class="keyword">if</span> (err){
          self.error(err, callback);
        } <span class="keyword">else</span> {
          self.onClose();
          callback &amp;&amp; callback();
        }
      });
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// connecting</span>
      <span class="keyword">this</span>.once(<span class="string">'open'</span>, <span class="keyword">function</span>(){
        self.close(callback);
      });
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">// disconnecting</span>
      <span class="keyword">if</span> (!callback) <span class="keyword">break</span>;
      <span class="keyword">this</span>.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        callback();
      });
      <span class="keyword">break</span>;
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>optional</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Connection">Connection</a>&gt; </span><span>self</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="Connection-onClose">Connection#onClose()</h3><p>Called when the connection closes</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.onClose = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.readyState = STATES.disconnected;

  <span class="comment">// avoid having the collection subscribe to our event emitter</span>
  <span class="comment">// to prevent 0.3 warning</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> <span class="keyword">this</span>.collections)
    <span class="keyword">this</span>.collections[i].onClose();

  <span class="keyword">this</span>.emit(<span class="string">'close'</span>);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="Connection-collection">Connection#collection(<code>name</code>, <code>[options]</code>)</h3><p>Retrieves a collection, creating it if not cached.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.collection = <span class="function"><span class="keyword">function</span> <span class="params">(name, options)</span> {</span>
  <span class="keyword">if</span> (!(name <span class="keyword">in</span> <span class="keyword">this</span>.collections))
    <span class="keyword">this</span>.collections[name] = <span class="keyword">new</span> Collection(name, <span class="keyword">this</span>, options);
  <span class="keyword">return</span> <span class="keyword">this</span>.collections[name];
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>of the collection</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional collection options</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Collection">Collection</a>&gt; </span><span>collection instance</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Connection-model">Connection#model(<code>name</code>, <code>schema</code>, <code>[collection]</code>)</h3><p>Defines a model or retrieves it</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.model = <span class="function"><span class="keyword">function</span> <span class="params">(name, schema, collection)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.models[name]) {
    <span class="keyword">var</span> model = <span class="keyword">this</span>.base.model(name, schema, collection, <span class="literal">true</span>)
      , Model

    <span class="keyword">if</span> (<span class="keyword">this</span> != model.prototype.db) {
      <span class="comment">// subclass model using this connection and collection name</span>
      Model = <span class="function"><span class="keyword">function</span> <span class="title">Model</span> <span class="params">(doc, fields, skipId)</span> {</span>
        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Model))
          <span class="keyword">return</span> <span class="keyword">new</span> Model(doc, fields, skipId);
        model.call(<span class="keyword">this</span>, doc, fields, skipId);
      };

      Model.__proto__ = model;
      Model.prototype.__proto__ = model.prototype;
      Model.db = Model.prototype.db = <span class="keyword">this</span>;

      <span class="comment">// collection name discovery</span>
      <span class="keyword">if</span> (<span class="string">'string'</span> === <span class="keyword">typeof</span> schema) {
        collection = schema;
      }

      <span class="keyword">if</span> (!collection) {
        collection = model.prototype.schema.set(<span class="string">'collection'</span>) || utils.toCollectionName(name);
      }

      <span class="keyword">var</span> s = <span class="string">'string'</span> != <span class="keyword">typeof</span> schema
        ? schema
        : model.prototype.schema;

      Model.prototype.collection = <span class="keyword">this</span>.collection(collection, s &amp;&amp; s.options.capped);
      Model.collection = Model.prototype.collection;
      Model.init();
    }

    <span class="keyword">this</span>.models[name] = Model || model;
  }

  <span class="keyword">return</span> <span class="keyword">this</span>.models[name];
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the model name</span></li><li><code>schema</code><span class="types"> &lt;<a href="#Schema">Schema</a>&gt; </span><span>a schema</span></li><li><code>[collection]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of mongodb collection (optional) if not given it will be induced from model name</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Connection-setProfiling">Connection#setProfiling(<code>level</code>, <code>[ms]</code>, <code>callback</code>)</h3><p>Set profiling level.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.setProfiling = <span class="function"><span class="keyword">function</span> <span class="params">(level, ms, callback)</span> {</span>
  <span class="keyword">if</span> (STATES.connected !== <span class="keyword">this</span>.readyState) {
    <span class="keyword">return</span> <span class="keyword">this</span>.on(<span class="string">'open'</span>, <span class="keyword">this</span>.setProfiling.bind(<span class="keyword">this</span>, level, ms, callback));
  }

  <span class="keyword">if</span> (!callback) callback = ms, ms = <span class="number">100</span>;

  <span class="keyword">var</span> cmd = {};

  <span class="keyword">switch</span> (level) {
    <span class="keyword">case</span> <span class="number">0</span>:
    <span class="keyword">case</span> <span class="string">'off'</span>:
      cmd.profile = <span class="number">0</span>;
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="number">1</span>:
    <span class="keyword">case</span> <span class="string">'slow'</span>:
      cmd.profile = <span class="number">1</span>;
      <span class="keyword">if</span> (<span class="string">'number'</span> !== <span class="keyword">typeof</span> ms) {
        ms = parseInt(ms, <span class="number">10</span>);
        <span class="keyword">if</span> (isNaN(ms)) ms = <span class="number">100</span>;
      }
      cmd.slowms = ms;
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="number">2</span>:
    <span class="keyword">case</span> <span class="string">'all'</span>:
      cmd.profile = <span class="number">2</span>;
      <span class="keyword">break</span>;
    <span class="keyword">default</span>:
      <span class="keyword">return</span> callback(<span class="keyword">new</span> Error(<span class="string">'Invalid profiling level: '</span>+ level));
  }

  <span class="keyword">this</span>.db.executeDbCommand(cmd, <span class="function"><span class="keyword">function</span> <span class="params">(err, resp)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);

    <span class="keyword">var</span> doc = resp.documents[<span class="number">0</span>];

    err = <span class="number">1</span> === doc.ok
      ? <span class="literal">null</span>
      : <span class="keyword">new</span> Error(<span class="string">'Could not set profiling level to: '</span>+ level)

    callback(err, doc);
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>level</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>either off (0), slow (1), or all (2)</span></li><li><code>[ms]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>the threshold in milliseconds above which queries will be logged when in `slow` mode. defaults to 100.</span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method private"><h3 id="Connection-defaultOptions">Connection#defaultOptions(<code>options</code>)</h3><p>Prepares default connection options.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.defaultOptions = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>
  <span class="keyword">var</span> o = options || {};

  o.server = o.server || {};

  <span class="keyword">if</span> (!(<span class="string">'auto_reconnect'</span> <span class="keyword">in</span> o.server)) {
    o.server.auto_reconnect = <span class="literal">true</span>;
  }

  o.db = o.db || {};
  o.db.forceServerObjectId = <span class="literal">false</span>;

  <span class="keyword">return</span> o;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="property "><h3 id="Connection-db">Connection#<span>db</span></h3><p>The mongodb.Db instance, set when the connection is opened</p></div><hr><div class="property "><h3 id="Connection-collections">Connection#<span>collections</span></h3><p>A hash of the collections associated with this connection</p></div><hr><div class="property "><h3 id="Connection-readyState">Connection#<span>readyState</span></h3><p>Connection ready state</p>

<ul>
<li>0 = Disconnected</li>
<li>1 = Connected</li>
<li>2 = Connecting</li>
<li>3 = Disconnecting</li>
</ul>

<p>Each state change emits its associated event name.</p></div><hr></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/connectionstate.js">lib/connectionstate.js</a></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/document.js">lib/document.js</a><div class="method private"><h3 id="Document">Document(<code>obj</code>, <code>fields</code>, <code>skipId</code>)</h3><p>Document constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Document</span> <span class="params">(obj, fields, skipId)</span> {</span>
  <span class="comment">// node &lt;0.4.3 bug</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>._events) <span class="keyword">this</span>._events = {};
  <span class="keyword">this</span>.setMaxListeners(<span class="number">0</span>);

  <span class="keyword">if</span> (<span class="string">'boolean'</span> === <span class="keyword">typeof</span> fields) {
    <span class="keyword">this</span>._strictMode = fields;
    <span class="keyword">this</span>._selected = fields = <span class="literal">undefined</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>._strictMode = <span class="keyword">this</span>.schema.options &amp;&amp; <span class="keyword">this</span>.schema.options.strict;
    <span class="keyword">this</span>._selected = fields;
  }

  <span class="keyword">this</span>.isNew = <span class="literal">true</span>;
  <span class="keyword">this</span>.errors = <span class="literal">undefined</span>;
  <span class="keyword">this</span>._shardval = <span class="literal">undefined</span>;
  <span class="keyword">this</span>._saveError = <span class="literal">undefined</span>;
  <span class="keyword">this</span>._validationError = <span class="literal">undefined</span>;
  <span class="keyword">this</span>._adhocPaths = <span class="literal">undefined</span>;
  <span class="keyword">this</span>._removing = <span class="literal">undefined</span>;
  <span class="keyword">this</span>._inserting = <span class="literal">undefined</span>;
  <span class="keyword">this</span>.__version = <span class="literal">undefined</span>;
  <span class="keyword">this</span>.__getters = {};
  <span class="keyword">this</span>.__id = <span class="literal">undefined</span>;

  <span class="keyword">this</span>._activePaths = <span class="keyword">new</span> ActiveRoster;

  <span class="keyword">var</span> required = <span class="keyword">this</span>.schema.requiredPaths();
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; required.length; ++i) {
    <span class="keyword">this</span>._activePaths.require(required[i]);
  }

  <span class="keyword">this</span>._doc = <span class="keyword">this</span>._buildDoc(obj, fields, skipId);
  <span class="keyword">if</span> (obj) <span class="keyword">this</span>.set(obj, <span class="literal">undefined</span>, <span class="literal">true</span>);
  <span class="keyword">this</span>._registerHooks();
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>- values to set</span></li><li><code>fields</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>- which were selected in the query returning this document</span></li><li><code>skipId</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>- flag if we should auto create an ObjectId _id</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li>EventEmitter</li></ul></div></div><hr class="private"><div class="method private"><h3 id="Document-_buildDoc">Document#_buildDoc()</h3><p>Builds the default doc structure</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._buildDoc = <span class="function"><span class="keyword">function</span> <span class="params">(obj, fields, skipId)</span> {</span>
  <span class="keyword">var</span> doc = {}
    , self = <span class="keyword">this</span>
    , exclude
    , keys
    , key
    , ki

  <span class="comment">// determine if this doc is a result of a query with</span>
  <span class="comment">// excluded fields</span>
  <span class="keyword">if</span> (fields &amp;&amp; <span class="string">'Object'</span> === fields.constructor.name) {
    keys = Object.keys(fields);
    ki = keys.length;

    <span class="keyword">while</span> (ki--) {
      <span class="keyword">if</span> (<span class="string">'_id'</span> !== keys[ki]) {
        exclude = <span class="number">0</span> === fields[keys[ki]];
        <span class="keyword">break</span>;
      }
    }
  }

  <span class="keyword">var</span> paths = Object.keys(<span class="keyword">this</span>.schema.paths)
    , plen = paths.length
    , ii = <span class="number">0</span>

  <span class="keyword">for</span> (; ii &lt; plen; ++ii) {
    <span class="keyword">var</span> p = paths[ii];

    <span class="keyword">if</span> (<span class="string">'_id'</span> == p) {
      <span class="keyword">if</span> (skipId) <span class="keyword">continue</span>;
      <span class="keyword">if</span> (obj &amp;&amp; <span class="string">'_id'</span> <span class="keyword">in</span> obj) <span class="keyword">continue</span>;
    }

    <span class="keyword">var</span> type = <span class="keyword">this</span>.schema.paths[p]
      , path = p.split(<span class="string">'.'</span>)
      , len = path.length
      , last = len-<span class="number">1</span>
      , doc_ = doc
      , i = <span class="number">0</span>

    <span class="keyword">for</span> (; i &lt; len; ++i) {
      <span class="keyword">var</span> piece = path[i]
        , def

      <span class="keyword">if</span> (i === last) {
        <span class="keyword">if</span> (fields) {
          <span class="keyword">if</span> (exclude) {
            <span class="comment">// apply defaults to all non-excluded fields</span>
            <span class="keyword">if</span> (p <span class="keyword">in</span> fields) <span class="keyword">continue</span>;

            def = type.getDefault(self, <span class="literal">true</span>);
            <span class="keyword">if</span> (<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> def) {
              doc_[piece] = def;
              self._activePaths.<span class="keyword">default</span>(p);
            }

          } <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">in</span> fields) {
            <span class="comment">// selected field</span>
            def = type.getDefault(self, <span class="literal">true</span>);
            <span class="keyword">if</span> (<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> def) {
              doc_[piece] = def;
              self._activePaths.<span class="keyword">default</span>(p);
            }
          }
        } <span class="keyword">else</span> {
          def = type.getDefault(self, <span class="literal">true</span>);
          <span class="keyword">if</span> (<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> def) {
            doc_[piece] = def;
            self._activePaths.<span class="keyword">default</span>(p);
          }
        }
      } <span class="keyword">else</span> {
        doc_ = doc_[piece] || (doc_[piece] = {});
      }
    }
  };

  <span class="keyword">return</span> doc;
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="Document-init">Document#init(<code>doc</code>, <code>fn</code>)</h3><p>Initializes the document without setters or<br />marking modified. Called internally after a<br />document is returned from mongodb.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.init = <span class="function"><span class="keyword">function</span> <span class="params">(doc, fn)</span> {</span>
  <span class="keyword">this</span>.isNew = <span class="literal">false</span>;

  init(<span class="keyword">this</span>, doc, <span class="keyword">this</span>._doc);
  <span class="keyword">this</span>._storeShard();

  <span class="keyword">this</span>.emit(<span class="string">'init'</span>);
  <span class="keyword">if</span> (fn) fn(<span class="literal">null</span>);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>document returned by mongo</span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>callback</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="init">init(<code>self</code>, <code>obj</code>, <code>doc</code>)</h3><p>Init helper.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(self, obj, doc, prefix)</span> {</span>
  prefix = prefix || <span class="string">''</span>;

  <span class="keyword">var</span> keys = Object.keys(obj)
    , len = keys.length
    , schema
    , path
    , i;

  <span class="keyword">while</span> (len--) {
    i = keys[len];
    path = prefix + i;
    schema = self.schema.path(path);

    <span class="keyword">if</span> (!schema &amp;&amp; obj[i] &amp;&amp; <span class="string">'Object'</span> === obj[i].constructor.name) {
      <span class="comment">// assume nested object</span>
      <span class="keyword">if</span> (!doc[i]) {
        doc[i] = {};
      }
      init(self, obj[i], doc[i], path + <span class="string">'.'</span>);
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (obj[i] === <span class="literal">null</span>) {
        doc[i] = <span class="literal">null</span>;
      } <span class="keyword">else</span> <span class="keyword">if</span> (obj[i] !== <span class="literal">undefined</span>) {
        <span class="keyword">if</span> (schema) {
          self.<span class="keyword">try</span>(<span class="keyword">function</span>(){
            doc[i] = schema.cast(obj[i], self, <span class="literal">true</span>);
          });
        } <span class="keyword">else</span> {
          doc[i] = obj[i];
        }
      }
      <span class="comment">// mark as hydrated</span>
      self._activePaths.init(path);
    }
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>self</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>document instance</span></li><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>raw mongodb doc</span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>object we are initializing</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Document-_storeShard">Document#_storeShard()</h3><p>Stores the current values of the shard keys<br />for use later in the doc.save() where clause.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._storeShard = <span class="function"><span class="keyword">function</span> <span class="title">_storeShard</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> key = <span class="keyword">this</span>.schema.options.shardkey;
  <span class="keyword">if</span> (!(key &amp;&amp; <span class="string">'Object'</span> == key.constructor.name)) <span class="keyword">return</span>;

  <span class="keyword">var</span> orig = <span class="keyword">this</span>._shardval = {}
    , paths = Object.keys(key)
    , len = paths.length
    , val

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) {
    val = <span class="keyword">this</span>.getValue(paths[i]);
    <span class="keyword">if</span> (isMongooseObject(val)) {
      orig[paths[i]] = val.toObject({ depopulate: <span class="literal">true</span> })
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> != val &amp;&amp; val.valueOf) {
      orig[paths[i]] = val.valueOf();
    } <span class="keyword">else</span> {
      orig[paths[i]] = val;
    }
  }
}</code></pre></div><p>Shard key values do not / are not allowed to change.</p></div><hr class="private"><div class="method "><h3 id="Document-update">Document#update(<code>doc</code>, <code>options</code>, <code>callback</code>)</h3><p>Sends an update command with this document _id as<br />the query selector.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.update = <span class="function"><span class="keyword">function</span> <span class="title">update</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> args = utils.args(arguments);
  args.unshift({_id: <span class="keyword">this</span>._id});
  <span class="keyword">this</span>.constructor.update.apply(<span class="keyword">this</span>.constructor, args);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><h4>Example:</h4>

<pre><code>weirdCar.update({$inc: {wheels:<span class="number">1</span>}, fn);</code></pre>

<h4>Valid options:</h4>

<ul>
<li>safe (boolean) safe mode (defaults to value set in schema (true))</li>
<li>upsert (boolean) whether to create the doc if it doesn't match (false)</li>
</ul></div><hr class=""><div class="method "><h3 id="Document-set">Document#set(<code>path</code>, <code>val</code>, <code>[type]</code>)</h3><p>Sets the value of a path, or many paths.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.set = <span class="function"><span class="keyword">function</span> <span class="params">(path, val, type)</span> {</span>
  <span class="keyword">var</span> constructing = <span class="literal">true</span> === type
    , adhoc = type &amp;&amp; <span class="literal">true</span> !== type
    , adhocs

  <span class="keyword">if</span> (adhoc) {
    adhocs = <span class="keyword">this</span>._adhocPaths || (<span class="keyword">this</span>._adhocPaths = {});
    adhocs[path] = Schema.interpretAsType(path, type);
  }

  <span class="keyword">if</span> (<span class="string">'string'</span> !== <span class="keyword">typeof</span> path) {
    <span class="comment">// new Document({ key: val })</span>

    <span class="keyword">if</span> (<span class="literal">null</span> === path || <span class="literal">undefined</span> === path) {
      <span class="keyword">var</span> _ = path;
      path = val;
      val = _;

    } <span class="keyword">else</span> {
      <span class="keyword">var</span> prefix = val
        ? val + <span class="string">'.'</span>
        : <span class="string">''</span>;

      <span class="keyword">if</span> (path <span class="keyword">instanceof</span> Document) path = path._doc;

      <span class="keyword">var</span> keys = Object.keys(path)
        , i = keys.length
        , pathtype
        , key

      <span class="keyword">while</span> (i--) {
        key = keys[i];
        <span class="keyword">if</span> (<span class="literal">null</span> != path[key] &amp;&amp; <span class="string">'Object'</span> === path[key].constructor.name
          &amp;&amp; !(<span class="keyword">this</span>._path(prefix + key) <span class="keyword">instanceof</span> MixedSchema)) {
          <span class="keyword">this</span>.set(path[key], prefix + key, constructing);
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>._strictMode) {
          pathtype = <span class="keyword">this</span>.schema.pathType(prefix + key);
          <span class="keyword">if</span> (<span class="string">'real'</span> === pathtype || <span class="string">'virtual'</span> === pathtype) {
            <span class="keyword">this</span>.set(prefix + key, path[key], constructing);
          } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'throw'</span> == <span class="keyword">this</span>._strictMode) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Field `"</span> + key + <span class="string">"` is not in schema."</span>);
          }
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">undefined</span> !== path[key]) {
          <span class="keyword">this</span>.set(prefix + key, path[key], constructing);
        }
      }

      <span class="keyword">return</span> <span class="keyword">this</span>;
    }
  }

  <span class="comment">// ensure _strict is honored for obj props</span>
  <span class="comment">// docschema = new Schema({ path: { nest: 'string' }})</span>
  <span class="comment">// doc.set('path', obj);</span>
  <span class="keyword">var</span> pathType = <span class="keyword">this</span>.schema.pathType(path);
  <span class="keyword">if</span> (<span class="string">'nested'</span> == pathType &amp;&amp; val &amp;&amp; <span class="string">'Object'</span> == val.constructor.name) {
    <span class="keyword">this</span>.set(val, path, constructing);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> schema;
  <span class="keyword">if</span> (<span class="string">'adhocOrUndefined'</span> == pathType &amp;&amp; <span class="keyword">this</span>._strictMode) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'virtual'</span> == pathType) {
    schema = <span class="keyword">this</span>.schema.virtualpath(path);
    schema.applySetters(val, <span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  } <span class="keyword">else</span> {
    schema = <span class="keyword">this</span>._path(path);
  }

  <span class="keyword">var</span> parts = path.split(<span class="string">'.'</span>)
    , pathToMark

  <span class="comment">// When using the $set operator the path to the field must already exist.</span>
  <span class="comment">// Else mongodb throws: "LEFT_SUBFIELD only supports Object"</span>

  <span class="keyword">if</span> (parts.length &lt;= <span class="number">1</span>) {
    pathToMark = path;
  } <span class="keyword">else</span> {
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; parts.length; ++i) {
      <span class="keyword">var</span> part = parts[i];
      <span class="keyword">var</span> subpath = parts.slice(<span class="number">0</span>, i).concat(part).join(<span class="string">'.'</span>);
      <span class="keyword">if</span> (<span class="keyword">this</span>.isDirectModified(subpath) <span class="comment">// earlier prefixes that are already</span>
                                         <span class="comment">// marked as dirty have precedence</span>
          || <span class="keyword">this</span>.get(subpath) === <span class="literal">null</span>) {
        pathToMark = subpath;
        <span class="keyword">break</span>;
      }
    }

    <span class="keyword">if</span> (!pathToMark) pathToMark = path;
  }

  <span class="keyword">if</span> (!schema || <span class="literal">null</span> === val || <span class="literal">undefined</span> === val) {
    <span class="keyword">this</span>._set(pathToMark, path, constructing, parts, schema, val);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> self = <span class="keyword">this</span>;

  <span class="comment">// if this doc is being constructed we should not</span>
  <span class="comment">// trigger getters.</span>
  <span class="keyword">var</span> priorVal = constructing
    ? <span class="literal">undefined</span>
    : <span class="keyword">this</span>.get(path);

  <span class="keyword">var</span> shouldSet = <span class="keyword">this</span>.<span class="keyword">try</span>(<span class="keyword">function</span>(){
    <span class="keyword">var</span> casted = schema.cast(val, self, <span class="literal">false</span>, priorVal);
    val = schema.applySetters(casted, self);
  });

  <span class="keyword">if</span> (shouldSet) {
    <span class="keyword">this</span>._set(pathToMark, path, constructing, parts, schema, val, priorVal);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>path or object of key/vals to set</span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the value to set</span></li><li><code>[type]</code><span class="types"> &lt;<a href="#Schema">Schema</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="#Buffer">Buffer</a>, <a href="#etc..">etc..</a>&gt; </span><span>optionally specify a type for &quot;on-the-fly&quot; attributes</span></li></ul></div><h4>Example:</h4>

<pre><code><span class="comment">// path, value</span>
doc.set(path, value)

<span class="comment">// object</span>
doc.set({
    path  : value
  , path2 : {
       path  : value
    }
})

<span class="comment">// only-the-fly cast to number</span>
doc.set(path, value, Number)

<span class="comment">// only-the-fly cast to string</span>
doc.set(path, value, String)</code></pre></div><hr class=""><div class="method private"><h3 id="Document-_set">Document#_set()</h3><p>Handles the actual setting of the value and marking<br />the path modified if appropriate.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._set = <span class="function"><span class="keyword">function</span> <span class="params">(pathToMark, path, constructing, parts, schema, val, priorVal)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.isNew) {
    <span class="keyword">this</span>.markModified(pathToMark);
  } <span class="keyword">else</span> {

    priorVal || (priorVal = <span class="keyword">this</span>.get(path));

    <span class="keyword">if</span> (!<span class="keyword">this</span>.isDirectModified(pathToMark)) {
      <span class="keyword">if</span> (<span class="literal">undefined</span> === val &amp;&amp; !<span class="keyword">this</span>.isSelected(path)) {
        <span class="comment">// special case:</span>
        <span class="comment">// when a path is not selected in a query its initial</span>
        <span class="comment">// value will be undefined.</span>
        <span class="keyword">this</span>.markModified(pathToMark, priorVal);
      } <span class="keyword">else</span> <span class="keyword">if</span> (!deepEqual(val, priorVal)) {
        <span class="keyword">this</span>.markModified(pathToMark, priorVal);
      } <span class="keyword">else</span> <span class="keyword">if</span> (!constructing &amp;&amp;
                 <span class="literal">null</span> != val &amp;&amp;
                 path <span class="keyword">in</span> <span class="keyword">this</span>._activePaths.states.<span class="keyword">default</span> &amp;&amp;
                 deepEqual(val, schema.getDefault(<span class="keyword">this</span>, constructing))) {
        <span class="comment">// special case:</span>
        <span class="comment">// a path with a default was $unset on the server</span>
        <span class="comment">// and the user is setting it to the same value again</span>
        <span class="keyword">this</span>.markModified(pathToMark, priorVal);
      }
    }
  }

  <span class="keyword">var</span> obj = <span class="keyword">this</span>._doc
    , i = <span class="number">0</span>
    , l = parts.length

  <span class="keyword">for</span> (; i &lt; l; i++) {
    <span class="keyword">var</span> next = i + <span class="number">1</span>
      , last = next === l;

    <span class="keyword">if</span> (last) {
      obj[parts[i]] = val;
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (obj[parts[i]] &amp;&amp; <span class="string">'Object'</span> === obj[parts[i]].constructor.name) {
        obj = obj[parts[i]];
      } <span class="keyword">else</span> <span class="keyword">if</span> (obj[parts[i]] &amp;&amp; Array.isArray(obj[parts[i]])) {
        obj = obj[parts[i]];
      } <span class="keyword">else</span> {
        obj = obj[parts[i]] = {};
      }
    }
  }
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="Document-getValue">Document#getValue(<code>path</code>)</h3><p>Gets a raw value from a path (no getters)</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.getValue = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
  <span class="keyword">var</span> parts = path.split(<span class="string">'.'</span>)
    , obj = <span class="keyword">this</span>._doc
    , part;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = parts.length; i &lt; l; i++) {
    part = parts[i];
    obj = obj.getValue
        ? obj.getValue(part) <span class="comment">// If we have an embedded array document member</span>
        : obj[part];
    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> obj;
  }

  <span class="keyword">return</span> obj;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Document-setValue">Document#setValue(<code>path</code>, <code>value</code>)</h3><p>Sets a raw value for a path (no casting, setters, transformations)</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.setValue = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">var</span> parts = path.split(<span class="string">'.'</span>)
    , obj = <span class="keyword">this</span>._doc;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = parts.length-<span class="number">1</span>; i &lt; len; i++) {
    obj = obj[parts[i]];
  }

  obj[parts[len]] = val;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Document-get">Document#get(<code>path</code>, <code>[type]</code>)</h3><p>Returns the value of a path.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.get = <span class="function"><span class="keyword">function</span> <span class="params">(path, type)</span> {</span>
  <span class="keyword">var</span> adhocs;
  <span class="keyword">if</span> (type) {
    adhocs = <span class="keyword">this</span>._adhocPaths || (<span class="keyword">this</span>._adhocPaths = {});
    adhocs[path] = Schema.interpretAsType(path, type);
  }

  <span class="keyword">var</span> schema = <span class="keyword">this</span>._path(path) || <span class="keyword">this</span>.schema.virtualpath(path)
    , pieces = path.split(<span class="string">'.'</span>)
    , obj = <span class="keyword">this</span>._doc;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = pieces.length; i &lt; l; i++) {
    obj = <span class="literal">null</span> == obj ? <span class="literal">null</span> : obj[pieces[i]];
  }

  <span class="keyword">if</span> (schema) {
    obj = schema.applyGetters(obj, <span class="keyword">this</span>);
  }

  <span class="keyword">return</span> obj;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[type]</code><span class="types"> &lt;<a href="#Schema">Schema</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="#Buffer">Buffer</a>, <a href="#etc..">etc..</a>&gt; </span><span>optionally specify a type for on-the-fly attributes</span></li></ul></div><h4>Example</h4>

<pre><code><span class="comment">// path</span>
doc.get(<span class="string">'age'</span>) <span class="comment">// 47</span>

<span class="comment">// dynamic casting to a string</span>
doc.get(<span class="string">'age'</span>, String) <span class="comment">// "47"</span></code></pre></div><hr class=""><div class="method private"><h3 id="Document-_path">Document#_path(<code>path</code>)</h3><p>Finds the path in the ad hoc type schema list or<br />in the schema's list of type schemas</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._path = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
  <span class="keyword">var</span> adhocs = <span class="keyword">this</span>._adhocPaths
    , adhocType = adhocs &amp;&amp; adhocs[path];

  <span class="keyword">if</span> (adhocType) {
    <span class="keyword">return</span> adhocType;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> <span class="keyword">this</span>.schema.path(path);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Document-markModified">Document#markModified(<code>path</code>)</h3><p>Marks that the path has pending changes to be written to the db.<br />Very helpful when using Mixed types.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.markModified = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
  <span class="keyword">this</span>._activePaths.modify(path);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path to mark modified</span></li></ul></div><pre><code>doc.markModified(<span class="string">'mixed.type'</span>);</code></pre></div><hr class=""><div class="method private"><h3 id="Document-try">Document#try(<code>fn</code>, <code>scope</code>)</h3><p>Catches errors that occur during execution of fn and stores them to later be passed when save() is executed.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.<span class="keyword">try</span> = <span class="function"><span class="keyword">function</span> <span class="params">(fn, scope)</span> {</span>
  <span class="keyword">var</span> res;
  <span class="keyword">try</span> {
    fn.call(scope);
    res = <span class="literal">true</span>;
  } <span class="keyword">catch</span> (e) {
    <span class="keyword">this</span>._error(e);
    res = <span class="literal">false</span>;
  }
  <span class="keyword">return</span> res;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>function to execute</span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the scope with which to call fn</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Document-modifiedPaths">Document#modifiedPaths()</h3><p>Returns the list of paths that have been modified.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.modifiedPaths = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> directModifiedPaths = Object.keys(<span class="keyword">this</span>._activePaths.states.modify);

  <span class="keyword">return</span> directModifiedPaths.reduce(<span class="function"><span class="keyword">function</span> <span class="params">(list, path)</span> {</span>
    <span class="keyword">var</span> parts = path.split(<span class="string">'.'</span>);
    <span class="keyword">return</span> list.concat(parts.reduce(<span class="function"><span class="keyword">function</span> <span class="params">(chains, part, i)</span> {</span>
      <span class="keyword">return</span> chains.concat(parts.slice(<span class="number">0</span>, i).concat(part).join(<span class="string">'.'</span>));
    }, []));
  }, []);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Document-isModified">Document#isModified(<code>[path]</code>)</h3><p>Returns true if this document was modified, else false.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isModified = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
  <span class="keyword">return</span> path
    ? !!~<span class="keyword">this</span>.modifiedPaths().indexOf(path)
    : <span class="keyword">this</span>._activePaths.some(<span class="string">'modify'</span>);
  <span class="comment">// TODO remove use of some()</span>
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional</span></li></ul></div><p>If <code>path</code> is given, checks if a path or any full path containing <code>path</code> as part of its path chain has been directly modified.</p>

<h4>Example</h4>

<pre><code>doc.set(<span class="string">'documents.0.title'</span>, <span class="string">'changed'</span>);
doc.isModified(<span class="string">'documents'</span>)         <span class="comment">// true</span>
doc.isModified(<span class="string">'documents.0.title'</span>) <span class="comment">// true</span>
doc.isDirectModified(<span class="string">'documents'</span>)   <span class="comment">// false</span></code></pre></div><hr class=""><div class="method "><h3 id="Document-isDirectModified">Document#isDirectModified(<code>path</code>)</h3><p>Returns true if <code>path</code> was directly set and modified, else false.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isDirectModified = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
  <span class="keyword">return</span> (path <span class="keyword">in</span> <span class="keyword">this</span>._activePaths.states.modify);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><h4>Example</h4>

<pre><code>doc.set(<span class="string">'documents.0.title'</span>, <span class="string">'changed'</span>);
doc.isDirectModified(<span class="string">'documents.0.title'</span>) <span class="comment">// true</span>
doc.isDirectModified(<span class="string">'documents'</span>) <span class="comment">// false</span></code></pre></div><hr class=""><div class="method "><h3 id="Document-isInit">Document#isInit(<code>path</code>)</h3><p>Checks if <code>path</code> was initialized.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isInit = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
  <span class="keyword">return</span> (path <span class="keyword">in</span> <span class="keyword">this</span>._activePaths.states.init);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Document-isSelected">Document#isSelected(<code>path</code>)</h3><p>Checks if <code>path</code> was selected in the source query which initialized this document.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isSelected = <span class="function"><span class="keyword">function</span> <span class="title">isSelected</span> <span class="params">(path)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._selected) {

    <span class="keyword">if</span> (<span class="string">'_id'</span> === path) {
      <span class="keyword">return</span> <span class="number">0</span> !== <span class="keyword">this</span>._selected._id;
    }

    <span class="keyword">var</span> paths = Object.keys(<span class="keyword">this</span>._selected)
      , i = paths.length
      , inclusive = <span class="literal">false</span>
      , cur

    <span class="keyword">if</span> (<span class="number">1</span> === i &amp;&amp; <span class="string">'_id'</span> === paths[<span class="number">0</span>]) {
      <span class="comment">// only _id was selected.</span>
      <span class="keyword">return</span> <span class="number">0</span> === <span class="keyword">this</span>._selected._id;
    }

    <span class="keyword">while</span> (i--) {
      cur = paths[i];
      <span class="keyword">if</span> (<span class="string">'_id'</span> == cur) <span class="keyword">continue</span>;
      inclusive = !! <span class="keyword">this</span>._selected[cur];
      <span class="keyword">break</span>;
    }

    <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>._selected) {
      <span class="keyword">return</span> inclusive;
    }

    i = paths.length;
    <span class="keyword">var</span> pathDot = path + <span class="string">'.'</span>;

    <span class="keyword">while</span> (i--) {
      cur = paths[i];
      <span class="keyword">if</span> (<span class="string">'_id'</span> == cur) <span class="keyword">continue</span>;

      <span class="keyword">if</span> (<span class="number">0</span> === cur.indexOf(pathDot)) {
        <span class="keyword">return</span> inclusive;
      }

      <span class="keyword">if</span> (<span class="number">0</span> === pathDot.indexOf(cur)) {
        <span class="keyword">return</span> inclusive;
      }
    }

    <span class="keyword">return</span> ! inclusive;
  }

  <span class="keyword">return</span> <span class="literal">true</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><h4>Example</h4>

<pre><code>Thing.findOne().select(<span class="string">'name'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
   doc.isSelected(<span class="string">'name'</span>) <span class="comment">// true</span>
   doc.isSelected(<span class="string">'age'</span>)  <span class="comment">// false</span></code></pre></div><hr class=""><div class="method "><h3 id="Document-validate">Document#validate(<code>cb</code>)</h3><p>Executes registered validation rules for this document.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.validate = <span class="function"><span class="keyword">function</span> <span class="params">(cb)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>

  <span class="comment">// only validate required fields when necessary</span>
  <span class="keyword">var</span> paths = Object.keys(<span class="keyword">this</span>._activePaths.states.require).filter(<span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
    <span class="keyword">if</span> (!self.isSelected(path) &amp;&amp; !self.isModified(path)) <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">return</span> <span class="literal">true</span>;
  });

  paths = paths.concat(Object.keys(<span class="keyword">this</span>._activePaths.states.init));
  paths = paths.concat(Object.keys(<span class="keyword">this</span>._activePaths.states.modify));

  <span class="keyword">if</span> (<span class="number">0</span> === paths.length) {
    complete();
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> validating = {}
    , total = <span class="number">0</span>;

  paths.forEach(validatePath);
  <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">validatePath</span> <span class="params">(path)</span> {</span>
    <span class="keyword">if</span> (validating[path]) <span class="keyword">return</span>;

    validating[path] = <span class="literal">true</span>;
    total++;

    process.nextTick(<span class="keyword">function</span>(){
      <span class="keyword">var</span> p = self.schema.path(path);
      <span class="keyword">if</span> (!p) <span class="keyword">return</span> --total || complete();

      p.doValidate(self.getValue(path), <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
        <span class="keyword">if</span> (err) self.invalidate(path, err);
        --total || complete();
      }, self);
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">complete</span> <span class="params">()</span> {</span>
    cb(self._validationError);
    self._validationError = <span class="literal">null</span>;
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>cb</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>called after validation completes, passing an error if one occurred</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Document-invalidate">Document#invalidate(<code>path</code>, <code>err</code>)</h3><p>Marks a path as invalid, causing validation to fail.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.invalidate = <span class="function"><span class="keyword">function</span> <span class="params">(path, err)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>._validationError) {
    <span class="keyword">this</span>._validationError = <span class="keyword">new</span> ValidationError(<span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (!err || <span class="string">'string'</span> === <span class="keyword">typeof</span> err) {
    err = <span class="keyword">new</span> ValidatorError(path, err);
  }

  <span class="keyword">this</span>._validationError.errors[path] = err;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to invalidate</span></li><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>the error which states the reason `path` was invalid</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="Document-_reset">Document#_reset()</h3><p>Resets the internal modified state of this document.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._reset = <span class="function"><span class="keyword">function</span> <span class="title">reset</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  DocumentArray || (DocumentArray = require(<span class="string">'./types/documentarray'</span>));

  <span class="keyword">this</span>._activePaths
  .map(<span class="string">'init'</span>, <span class="string">'modify'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(i)</span> {</span>
    <span class="keyword">return</span> self.getValue(i);
  })
  .filter(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
    <span class="keyword">return</span> (val &amp;&amp; val <span class="keyword">instanceof</span> DocumentArray &amp;&amp; val.length);
  })
  .forEach(<span class="function"><span class="keyword">function</span> <span class="params">(array)</span> {</span>
    array.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
      doc._reset();
    });
  });

  <span class="comment">// clear atomics</span>
  <span class="keyword">this</span>._dirty().forEach(<span class="function"><span class="keyword">function</span> <span class="params">(dirt)</span> {</span>
    <span class="keyword">var</span> type = dirt.value;
    <span class="keyword">if</span> (type &amp;&amp; type._atomics) {
      type._atomics = {};
    }
  });

  <span class="comment">// Clear 'modify'('dirty') cache</span>
  <span class="keyword">this</span>._activePaths.clear(<span class="string">'modify'</span>);
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">this</span>.schema.requiredPaths().forEach(<span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
    self._activePaths.require(path);
  });

  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Document-_dirty">Document#_dirty()</h3><p>Returns this documents dirty paths / vals.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._dirty = <span class="function"><span class="keyword">function</span> <span class="title">_dirty</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;

  <span class="keyword">var</span> all = <span class="keyword">this</span>._activePaths.map(<span class="string">'modify'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
    <span class="keyword">return</span> { path: path
           , value: self.getValue(path)
           , schema: self._path(path) };
  });

  <span class="comment">// Sort dirty paths in a flat hierarchy.</span>
  all.sort(<span class="function"><span class="keyword">function</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">return</span> (a.path &lt; b.path ? -<span class="number">1</span> : (a.path > b.path ? <span class="number">1</span> : <span class="number">0</span>));
  });

  <span class="comment">// Ignore "foo.a" if "foo" is dirty already.</span>
  <span class="keyword">var</span> minimal = []
    , lastPath
    , top;

  all.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(item, i)</span> {</span>
    <span class="keyword">if</span> (item.path.indexOf(lastPath) !== <span class="number">0</span>) {
      lastPath = item.path + <span class="string">'.'</span>;
      minimal.push(item);
      top = item;
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (!(item.value &amp;&amp; top.value)) <span class="keyword">return</span>;

      <span class="comment">// special case for top level MongooseArrays</span>
      <span class="keyword">if</span> (top.value._atomics &amp;&amp; top.value.hasAtomics()) {
        <span class="comment">// and the item is not a MongooseArray</span>
        <span class="keyword">if</span> (!(item.value._atomics &amp;&amp; item.value.hasAtomics())) {
          <span class="comment">// theres a sub path of top being explicitly set.</span>
          <span class="comment">// the only way to honor all of their modifications</span>
          <span class="comment">// is through a $set of entire array.</span>
          <span class="comment">// change top to a $set op</span>
          top.value._atomics = {};
          top.value._atomics.$set = top.value;
        }
      }
    }
  });

  top = lastPath = <span class="literal">null</span>;
  <span class="keyword">return</span> minimal;
}</code></pre></div></div><hr class="private"><div class="method private"><h3 id="compile">compile()</h3><p>Compiles schemas.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">compile</span> <span class="params">(tree, proto, prefix)</span> {</span>
  <span class="keyword">var</span> keys = Object.keys(tree)
    , i = keys.length
    , limb
    , key;

  <span class="keyword">while</span> (i--) {
    key = keys[i];
    limb = tree[key];

    define(key
        , ((<span class="string">'Object'</span> === limb.constructor.name
               &amp;&amp; Object.keys(limb).length)
               &amp;&amp; (!limb.type || limb.type.type)
               ? limb
               : <span class="literal">null</span>)
        , proto
        , prefix
        , keys);
  }
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="define">define()</h3><p>Defines the accessor named prop on the incoming prototype.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">define</span> <span class="params">(prop, subprops, prototype, prefix, keys)</span> {</span>
  <span class="keyword">var</span> prefix = prefix || <span class="string">''</span>
    , path = (prefix ? prefix + <span class="string">'.'</span> : <span class="string">''</span>) + prop;

  <span class="keyword">if</span> (subprops) {

    Object.defineProperty(prototype, prop, {
        enumerable: <span class="literal">true</span>
      , get: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">if</span> (!<span class="keyword">this</span>.__getters)
            <span class="keyword">this</span>.__getters = {};

          <span class="keyword">if</span> (!<span class="keyword">this</span>.__getters[path]) {
            <span class="keyword">var</span> nested = Object.create(<span class="keyword">this</span>);

            <span class="comment">// save scope for nested getters/setters</span>
            <span class="keyword">if</span> (!prefix) nested._scope = <span class="keyword">this</span>;

            <span class="comment">// shadow inherited getters from sub-objects so</span>
            <span class="comment">// thing.nested.nested.nested... doesn't occur (gh-366)</span>
            <span class="keyword">var</span> i = <span class="number">0</span>
              , len = keys.length;

            <span class="keyword">for</span> (; i &lt; len; ++i) {
              <span class="comment">// over-write the parents getter without triggering it</span>
              Object.defineProperty(nested, keys[i], {
                  enumerable: <span class="literal">false</span>   <span class="comment">// It doesn't show up.</span>
                , writable: <span class="literal">true</span>      <span class="comment">// We can set it later.</span>
                , configurable: <span class="literal">true</span>  <span class="comment">// We can Object.defineProperty again.</span>
                , value: <span class="literal">undefined</span>    <span class="comment">// It shadows its parent.</span>
              });
            }

            nested.toObject = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
              <span class="keyword">return</span> <span class="keyword">this</span>.get(path);
            };

            compile(subprops, nested, path);
            <span class="keyword">this</span>.__getters[path] = nested;
          }

          <span class="keyword">return</span> <span class="keyword">this</span>.__getters[path];
        }
      , set: <span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
          <span class="keyword">return</span> <span class="keyword">this</span>.set(v, path);
        }
    });

  } <span class="keyword">else</span> {

    Object.defineProperty(prototype, prop, {
        enumerable: <span class="literal">true</span>
      , get: <span class="function"><span class="keyword">function</span> <span class="params">( )</span> {</span> <span class="keyword">return</span> <span class="keyword">this</span>.get.call(<span class="keyword">this</span>._scope || <span class="keyword">this</span>, path); }
      , set: <span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span> <span class="keyword">return</span> <span class="keyword">this</span>.set.call(<span class="keyword">this</span>._scope || <span class="keyword">this</span>, path, v); }
    });
  }
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="Document-_setSchema">Document#_setSchema(<code>schema</code>)</h3><p>Assigns/compiles <code>schema</code> into this documents prototype.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._setSchema = <span class="function"><span class="keyword">function</span> <span class="params">(schema)</span> {</span>
  compile(schema.tree, <span class="keyword">this</span>);
  <span class="keyword">this</span>.schema = schema;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>schema</code><span class="types"> &lt;<a href="#Schema">Schema</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Document-_registerHooks">Document#_registerHooks()</h3><p>Register default hooks</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._registerHooks = <span class="function"><span class="keyword">function</span> <span class="title">_registerHooks</span> <span class="params">()</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.save) <span class="keyword">return</span>;

  DocumentArray || (DocumentArray = require(<span class="string">'./types/documentarray'</span>));

  <span class="keyword">this</span>.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
    <span class="comment">// we keep the error semaphore to make sure we don't</span>
    <span class="comment">// call `save` unnecessarily (we only need 1 error)</span>
    <span class="keyword">var</span> subdocs = <span class="number">0</span>
      , error = <span class="literal">false</span>
      , self = <span class="keyword">this</span>;

    <span class="comment">// check for DocumentArrays</span>
    <span class="keyword">var</span> arrays = <span class="keyword">this</span>._activePaths
    .map(<span class="string">'init'</span>, <span class="string">'modify'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(i)</span> {</span>
      <span class="keyword">return</span> self.getValue(i);
    })
    .filter(<span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
      <span class="keyword">return</span> (val &amp;&amp; val <span class="keyword">instanceof</span> DocumentArray &amp;&amp; val.length);
    });

    <span class="keyword">if</span> (!arrays.length)
      <span class="keyword">return</span> next();

    arrays.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(array)</span> {</span>
      subdocs += array.length;
      array.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
        <span class="keyword">if</span> (!error)
          value.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
            <span class="keyword">if</span> (!error) {
              <span class="keyword">if</span> (err) {
                error = <span class="literal">true</span>;
                next(err);
              } <span class="keyword">else</span>
                --subdocs || next();
            }
          });
      });
    });
  }, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
    <span class="keyword">this</span>.db.emit(<span class="string">'error'</span>, err);
  }).pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span> <span class="title">checkForExistingErrors</span> <span class="params">(next)</span> {</span>
    <span class="comment">// if any doc.set() calls failed</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._saveError) {
      next(<span class="keyword">this</span>._saveError);
      <span class="keyword">this</span>._saveError = <span class="literal">null</span>;
    } <span class="keyword">else</span> {
      next();
    }
  }).pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span> <span class="title">validation</span> <span class="params">(next)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.validate(next);
  });

  <span class="comment">// add user defined queues</span>
  <span class="keyword">this</span>._doQueue();
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="Document-_error">Document#_error(<code>err</code>)</h3><p>Registers an error</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._error = <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="keyword">this</span>._saveError = err;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Document-_doQueue">Document#_doQueue()</h3><p>Executes methods queued from the Schema definition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype._doQueue = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> q = <span class="keyword">this</span>.schema &amp;&amp; <span class="keyword">this</span>.schema.callQueue;
  <span class="keyword">if</span> (q) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = q.length; i &lt; l; i++) {
      <span class="keyword">this</span>[q[i][<span class="number">0</span>]].apply(<span class="keyword">this</span>, q[i][<span class="number">1</span>]);
    }
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="Document-toObject">Document#toObject(<code>[options]</code>)</h3><p>Converts this document into a plain javascript object</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.toObject = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>
  <span class="comment">// When internally saving this document we always pass options,</span>
  <span class="comment">// bypassing the custom schema options.</span>
  <span class="keyword">if</span> (!(options &amp;&amp; <span class="string">'Object'</span> == options.constructor.name)) {
    options = <span class="keyword">this</span>.schema.options.toObject
      ? clone(<span class="keyword">this</span>.schema.options.toObject)
      : {};
  }

  ;(<span class="string">'minimize'</span> <span class="keyword">in</span> options) || (options.minimize = <span class="keyword">this</span>.schema.options.minimize);

  <span class="keyword">var</span> ret = clone(<span class="keyword">this</span>._doc, options);

  <span class="keyword">if</span> (options.virtuals || options.getters &amp;&amp; <span class="literal">false</span> !== options.virtuals) {
    applyGetters(<span class="keyword">this</span>, ret, <span class="string">'virtuals'</span>, options);
  }

  <span class="keyword">if</span> (options.getters) {
    applyGetters(<span class="keyword">this</span>, ret, <span class="string">'paths'</span>, options);
  }

  <span class="keyword">return</span> ret;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>js object</span></li></ul></div><p>Available options</p>

<ul>
<li><code>getters</code> apply all getters (path and virtual getters)</li>
<li><code>virtuals</code> apply virtual getters (can override <code>getters</code> option)</li>
<li><code>minimize</code> remove empty objects (defaults to true)</li>
</ul>

<p>Example of only applying path getters</p>

<pre><code>doc.toObject({ getters: <span class="literal">true</span>, virtuals: <span class="literal">false</span> })</code></pre>

<p>Example of only applying virtual getters</p>

<pre><code>doc.toObject({ virtuals: <span class="literal">true</span> })</code></pre>

<p>Example of applying both path and virtual getters</p>

<pre><code>doc.toObject({ getters: <span class="literal">true</span> })</code></pre></div><hr class=""><div class="method private"><h3 id="applyGetters">applyGetters(<code>self</code>, <code>json</code>, <code>type</code>)</h3><p>Applies virtuals properties to <code>json</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">applyGetters</span> <span class="params">(self, json, type, options)</span> {</span>
  <span class="keyword">var</span> schema = self.schema
    , paths = Object.keys(schema[type])
    , i = paths.length
    , path

  <span class="keyword">while</span> (i--) {
    path = paths[i];

    <span class="keyword">var</span> parts = path.split(<span class="string">'.'</span>)
      , plen = parts.length
      , last = plen - <span class="number">1</span>
      , branch = json
      , part

    <span class="keyword">for</span> (<span class="keyword">var</span> ii = <span class="number">0</span>; ii &lt; plen; ++ii) {
      part = parts[ii];
      <span class="keyword">if</span> (ii === last) {
        branch[part] = clone(self.get(path), options);
      } <span class="keyword">else</span> {
        branch = branch[part] || (branch[part] = {});
      }
    }
  }

  <span class="keyword">return</span> json;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>self</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span></span></li><li><code>json</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>type</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>either `virtuals` or `paths`</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>`json`</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Document-toJSON">Document#toJSON(<code>options</code>)</h3><p>The return value of this method is used in calls to JSON.stringify(doc).</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.toJSON = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>
  <span class="comment">// check for object type since an array of documents</span>
  <span class="comment">// being stringified passes array indexes instead</span>
  <span class="comment">// of options objects. JSON.stringify([doc, doc])</span>
  <span class="keyword">if</span> (!(options &amp;&amp; <span class="string">'Object'</span> == options.constructor.name)) {
    options = <span class="keyword">this</span>.schema.options.toJSON
      ? clone(<span class="keyword">this</span>.schema.options.toJSON)
      : {};
  }
  options.json = <span class="literal">true</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>.toObject(options);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>same options as Document#toObject</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#Document-toObject" title="Document#toObject">Document#toObject</a></li></ul></div></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Helpers for console.log</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.toString =
Document.prototype.inspect = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>
  <span class="keyword">var</span> opts = options &amp;&amp; <span class="string">'Object'</span> == options.constructor.name
    ? options
    : <span class="literal">undefined</span>
  <span class="keyword">return</span> inspect(<span class="keyword">this</span>.toObject(opts));
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Document-equals">Document#equals(<code>doc</code>)</h3><p>Returns true if the Document stores the same data as doc.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.equals = <span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
  <span class="keyword">var</span> tid = <span class="keyword">this</span>.get(<span class="string">'_id'</span>);
  <span class="keyword">var</span> docid = doc.get(<span class="string">'_id'</span>);
  <span class="keyword">return</span> tid.equals
    ? tid.equals(docid)
    : tid === docid;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span>a document to compare</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="property "><h3 id="Document-errors">Document#<span>errors</span></h3><p>Object containing validation errors.</p></div><hr><div class="property "><h3 id="Document-isNew">Document#<span>isNew</span></h3><p>Whether the document is new.</p></div><hr><div class="property "><h3 id="Document-schema">Document#<span>schema</span></h3><p>Document schema as a nested structure.</p></div><hr></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/drivers/node-mongodb-native/binary.js">lib/drivers/node-mongodb-native/binary.js</a></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/drivers/node-mongodb-native/collection.js">lib/drivers/node-mongodb-native/collection.js</a><div class="method private"><h3 id="MongooseCollection">MongooseCollection()</h3><p>node-mongodb-native collection implementation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseCollection</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.collection = <span class="literal">null</span>;
  Collection.apply(<span class="keyword">this</span>, arguments);
};</code></pre></div><div class="inherits"><h4>Inherits:</h4><ul><li>Collection</li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#lib/collection.js" title="lib/collection.js">lib/collection.js</a></li></ul></div></div><hr class="private"><div class="method private"><h3 id="MongooseCollection-onOpen">MongooseCollection#onOpen()</h3><p>Called when the connection opens.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseCollection.prototype.onOpen = function () {
  var self = this;

  if (this.collection) {
    return Collection.prototype.onOpen.call(self);
  }

  if (!self.opts.size) {
    // non-capped
    return self.conn.db.collection(self.name, callback);
  }

  // capped
  return self.conn.db.collection(self.name, function (err, c) {
    if (err) return callback(err);

    // discover if this collection exists and if it is capped
    c.options(function (err, exists) {
      if (err) return callback(err);

      if (exists) {
        if (exists.capped) {
          callback(null, c);
        } else {
          var msg = 'A non-capped collection exists with this name.

'
                  + ' To use this collection as a capped collection, please '
                  + 'first convert it.
'
                  + ' http://www.mongodb.org/display/DOCS/Capped+Collections#CappedCollections-Convertingacollectiontocapped'
          err = new Error(msg);
          callback(err);
        }
      } else {
        // create
        var opts = utils.clone(self.opts);
        opts.capped = true;
        self.conn.db.createCollection(self.name, opts, callback);
      }
    });
  });

  function callback (err, collection) {
    if (err) {
      // likely a strict mode error
      self.conn.emit('error', err);
    } else {
      self.collection = collection;
      Collection.prototype.onOpen.call(self);
    }
  };
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="MongooseCollection-onClose">MongooseCollection#onClose()</h3><p>Called when the connection closes</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseCollection.prototype.onClose = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  Collection.prototype.onClose.call(<span class="keyword">this</span>);
};</code></pre></div></div><hr class="private"><div class="method "><h3>MISSING method name</h3><p>Retreives information about this collections indexes.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseCollection.prototype.getIndexes =
MongooseCollection.prototype.indexInformation;</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/drivers/node-mongodb-native/connection.js">lib/drivers/node-mongodb-native/connection.js</a><div class="method private"><h3 id="NativeConnection">NativeConnection()</h3><p>Connection for mongodb-native driver</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">NativeConnection</span><span class="params">()</span> {</span>
  Connection.apply(<span class="keyword">this</span>, arguments);
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="NativeConnection-doOpen">NativeConnection#doOpen(<code>fn</code>)</h3><p>Opens the connection to MongoDB.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.prototype.doOpen = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">var</span> server;

  <span class="keyword">if</span> (!<span class="keyword">this</span>.db) {
    server = <span class="keyword">new</span> mongo.Server(<span class="keyword">this</span>.host, Number(<span class="keyword">this</span>.port), <span class="keyword">this</span>.options.server);
    <span class="keyword">this</span>.db = <span class="keyword">new</span> mongo.Db(<span class="keyword">this</span>.name, server, <span class="keyword">this</span>.options.db);
  }

  <span class="keyword">this</span>.db.open(fn);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><h2>Example server options</h2>

<p>auto_reconnect (default: false)<br />   poolSize (default: 1)</p>

<h2>Example db options</h2>

<p>pk - custom primary key factory to generate <code>_id</code> values</p>

<p>Some of these options may break Mongoose.<br />Use at your own risk. You have been warned.</p></div><hr class="private"><div class="method private"><h3 id="NativeConnection-doOpenSet">NativeConnection#doOpenSet(<code>fn</code>)</h3><p>Opens a connection to a MongoDB ReplicaSet.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.prototype.doOpenSet = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.db) {
    <span class="keyword">var</span> servers = []
      , ports = <span class="keyword">this</span>.port
      , self = <span class="keyword">this</span>

    <span class="keyword">this</span>.host.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(host, i)</span> {</span>
      servers.push(<span class="keyword">new</span> mongo.Server(host, Number(ports[i]), self.options.server));
    });

    <span class="keyword">var</span> server = <span class="keyword">new</span> ReplSetServers(servers, <span class="keyword">this</span>.options.replset);
    <span class="keyword">this</span>.db = <span class="keyword">new</span> mongo.Db(<span class="keyword">this</span>.name, server, <span class="keyword">this</span>.options.db);
  }

  <span class="keyword">this</span>.db.open(fn);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><p>See description of doOpen for server options. In this case options.replset<br />is also passed to ReplSetServers.</p></div><hr class="private"><div class="method private"><h3 id="NativeConnection-doClose">NativeConnection#doClose(<code>fn</code>)</h3><p>Closes the connection</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.prototype.doClose = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">this</span>.db.close();
  <span class="keyword">if</span> (fn) fn();
  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class="private"></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/drivers/node-mongodb-native/objectid.js">lib/drivers/node-mongodb-native/objectid.js</a><div class="method private"><h3>()</h3><p>Constructor export</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> ObjectIdToString = ObjectId.toString.bind(ObjectId);

module.exports = exports = ObjectId;</code></pre></div></div><hr class="private"><div class="method private"><h3 id="function Object() { [native code] }-fromString">function Object() { [native code] }#fromString(<code>hex</code>)</h3><p>Creates an ObjectID for this driver</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.fromString = <span class="keyword">function</span>(str){
  <span class="comment">// patch native driver bug in V0.9.6.4</span>
  <span class="keyword">if</span> (!(<span class="string">'string'</span> === <span class="keyword">typeof</span> str &amp;&amp; <span class="number">24</span> === str.length)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Invalid ObjectId"</span>);
  }

  <span class="keyword">return</span> ObjectId.createFromHexString(str);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>hex</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>string or ObjectId</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="function Object() { [native code] }-toString">function Object() { [native code] }#toString(<code>-native</code>)</h3><p>Gets an ObjectId and converts it to string.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.toString = <span class="keyword">function</span>(oid){
  <span class="keyword">if</span> (!arguments.length) <span class="keyword">return</span> ObjectIdToString();
  <span class="keyword">return</span> oid.toHexString();
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>-native</code><span class="types"> &lt;<a href="#ObjectId">ObjectId</a>&gt; </span><span>objectid</span></li></ul></div></div><hr class="private"></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/error.js">lib/error.js</a><div class="method private"><h3 id="MongooseError">MongooseError()</h3><p>Mongoose error</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseError</span> <span class="params">(msg)</span> {</span>
  Error.call(<span class="keyword">this</span>);
  Error.captureStackTrace(<span class="keyword">this</span>, arguments.callee);
  <span class="keyword">this</span>.message = msg;
  <span class="keyword">this</span>.name = <span class="string">'MongooseError'</span>;
};</code></pre></div><div class="inherits"><h4>Inherits:</h4><ul><li>Error</li></ul></div></div><hr class="private"></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/errors/document.js">lib/errors/document.js</a><div class="method private"><h3 id="DocumentError">DocumentError(<code></code>)</h3><p>Document Error</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">DocumentError</span> <span class="params">()</span> {</span>
  MongooseError.call(<span class="keyword">this</span>, msg);
  Error.captureStackTrace(<span class="keyword">this</span>, arguments.callee);
  <span class="keyword">this</span>.name = <span class="string">'DocumentError'</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#text">text</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="DocumentError">DocumentError()</h3><p>Inherits from MongooseError.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentError.prototype.__proto__ = MongooseError.prototype;</code></pre></div></div><hr class=""><div class="method "><h3 id="DocumentError">DocumentError()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = exports = DocumentError;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/errors/validation.js">lib/errors/validation.js</a><div class="method private"><h3 id="ValidationError">ValidationError()</h3><p>Document Validation Error</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ValidationError</span> <span class="params">(instance)</span> {</span>
  MongooseError.call(<span class="keyword">this</span>, <span class="string">"Validation failed"</span>);
  Error.captureStackTrace(<span class="keyword">this</span>, arguments.callee);
  <span class="keyword">this</span>.name = <span class="string">'ValidationError'</span>;
  <span class="keyword">this</span>.errors = instance.errors = {};
};

ValidationError.prototype.toString = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">': '</span> + Object.keys(<span class="keyword">this</span>.errors).map(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
    <span class="keyword">return</span> String(<span class="keyword">this</span>.errors[key]);
  }, <span class="keyword">this</span>).join(<span class="string">', '</span>);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="ValidationError">ValidationError()</h3><p>Inherits from MongooseError.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ValidationError.prototype.__proto__ = MongooseError.prototype;</code></pre></div></div><hr class=""><div class="method "><h3 id="ValidationError">ValidationError()</h3><p>Module exports</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = exports = ValidationError;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/index.js">lib/index.js</a><div class="method "><h3 id="Mongoose">Mongoose()</h3><p>Mongoose constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Mongoose</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.connections = [];
  <span class="keyword">this</span>.plugins = [];
  <span class="keyword">this</span>.models = {};
  <span class="keyword">this</span>.modelSchemas = {};
  <span class="keyword">this</span>.options = {};
  <span class="keyword">this</span>.createConnection(); <span class="comment">// default connection</span>
};</code></pre></div><p>Most apps will only use one instance.</p></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Sets/gets mongoose options</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.set =
Mongoose.prototype.get = <span class="function"><span class="keyword">function</span> <span class="params">(key, value)</span> {</span>
  <span class="keyword">if</span> (arguments.length == <span class="number">1</span>)
    <span class="keyword">return</span> <span class="keyword">this</span>.options[key];
  <span class="keyword">this</span>.options[key] = value;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><h2>Examples</h2>

<p>mongoose.set('test') // returns the 'test' value<br />   mongoose.set('test', value) // sets the 'test' value</p></div><hr class=""><div class="method "><h3 id="Mongoose-createConnection">Mongoose#createConnection(<code>mongodb://</code>)</h3><p>Creates a Connection instance.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.createConnection = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> conn = <span class="keyword">new</span> Connection(<span class="keyword">this</span>);
  <span class="keyword">this</span>.connections.push(conn);

  <span class="keyword">if</span> (arguments.length) {
    <span class="keyword">if</span> (rgxReplSet.test(arguments[<span class="number">0</span>])) {
      conn.openSet.apply(conn, arguments);
    } <span class="keyword">else</span> {
      conn.open.apply(conn, arguments);
    }
  }

  <span class="keyword">return</span> conn;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>mongodb://</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>URI</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Connection">Connection</a>&gt; </span><span>the created Connection object</span></li></ul></div><h2>Examples</h2>

<p>// with mongodb:// URI<br />   db = mongoose.createConnection('mongodb://localhost:port/database');</p>

<p>// with [host, database_name[, port] signature<br />   db = mongoose.createConnection('localhost', 'database', port)</p>

<p>// initialize now, connect later<br />   db = mongoose.createConnection();<br />   db.open('localhost', 'database', port);</p></div><hr class=""><div class="method "><h3 id="Mongoose-connect">Mongoose#connect()</h3><p>Connects the default mongoose connection</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.connect = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> conn = <span class="keyword">this</span>.connection;

  <span class="keyword">if</span> (rgxReplSet.test(arguments[<span class="number">0</span>])) {
    conn.openSet.apply(conn, arguments);
  } <span class="keyword">else</span> {
    conn.open.apply(conn, arguments);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#{Mongoose-createConnection}" title="{Mongoose#createConnection}">{Mongoose#createConnection}</a></li></ul></div></div><hr class=""><div class="method "><h3 id="Mongoose-disconnect">Mongoose#disconnect(<code>fn</code>)</h3><p>Disconnects from all connections.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.disconnect = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">var</span> count = <span class="keyword">this</span>.connections.length
    , error

  <span class="keyword">this</span>.connections.forEach(<span class="keyword">function</span>(conn){
    conn.close(<span class="keyword">function</span>(err){
      <span class="keyword">if</span> (error) <span class="keyword">return</span>;

      <span class="keyword">if</span> (err) {
        error = err;
        <span class="keyword">if</span> (fn) <span class="keyword">return</span> fn(err);
        <span class="keyword">throw</span> err;
      }

      <span class="keyword">if</span> (fn)
        --count || fn();
    });
  });
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>optional callback</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Mongoose-model">Mongoose#model(<code>name</code>, <code>schema</code>, <code>collection</code>, <code>skipInit</code>)</h3><p>Defines a model or retrieves it</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.model = function (name, schema, collection, skipInit) {
  // normalize collection
  if (!(schema instanceof Schema)) {
    collection = schema;
    schema = false;
  }

  if ('boolean' === typeof collection) {
    skipInit = collection;
    collection = null;
  }

  // look up models for the collection
  if (!this.modelSchemas[name]) {
    if (!schema &amp;&amp; name in SchemaDefaults) {
      schema = SchemaDefaults[name];
    }

    if (schema) {
      this.modelSchemas[name] = schema;
      for (var i = 0, l = this.plugins.length; i &lt; l; i++) {
        schema.plugin(this.plugins[i][0], this.plugins[i][1]);
      }
    } else {
      throw new Error('Schema hasn\'t been registered for model "' + name + '".
'
                    + 'Use mongoose.model(name, schema)');
    }
  }

  if (!this.models[name]) {
    schema || (schema = this.modelSchemas[name]);
    collection || (collection = schema.set('collection') || format(name));

    var model = Model.compile(name
                        , this.modelSchemas[name]
                        , collection
                        , this.connection
                        , this);

    if (!skipInit) model.init();

    this.models[name] = model;
  }

  return this.models[name];
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>model name</span></li><li><code>schema</code><span class="types"> &lt;<a href="#Schema">Schema</a>&gt; </span><span></span></li><li><code>collection</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name (optional, induced from model name)</span></li><li><code>skipInit</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>whether to skip initialization (defaults to false)</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin(<code>fn</code>, <code>[opts]</code>)</h3><p>Declares a plugin executed on Schemas.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.plugin = <span class="function"><span class="keyword">function</span> <span class="params">(fn, opts)</span> {</span>
  <span class="keyword">this</span>.plugins.push([fn, opts]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>plugin callback</span></li><li><code>[opts]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional options</span></li></ul></div><p>Equivalent to calling <code>.plugin(fn)</code> on each Schema you create.</p></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Export default Mongoose singleton.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = exports = <span class="keyword">new</span> Mongoose;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Collection</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Collection = Collection;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Connection</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Connection = Connection;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Mongoose version</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.version = JSON.parse(
  require(<span class="string">'fs'</span>).readFileSync(__dirname + <span class="string">'/../package.json'</span>, <span class="string">'utf8'</span>)
).version;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Mongoose constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Mongoose = Mongoose;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Schema constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Schema = Schema;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose SchemaType constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.SchemaType = SchemaType;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose VirtualType constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.VirtualType = VirtualType;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose types</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Types = Types;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Query</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Query = Query;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Promise</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Promise = Promise;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Model constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Model = Model;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose Document constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Document = Document;</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose MongooseError</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Error = require(<span class="string">'./error'</span>);</code></pre></div></div><hr class=""><div class="method "><h3 id="Mongoose-plugin">Mongoose#plugin()</h3><p>Expose the driver.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.mongo = require(<span class="string">'mongodb'</span>);</code></pre></div></div><hr class=""><div class="property "><h3 id="Mongoose-connection">Mongoose#<span>connection</span></h3><p>Default connection</p></div><hr></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/model.js">lib/model.js</a><div class="method "><h3 id="Model">Model(<code>doc</code>)</h3><p>Model constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Model</span> <span class="params">(doc, fields, skipId)</span> {</span>
  Document.call(<span class="keyword">this</span>, doc, fields, skipId);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>values to with which to create the document</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li>Document</li></ul></div></div><hr class=""><div class="method private"><h3 id="Model-_getPopulationKeys">Model#_getPopulationKeys(<code>query</code>)</h3><p>Returns what paths can be populated</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype._getPopulationKeys = <span class="function"><span class="keyword">function</span> <span class="title">getPopulationKeys</span> <span class="params">(query)</span> {</span>
  <span class="keyword">if</span> (!(query &amp;&amp; query.options.populate)) <span class="keyword">return</span>;

  <span class="keyword">var</span> names = Object.keys(query.options.populate)
    , n = names.length
    , name
    , paths = {}
    , hasKeys
    , schema

  <span class="keyword">while</span> (n--) {
    name = names[n];
    schema = <span class="keyword">this</span>.schema.path(name);
    hasKeys = <span class="literal">true</span>;

    <span class="keyword">if</span> (!schema) {
      <span class="comment">// if the path is not recognized, it's potentially embedded docs</span>
      <span class="comment">// walk path atoms from right to left to find a matching path</span>
      <span class="keyword">var</span> pieces = name.split(<span class="string">'.'</span>)
        , i = pieces.length;

      <span class="keyword">while</span> (i--) {
        <span class="keyword">var</span> path = pieces.slice(<span class="number">0</span>, i).join(<span class="string">'.'</span>)
          , pathSchema = <span class="keyword">this</span>.schema.path(path);

        <span class="comment">// loop until we find an array schema</span>
        <span class="keyword">if</span> (pathSchema &amp;&amp; pathSchema.caster) {
          <span class="keyword">if</span> (!paths[path]) {
            paths[path] = { sub: {} };
          }

          paths[path].sub[pieces.slice(i).join(<span class="string">'.'</span>)] = query.options.populate[name];
          hasKeys || (hasKeys = <span class="literal">true</span>);
          <span class="keyword">break</span>;
        }
      }
    } <span class="keyword">else</span> {
      paths[name] = query.options.populate[name];
      hasKeys || (hasKeys = <span class="literal">true</span>);
    }
  }

  <span class="keyword">return</span> hasKeys &amp;&amp; paths;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>query</code><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>object</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span>population paths</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Model-_populate">Model#_populate(<code>schema</code>, <code>oid</code>, <code>query</code>, <code>fn</code>)</h3><p>Populates an object</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype._populate = <span class="function"><span class="keyword">function</span> <span class="title">populate</span> <span class="params">(schema, oid, query, fn)</span> {</span>
  <span class="keyword">if</span> (!Array.isArray(oid)) {
    <span class="keyword">var</span> conditions = query.conditions || {};
    conditions._id = oid;

    <span class="keyword">return</span> <span class="keyword">this</span>
    .db.model(query.model || schema.options.ref)
    .findOne(conditions, query.fields, query.options, fn);
  }

  <span class="keyword">if</span> (!oid.length) {
    <span class="keyword">return</span> fn(<span class="literal">null</span>, oid);
  }

  <span class="keyword">var</span> model = <span class="keyword">this</span>.db.model(query.model || schema.caster.options.ref)
    , conditions = query &amp;&amp; query.conditions || {};

  conditions._id || (conditions._id = { $<span class="keyword">in</span>: oid });

  model.find(conditions, query.fields, query.options, <span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> fn(err);

    <span class="comment">// user specified sort order?</span>
    <span class="keyword">if</span> (query.options &amp;&amp; query.options.sort) {
      <span class="keyword">return</span> fn(<span class="literal">null</span>, docs);
    }

    <span class="comment">// put back in original id order (using a hash reduces complexity from n*n to 2n)</span>
    <span class="keyword">var</span> docHash = {};
    docs.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
      docHash[doc._id] = doc;
    });

    <span class="keyword">var</span> arr = [];
    oid.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(id)</span> {</span>
      <span class="keyword">if</span> (id <span class="keyword">in</span> docHash) arr.push(docHash[id]);
    });

    fn(<span class="literal">null</span>, arr);
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>schema</code><span class="types"> &lt;<a href="#SchemaType">SchemaType</a>&gt; </span><span>type for the oid</span></li><li><code>oid</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>object id or array of object ids</span></li><li><code>query</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>object specifying query conditions, fields, and options</span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Model-init">Model#init(<code>doc</code>, <code>query</code>, <code>fn</code>)</h3><p>Performs auto-population of relations.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.init = <span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(doc, query, fn)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> query) {
    fn = query;
    query = <span class="literal">null</span>;
  }

  <span class="keyword">var</span> populate = <span class="keyword">this</span>._getPopulationKeys(query);

  <span class="keyword">if</span> (!populate) {
    <span class="keyword">return</span> Document.prototype.init.call(<span class="keyword">this</span>, doc, fn);
  }

  <span class="comment">// population from other models is necessary</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;

  init(doc, <span class="string">''</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> fn(err);
    Document.prototype.init.call(self, doc, fn);
  });

  <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(obj, prefix, fn)</span> {</span>
    prefix = prefix || <span class="string">''</span>;

    <span class="keyword">var</span> keys = Object.keys(obj)
      , len = keys.length;

    <span class="function"><span class="keyword">function</span> <span class="title">next</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (--len &lt; <span class="number">0</span>) <span class="keyword">return</span> fn();

      <span class="keyword">var</span> i = keys[len]
        , path = prefix + i
        , schema = self.schema.path(path)
        , total = <span class="number">0</span>
        , poppath

      <span class="keyword">if</span> (!schema &amp;&amp; obj[i] &amp;&amp; <span class="string">'Object'</span> === obj[i].constructor.name) {
        <span class="comment">// assume nested object</span>
        <span class="keyword">return</span> init(obj[i], path + <span class="string">'.'</span>, next);
      }

      <span class="keyword">if</span> (!(obj[i] &amp;&amp; schema &amp;&amp; populate[path])) <span class="keyword">return</span> next();

      <span class="comment">// this query object is re-used and passed around. we clone</span>
      <span class="comment">// it to prevent query condition contamination between</span>
      <span class="comment">// one populate call to the next.</span>
      poppath = utils.clone(populate[path]);

      <span class="keyword">if</span> (poppath.sub) {
        obj[i].forEach(<span class="function"><span class="keyword">function</span> <span class="params">(subobj)</span> {</span>
          <span class="keyword">var</span> pkeys = Object.keys(poppath.sub)
            , pi = pkeys.length
            , key

          <span class="keyword">while</span> (pi--) {
            key = pkeys[pi];

            <span class="keyword">if</span> (subobj[key]) (<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>

              total++;
              self._populate(schema.schema.path(key), subobj[key], poppath.sub[key], done);
              <span class="function"><span class="keyword">function</span> <span class="title">done</span> <span class="params">(err, doc)</span> {</span>
                <span class="keyword">if</span> (err) <span class="keyword">return</span> error(err);
                subobj[key] = doc;
                --total || next();
              }
            })(key);
          }
        });

        <span class="keyword">if</span> (<span class="number">0</span> === total) <span class="keyword">return</span> next();

      } <span class="keyword">else</span> {
        self._populate(schema, obj[i], poppath, <span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
          <span class="keyword">if</span> (err) <span class="keyword">return</span> error(err);
          obj[i] = doc;
          next();
        });
      }
    };

    next();
  };

  <span class="function"><span class="keyword">function</span> <span class="title">error</span> <span class="params">(err)</span> {</span>
    <span class="keyword">if</span> (error.err) <span class="keyword">return</span>;
    fn(error.err = err);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>document returned by mongo</span></li><li><code>query</code><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>query that originated the initialization</span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Model-save">Model#save(<code>[fn]</code>)</h3><p>Saves this document.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.save = <span class="function"><span class="keyword">function</span> <span class="title">save</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise(fn)
    , complete = handleSave(promise, <span class="keyword">this</span>)
    , options = {}

  <span class="keyword">if</span> (<span class="keyword">this</span>.schema.options.safe) {
    options.safe = <span class="keyword">this</span>.schema.options.safe;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.isNew) {
    <span class="comment">// send entire doc</span>
    <span class="keyword">var</span> obj = <span class="keyword">this</span>.toObject({ depopulate: <span class="number">1</span> });
    <span class="keyword">this</span>._version(<span class="literal">true</span>, obj);
    <span class="keyword">this</span>.collection.insert(obj, options, complete);
    <span class="keyword">this</span>._reset();
    <span class="keyword">this</span>.isNew = <span class="literal">false</span>;
    <span class="keyword">this</span>.emit(<span class="string">'isNew'</span>, <span class="literal">false</span>);
    <span class="comment">// Make it possible to retry the insert</span>
    <span class="keyword">this</span>._inserting = <span class="literal">true</span>;

  } <span class="keyword">else</span> {
    <span class="comment">// Make sure we don't treat it as a new object on error,</span>
    <span class="comment">// since it already exists</span>
    <span class="keyword">this</span>._inserting = <span class="literal">false</span>;

    <span class="keyword">var</span> delta = <span class="keyword">this</span>._delta();
    <span class="keyword">if</span> (delta) {
      <span class="keyword">var</span> where = <span class="keyword">this</span>._where(delta[<span class="number">0</span>]);
      <span class="keyword">this</span>.collection.update(where, delta[<span class="number">1</span>], options, complete);
    } <span class="keyword">else</span> {
      complete(<span class="literal">null</span>);
    }

    <span class="keyword">this</span>._reset();
    <span class="keyword">this</span>.emit(<span class="string">'isNew'</span>, <span class="literal">false</span>);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>optional callback</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#Model-registerHooks" title="Model#registerHooks">Model#registerHooks</a></li></ul></div></div><hr class=""><div class="method private"><h3 id="Model-_delta">Model#_delta()</h3><p>Produces a special query document of the modified properties used in updates.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype._delta = <span class="function"><span class="keyword">function</span> <span class="title">_delta</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> dirty = <span class="keyword">this</span>._dirty();
  <span class="keyword">if</span> (!dirty.length) <span class="keyword">return</span>;

  <span class="keyword">var</span> self = <span class="keyword">this</span>
    , where = {}
    , delta = {}
    , len = dirty.length
    , d = <span class="number">0</span>
    , val
    , obj

  <span class="keyword">for</span> (; d &lt; len; ++d) {
    <span class="keyword">var</span> data = dirty[d]
    <span class="keyword">var</span> value = data.value
    <span class="keyword">var</span> schema = data.schema

    <span class="keyword">if</span> (<span class="literal">undefined</span> === value) {
      operand(self, where, delta, data, <span class="number">1</span>, <span class="string">'$unset'</span>);

    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> === value) {
      operand(self, where, delta, data, <span class="literal">null</span>);

    } <span class="keyword">else</span> <span class="keyword">if</span> (value._path &amp;&amp; value._registerAtomic) {
      handleMongooseArray(self, where, delta, data, value);

    } <span class="keyword">else</span> <span class="keyword">if</span> (value._path &amp;&amp; value.write &amp;&amp; value.toObject) {
      <span class="comment">// MongooseBuffer</span>
      value = value.toObject();
      operand(self, where, delta, data, value);

    } <span class="keyword">else</span> {
      <span class="comment">// nested object literal</span>
      value = utils.clone(value);
      operand(self, where, delta, data, value);
    }
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.__version) {
    <span class="keyword">this</span>._version(where, delta);
  }

  <span class="keyword">return</span> [where, delta];
}</code></pre></div></div><hr class="private"><div class="method private"><h3 id="Model-_version">Model#_version()</h3><p>Appends versioning to the where and update clauses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype._version = <span class="function"><span class="keyword">function</span> <span class="title">_version</span> <span class="params">(where, delta)</span> {</span>
  <span class="keyword">var</span> key = <span class="keyword">this</span>.schema.options.versionKey;

  <span class="keyword">if</span> (<span class="literal">true</span> === where) {
    <span class="comment">// this is an insert</span>
    <span class="keyword">if</span> (key) <span class="keyword">this</span>.setValue(key, delta[key] = <span class="number">0</span>);
    <span class="keyword">return</span>;
  }

  <span class="comment">// updates</span>

  <span class="comment">// only apply versioning if our versionKey was selected. else</span>
  <span class="comment">// there is no way to select the correct version. we could fail</span>
  <span class="comment">// fast here and force them to include the versionKey but</span>
  <span class="comment">// thats a bit intrusive. can we do this automatically?</span>
  <span class="comment">// TODO fail fast option?</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.isSelected(key)) {
    <span class="keyword">return</span>;
  }

  <span class="comment">// $push $addToSet don't need the where clause set</span>
  <span class="keyword">if</span> (VERSION_WHERE === (VERSION_WHERE &amp; <span class="keyword">this</span>.__version)) {
    where[key] = <span class="keyword">this</span>.getValue(key);
  }

  <span class="keyword">if</span> (VERSION_INC === (VERSION_INC &amp; <span class="keyword">this</span>.__version)) {
    delta.$inc || (delta.$inc = {});
    delta.$inc[key] = <span class="number">1</span>;
  }
}</code></pre></div></div><hr class="private"><div class="method "><h3 id="Model-increment">Model#increment()</h3><p>Signal that we desire an increment of<br />this documents version.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.increment = <span class="function"><span class="keyword">function</span> <span class="title">increment</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.__version = VERSION_ALL;
  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div></div><hr class=""><div class="method private"><h3 id="Model-_where">Model#_where()</h3><p>Returns a query object which applies shardkeys if they exist.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype._where = <span class="function"><span class="keyword">function</span> <span class="title">_where</span> <span class="params">(where)</span> {</span>
  where || (where = {});

  <span class="keyword">var</span> paths
    , len

  <span class="keyword">if</span> (<span class="keyword">this</span>._shardval) {
    paths = Object.keys(<span class="keyword">this</span>._shardval)
    len = paths.length

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) {
      where[paths[i]] = <span class="keyword">this</span>._shardval[paths[i]];
    }
  }

  where._id = <span class="keyword">this</span>._doc._id;
  <span class="keyword">return</span> where;
}</code></pre></div></div><hr class="private"><div class="method "><h3 id="Model-remove">Model#remove(<code>[fn]</code>)</h3><p>Remove the document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.remove = <span class="function"><span class="keyword">function</span> <span class="title">remove</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._removing) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">var</span> promise = <span class="keyword">this</span>._removing = <span class="keyword">new</span> Promise(fn)
    , where = <span class="keyword">this</span>._where()
    , self = <span class="keyword">this</span>
    , options = {}

  <span class="keyword">if</span> (<span class="keyword">this</span>.schema.options.safe) {
    options.safe = <span class="keyword">this</span>.schema.options.safe;
  }

  <span class="keyword">this</span>.collection.remove(where, options, tick(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
    <span class="keyword">if</span> (err) {
      promise.error(err);
      promise = self = self._removing = where = options = <span class="literal">null</span>;
      <span class="keyword">return</span>;
    }
    promise.complete();
    self.emit(<span class="string">'remove'</span>, self);
    promise = self = where = options = <span class="literal">null</span>;
  }));

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>optional callback</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="Model-_registerHooks">Model#_registerHooks()</h3><p>Register hooks override</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype._registerHooks = <span class="function"><span class="keyword">function</span> <span class="title">registerHooks</span> <span class="params">()</span> {</span>
  Document.prototype._registerHooks.call(<span class="keyword">this</span>);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="Model-model">Model#model(<code>name</code>)</h3><p>Shortcut to access another model.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.model = <span class="function"><span class="keyword">function</span> <span class="title">model</span> <span class="params">(name)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.db.model(name);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>model name</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="function Object() { [native code] }-init">function Object() { [native code] }#init()</h3><p>Called when the model compiles</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.init = <span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.schema.options.autoIndex)
    <span class="keyword">this</span>.ensureIndexes();

  <span class="keyword">this</span>.schema.emit(<span class="string">'init'</span>, <span class="keyword">this</span>);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="function Object() { [native code] }-ensureIndexes">function Object() { [native code] }#ensureIndexes(<code>[cb]</code>)</h3><p>Sends <code>ensureIndex</code> commands to mongo for each index declared in the schema.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.ensureIndexes = <span class="function"><span class="keyword">function</span> <span class="title">ensureIndexes</span> <span class="params">(cb)</span> {</span>
  <span class="keyword">var</span> indexes = <span class="keyword">this</span>.schema.indexes();
  <span class="keyword">if</span> (!indexes.length) {
    <span class="keyword">return</span> cb &amp;&amp; cb();
  }

  <span class="keyword">var</span> self = <span class="keyword">this</span>
    , safe = self.schema.options.safe
    , count = indexes.length
    , error

  indexes.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(index)</span> {</span>
    <span class="keyword">var</span> options = index[<span class="number">1</span>];
    options.safe = safe;
    self.collection.ensureIndex(index[<span class="number">0</span>], options, tick(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      <span class="keyword">if</span> (err) error = err;
      <span class="keyword">if</span> (--count) <span class="keyword">return</span>;

      self.emit(<span class="string">'index'</span>, error);
      cb &amp;&amp; cb(error);
    }));
  });
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[cb]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>optional callback</span></li></ul></div></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Document schema</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.schema;</code></pre></div></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Database instance the model uses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.db;</code></pre></div></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Collection the model uses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.collection;</code></pre></div></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Base Mongoose instance for the model.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.base;</code></pre></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-remove">function Object() { [native code] }#remove(<code>conditions</code>, <code>[callback]</code>)</h3><p>Removes documents from the collection.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.remove = <span class="function"><span class="keyword">function</span> <span class="title">remove</span> <span class="params">(conditions, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> conditions) {
    callback = conditions;
    conditions = {};
  }

  <span class="keyword">var</span> query = <span class="keyword">new</span> Query(conditions).bind(<span class="keyword">this</span>, <span class="string">'remove'</span>);

  <span class="keyword">if</span> (<span class="string">'undefined'</span> === <span class="keyword">typeof</span> callback)
    <span class="keyword">return</span> query;

  <span class="keyword">this</span>._applyNamedScope(query);
  <span class="keyword">return</span> query.remove(callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-find">function Object() { [native code] }#find(<code>conditions</code>, <code>[fields]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Finds documents</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.find = <span class="function"><span class="keyword">function</span> <span class="title">find</span> <span class="params">(conditions, fields, options, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> conditions) {
    callback = conditions;
    conditions = {};
    fields = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> fields) {
    callback = fields;
    fields = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> options) {
    callback = options;
    options = <span class="literal">null</span>;
  }

  <span class="keyword">var</span> query = <span class="keyword">new</span> Query(conditions, options);
  query.bind(<span class="keyword">this</span>, <span class="string">'find'</span>);
  query.select(fields);

  <span class="keyword">if</span> (<span class="string">'undefined'</span> === <span class="keyword">typeof</span> callback)
    <span class="keyword">return</span> query;

  <span class="keyword">this</span>._applyNamedScope(query);
  <span class="keyword">return</span> query.find(callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[fields]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional fields to select</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><h2>Examples</h2>

<p>// retrieve only certain keys<br />   MyModel.find({ name: /john/i }, 'name friends', function () { })</p>

<p>// pass options<br />   MyModel.find({ name: /john/i }, null, { skip: 10 } )</p></div><hr class=""><div class="method private"><h3 id="function Object() { [native code] }-_applyNamedScope">function Object() { [native code] }#_applyNamedScope(<code>query</code>)</h3><p>Merges the current named scope query into <code>query</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model._applyNamedScope = <span class="function"><span class="keyword">function</span> <span class="title">_applyNamedScope</span> <span class="params">(query)</span> {</span>
  <span class="keyword">var</span> cQuery = <span class="keyword">this</span>._cumulativeQuery;

  <span class="keyword">if</span> (cQuery) {
    merge(query._conditions, cQuery._conditions);
    <span class="keyword">if</span> (query._fields &amp;&amp; cQuery._fields)
      merge(query._fields, cQuery._fields);
    <span class="keyword">if</span> (query.options &amp;&amp; cQuery.options)
      merge(query.options, cQuery.options);
    <span class="keyword">delete</span> <span class="keyword">this</span>._cumulativeQuery;
  }

  <span class="keyword">return</span> query;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>query</code><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="function Object() { [native code] }-findById">function Object() { [native code] }#findById(<code>id</code>, <code>[fields]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Finds by id</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findById = <span class="function"><span class="keyword">function</span> <span class="title">findById</span> <span class="params">(id, fields, options, callback)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.findOne({ _id: id }, fields, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="#ObjectId">ObjectId</a>, <a href="#HexId">HexId</a>&gt; </span><span>objectid, or a value that can be casted to one</span></li><li><code>[fields]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional fields to select</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-findOne">function Object() { [native code] }#findOne(<code>conditions</code>, <code>[fields]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Finds one document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findOne = <span class="function"><span class="keyword">function</span> <span class="title">findOne</span> <span class="params">(conditions, fields, options, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> options) {
    <span class="comment">// TODO Handle all 3 of the following scenarios</span>
    <span class="comment">// Hint: Only some of these scenarios are possible if cQuery is present</span>
    <span class="comment">// Scenario: findOne(conditions, fields, callback);</span>
    <span class="comment">// Scenario: findOne(fields, options, callback);</span>
    <span class="comment">// Scenario: findOne(conditions, options, callback);</span>
    callback = options;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> fields) {
    <span class="comment">// TODO Handle all 2 of the following scenarios</span>
    <span class="comment">// Scenario: findOne(conditions, callback)</span>
    <span class="comment">// Scenario: findOne(fields, callback)</span>
    <span class="comment">// Scenario: findOne(options, callback);</span>
    callback = fields;
    fields = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> conditions) {
    callback = conditions;
    conditions = {};
    fields = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  }

  <span class="keyword">var</span> query = <span class="keyword">new</span> Query(conditions, options).select(fields).bind(<span class="keyword">this</span>, <span class="string">'findOne'</span>);

  <span class="keyword">if</span> (<span class="string">'undefined'</span> == <span class="keyword">typeof</span> callback)
    <span class="keyword">return</span> query;

  <span class="keyword">this</span>._applyNamedScope(query);
  <span class="keyword">return</span> query.findOne(callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[fields]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional fields to select</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-count">function Object() { [native code] }#count(<code>conditions</code>, <code>[callback]</code>)</h3><p>Counts documents</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.count = <span class="function"><span class="keyword">function</span> <span class="title">count</span> <span class="params">(conditions, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> conditions)
    callback = conditions, conditions = {};

  <span class="keyword">var</span> query = <span class="keyword">new</span> Query(conditions).bind(<span class="keyword">this</span>, <span class="string">'count'</span>);
  <span class="keyword">if</span> (<span class="string">'undefined'</span> == <span class="keyword">typeof</span> callback)
    <span class="keyword">return</span> query;

  <span class="keyword">this</span>._applyNamedScope(query);
  <span class="keyword">return</span> query.count(callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-distinct">function Object() { [native code] }#distinct(<code>field</code>, <code>[conditions]</code>, <code>[callback]</code>)</h3><p>Executes a DISTINCT command</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.distinct = <span class="function"><span class="keyword">function</span> <span class="title">distinct</span> <span class="params">(field, conditions, callback)</span> {</span>
  <span class="keyword">var</span> query = <span class="keyword">new</span> Query(conditions).bind(<span class="keyword">this</span>, <span class="string">'distinct'</span>);
  <span class="keyword">if</span> (<span class="string">'undefined'</span> == <span class="keyword">typeof</span> callback) {
    query._distinctArg = field;
    <span class="keyword">return</span> query;
  }

  <span class="keyword">this</span>._applyNamedScope(query);
  <span class="keyword">return</span> query.distinct(field, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>field</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-where">function Object() { [native code] }#where(<code>path</code>, <code>[val]</code>)</h3><p>Creates a Query, applies the passed conditions, and returns the Query.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.where = <span class="function"><span class="keyword">function</span> <span class="title">where</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">var</span> q = <span class="keyword">new</span> Query().bind(<span class="keyword">this</span>, <span class="string">'find'</span>);
  <span class="keyword">return</span> q.where.apply(q, arguments);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[val]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional value</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><p>For example, instead of writing:</p>

<pre><code>User.find({age: {$gte: <span class="number">21</span>, $lte: <span class="number">65</span>}}, callback);</code></pre>

<p>we can instead write:</p>

<pre><code>User.where(<span class="string">'age'</span>).gte(<span class="number">21</span>).lte(<span class="number">65</span>).exec(callback);</code></pre>

<p>Since the Query class also supports <code>where</code> you can continue chaining</p>

<pre><code>User</code></pre>

<p>.where('age').gte(21).lte(65)<br />   .where('name', /^b/i)<br />   ... etc</p></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Sometimes you need to query for things in mongodb using a JavaScript<br />expression. You can do so via find({$where: javascript}), or you can<br />use the mongoose shortcut method $where via a Query chain or from<br />your mongoose Model.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.$where = <span class="function"><span class="keyword">function</span> <span class="title">$where</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> q = <span class="keyword">new</span> Query().bind(<span class="keyword">this</span>, <span class="string">'find'</span>);
  <span class="keyword">return</span> q.$where.apply(q, arguments);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>argument</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>is a javascript string or anonymous function</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-findOneAndUpdate">function Object() { [native code] }#findOneAndUpdate(<code>[conditions]</code>, <code>[update]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Issues a mongodb findAndModify update command.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findOneAndUpdate = function (conditions, update, options, callback) {
  if ('function' == typeof options) {
    callback = options;
    options = null;
  }
  else if (1 === arguments.length) {
    if ('function' == typeof conditions) {
      var msg = 'Model.findOneAndUpdate(): First argument must not be a function.

'
              + '  ' + this.modelName + '.findOneAndUpdate(conditions, update, options, callback)
'
              + '  ' + this.modelName + '.findOneAndUpdate(conditions, update, options)
'
              + '  ' + this.modelName + '.findOneAndUpdate(conditions, update)
'
              + '  ' + this.modelName + '.findOneAndUpdate(update)
'
              + '  ' + this.modelName + '.findOneAndUpdate()
';
      throw new TypeError(msg)
    }
    update = conditions;
    conditions = undefined;
  }

  var fields;
  if (options &amp;&amp; options.fields) {
    fields = options.fields;
    options.fields = undefined;
  }

  var query = new Query(conditions, options);
  query.select(fields);
  query.bind(this, 'findOneAndUpdate', update);

  if ('undefined' == typeof callback)
    return query;

  this._applyNamedScope(query);
  return query.findOneAndUpdate(callback);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[update]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><p>Finds a matching document, updates it according to the <code>update</code><br />arg, passing any <code>options</code>, and returns the found document<br />(if any) to the callback. The query executes immediately if<br /><code>callback</code> is passed else a Query object is returned.</p>

<h2>Available options</h2>

<ul>
<li><code>new</code>: bool - true to return the modified document rather than the original. defaults to true</li>
<li><code>upsert</code>: bool - creates the object if it doesn't exist. defaults to false.</li>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
</ul>

<h2>Examples</h2>

<pre><code>A.findOneAndUpdate(conditions, update, options, callback) <span class="comment">// executes</span>
A.findOneAndUpdate(conditions, update, options)  <span class="comment">// returns Query</span>
A.findOneAndUpdate(conditions, update, callback) <span class="comment">// executes</span>
A.findOneAndUpdate(conditions, update)           <span class="comment">// returns Query</span>
A.findOneAndUpdate()                             <span class="comment">// returns Query</span></code></pre></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-findByIdAndUpdate">function Object() { [native code] }#findByIdAndUpdate(<code>id</code>, <code>[update]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Issue a mongodb findAndModify update command by a documents id.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findByIdAndUpdate = function (id, update, options, callback) {
  var args;

  if (1 === arguments.length) {
    if ('function' == typeof id) {
      var msg = 'Model.findByIdAndUpdate(): First argument must not be a function.

'
                + '  ' + this.modelName + '.findByIdAndUpdate(id, callback)
'
                + '  ' + this.modelName + '.findByIdAndUpdate(id)
'
                + '  ' + this.modelName + '.findByIdAndUpdate()
';
      throw new TypeError(msg)
    }
    return this.findOneAndUpdate({_id: id }, undefined);
  }

  args = utils.args(arguments, 1);
  args.unshift({ _id: id });
  return this.findOneAndUpdate.apply(this, args);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="#ObjectId">ObjectId</a>, <a href="#HexId">HexId</a>&gt; </span><span>an ObjectId or string that can be cast to one.</span></li><li><code>[update]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#Model.findOneAndUpdate" title="Model.findOneAndUpdate">Model.findOneAndUpdate</a></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-findOneAndRemove">function Object() { [native code] }#findOneAndRemove(<code>conditions</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Issue a mongodb findAndModify remove command.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findOneAndRemove = function (conditions, options, callback) {
  if (1 === arguments.length &amp;&amp; 'function' == typeof conditions) {
    var msg = 'Model.findOneAndRemove(): First argument must not be a function.

'
              + '  ' + this.modelName + '.findOneAndRemove(conditions, callback)
'
              + '  ' + this.modelName + '.findOneAndRemove(conditions)
'
              + '  ' + this.modelName + '.findOneAndRemove()
';
    throw new TypeError(msg)
  }

  if ('function' == typeof options) {
    callback = options;
    options = undefined;
  }

  var fields;
  if (options) {
    fields = options.select;
    options.select = undefined;
  }

  var query = new Query(conditions, options);
  query.bind(this, 'findOneAndRemove');
  query.select(fields);

  if ('undefined' == typeof callback)
    return query;

  this._applyNamedScope(query);
  return query.findOneAndRemove(callback);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><p>Finds a matching document, removes it, passing the found<br />document (if any) to the callback. Executes immediately if <code>callback</code><br />is passed else a Query object is returned.</p>

<h2>Available options</h2>

<ul>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
</ul>

<h2>Examples</h2>

<pre><code>A.findOneAndRemove(conditions, options, callback) <span class="comment">// executes</span>
A.findOneAndRemove(conditions, options)  <span class="comment">// return Query</span>
A.findOneAndRemove(conditions, callback) <span class="comment">// executes</span>
A.findOneAndRemove(conditions) <span class="comment">// returns Query</span>
A.findOneAndRemove()           <span class="comment">// returns Query</span></code></pre></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-findByIdAndRemove">function Object() { [native code] }#findByIdAndRemove(<code>id</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>findByIdAndRemove</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findByIdAndRemove = function (id, options, callback) {
  if (1 === arguments.length &amp;&amp; 'function' == typeof id) {
    var msg = 'Model.findByIdAndRemove(): First argument must not be a function.

'
              + '  ' + this.modelName + '.findByIdAndRemove(id, callback)
'
              + '  ' + this.modelName + '.findByIdAndRemove(id)
'
              + '  ' + this.modelName + '.findByIdAndRemove()
';
    throw new TypeError(msg)
  }

  return this.findOneAndRemove({ _id: id }, options, callback);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="#ObjectId">ObjectId</a>, <a href="#HexString">HexString</a>&gt; </span><span>ObjectId or string that can be cast to one</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#Model.findOneAndRemove" title="Model.findOneAndRemove">Model.findOneAndRemove</a></li></ul></div><p>Issue a mongodb findAndModify remove command by a documents id.</p></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-create">function Object() { [native code] }#create(<code>doc</code>, <code>fn</code>)</h3><p>Shortcut for creating a new Document that is automatically saved to the db if valid.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.create = <span class="function"><span class="keyword">function</span> <span class="title">create</span> <span class="params">(doc, fn)</span> {</span>
  <span class="keyword">if</span> (<span class="number">1</span> === arguments.length) {
    <span class="keyword">return</span> <span class="string">'function'</span> === <span class="keyword">typeof</span> doc &amp;&amp; doc(<span class="literal">null</span>);
  }

  <span class="keyword">var</span> self = <span class="keyword">this</span>
    , docs = [<span class="literal">null</span>]
    , promise
    , count
    , args

  <span class="keyword">if</span> (Array.isArray(doc)) {
    args = doc;
  } <span class="keyword">else</span> {
    args = utils.args(arguments, <span class="number">0</span>, arguments.length - <span class="number">1</span>);
    fn = arguments[arguments.length - <span class="number">1</span>];
  }

  <span class="keyword">if</span> (<span class="number">0</span> === args.length) <span class="keyword">return</span> fn(<span class="literal">null</span>);

  promise = <span class="keyword">new</span> Promise(fn);
  count = args.length;

  args.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(arg, i)</span> {</span>
    <span class="keyword">var</span> doc = <span class="keyword">new</span> self(arg);
    docs[i+<span class="number">1</span>] = doc;
    doc.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      <span class="keyword">if</span> (err) <span class="keyword">return</span> promise.error(err);
      --count || fn.apply(<span class="literal">null</span>, docs);
    });
  });

  <span class="comment">// TODO</span>
  <span class="comment">// utilize collection.insertAll for batch processing?</span>
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>callback</span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-update">function Object() { [native code] }#update(<code>conditions</code>, <code>doc</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Updates documents.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.update = <span class="function"><span class="keyword">function</span> <span class="title">update</span> <span class="params">(conditions, doc, options, callback)</span> {</span>
  <span class="keyword">if</span> (arguments.length &lt; <span class="number">4</span>) {
    <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> options) {
      <span class="comment">// Scenario: update(conditions, doc, callback)</span>
      callback = options;
      options = <span class="literal">null</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> doc) {
      <span class="comment">// Scenario: update(doc, callback);</span>
      callback = doc;
      doc = conditions;
      conditions = {};
      options = <span class="literal">null</span>;
    }
  }

  <span class="keyword">var</span> query = <span class="keyword">new</span> Query(conditions, options).bind(<span class="keyword">this</span>, <span class="string">'update'</span>, doc);

  <span class="keyword">if</span> (<span class="string">'undefined'</span> == <span class="keyword">typeof</span> callback)
    <span class="keyword">return</span> query;

  <span class="keyword">this</span>._applyNamedScope(query);
  <span class="keyword">return</span> query.update(doc, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><h2>Examples</h2>

<pre><code>MyModel.update({ age: { $gt: <span class="number">18</span> } }, { oldEnough: <span class="literal">true</span> }, fn);
MyModel.update({ name: <span class="string">'Tobi'</span> }, { ferret: <span class="literal">true</span> }, { multi: <span class="literal">true</span> }, fn);</code></pre>

<h2>Valid options</h2>

<ul>
<li>safe (boolean) safe mode (defaults to value set in schema (true))</li>
<li>upsert (boolean) whether to create the doc if it doesn't match (false)</li>
<li>multi (boolean) whether multiple documents should be updated (false)</li>
</ul></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-mapReduce">function Object() { [native code] }#mapReduce(<code>o</code>, <code>callback</code>)</h3><p>mapReduce</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.mapReduce = <span class="function"><span class="keyword">function</span> <span class="title">mapReduce</span> <span class="params">(o, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> != <span class="keyword">typeof</span> callback) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'missing callback'</span>);

  <span class="keyword">var</span> self = <span class="keyword">this</span>;

  <span class="keyword">if</span> (!Model.mapReduce.schema) {
    <span class="keyword">var</span> opts = { noId: <span class="literal">true</span>, noVirtualId: <span class="literal">true</span>, strict: <span class="literal">false</span> }
    Model.mapReduce.schema = <span class="keyword">new</span> Schema({}, opts);
  }

  <span class="keyword">if</span> (!o.out) o.out = { inline: <span class="number">1</span> };

  o.map = String(o.map);
  o.reduce = String(o.reduce);

  <span class="keyword">this</span>.collection.mapReduce(<span class="literal">null</span>, <span class="literal">null</span>, o, <span class="function"><span class="keyword">function</span> <span class="params">(err, ret, stats)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);

    <span class="keyword">if</span> (ret.findOne &amp;&amp; ret.mapReduce) {
      <span class="comment">// returned a collection, convert to Model</span>
      <span class="keyword">var</span> model = Model.compile(
          <span class="string">'_mapreduce_'</span> + ret.collectionName
        , Model.mapReduce.schema
        , ret.collectionName
        , self.db
        , self.base);

      model._mapreduce = <span class="literal">true</span>;

      <span class="keyword">return</span> callback(err, model, stats);
    }

    callback(err, ret, stats);
  });
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>o</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><p>Executes a mapReduce command. <code>o</code> is an object specifying<br />all mapReduce options as well as the map and reduce functions.<br />All options are delegated to the driver implementation.</p>

<h2>Example</h2>

<pre><code><span class="keyword">var</span> o = {};
o.map = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> emit(<span class="keyword">this</span>.name, <span class="number">1</span>) }
o.reduce = <span class="function"><span class="keyword">function</span> <span class="params">(k, vals)</span> {</span> <span class="keyword">return</span> vals.length }
User.mapReduce(o, <span class="function"><span class="keyword">function</span> <span class="params">(err, results)</span> {</span>
  console.log(results)
})</code></pre>

<h2>Other options</h2>

<p>(@see <a href='http://www.mongodb.org/display/DOCS/MapReduce'>http://www.mongodb.org/display/DOCS/MapReduce</a> for more details)<br />  - query {Object} query filter object.<br />  - limit {Number} max number of documents<br />  - keeptemp {Boolean, default:false} keep temporary data<br />  - finalize {Function} finalize function<br />  - scope {Object} scope variables exposed to map/reduce/finalize during execution<br />  - jsMode {Boolean, default:false} it is possible to make the execution stay in JS. Provided in MongoDB > 2.0.X<br />  - verbose {Boolean, default:false} provide statistics on job execution time.<br />  - out {Object, default: {inline:1}} sets the output target for the map reduce job.<br />     {inline:1} the results are returned in an array<br />     {replace: 'collectionName'} add the results to collectionName: the results replace the collection<br />     {reduce: 'collectionName'} add the results to collectionName: if dups are detected, uses the reducer / finalize functions<br />     {merge: 'collectionName'} add the results to collectionName: if dups exist the new docs overwrite the old</p>

<p>If options.out is set to replace, merge, or reduce, a Model<br />instance is returned that can be used for further querying.<br />Queries run against this model are all executed with the <code>lean</code><br />option: meaning only the js object is returned and no<br />Mongoose magic is applied (getters, setters, etc).</p>

<h2>Example</h2>

<pre><code><span class="keyword">var</span> o = {};
o.map = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> emit(<span class="keyword">this</span>.name, <span class="number">1</span>) }
o.reduce = <span class="function"><span class="keyword">function</span> <span class="params">(k, vals)</span> {</span> <span class="keyword">return</span> vals.length }
o.out = { replace: <span class="string">'createdCollectionNameForResults'</span> }
o.verbose = <span class="literal">true</span>;
User.mapReduce(o, <span class="function"><span class="keyword">function</span> <span class="params">(err, model, stats)</span> {</span>
  console.log(<span class="string">'map reduce took %d ms'</span>, stats.processtime)
  model.find().where(<span class="string">'value'</span>).gt(<span class="number">10</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>
    console.log(docs);
  });
})</code></pre></div><hr class=""><div class="method private"><h3 id="function Object() { [native code] }-compile">function Object() { [native code] }#compile(<code>name</code>, <code>schema</code>, <code>collectionName</code>, <code>connection</code>, <code>base</code>)</h3><p>Compiler utility.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.compile = <span class="function"><span class="keyword">function</span> <span class="title">compile</span> <span class="params">(name, schema, collectionName, connection, base)</span> {</span>
  <span class="comment">// generate new class</span>
  <span class="function"><span class="keyword">function</span> <span class="title">model</span> <span class="params">(doc, fields, skipId)</span> {</span>
    <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> model))
      <span class="keyword">return</span> <span class="keyword">new</span> model(doc, fields, skipId);
    Model.call(<span class="keyword">this</span>, doc, fields, skipId);
  };

  model.modelName = name;
  model.__proto__ = Model;
  model.prototype.__proto__ = Model.prototype;
  model.prototype.db = connection;
  model.prototype._setSchema(schema);
  model.prototype.collection = connection.collection(
      collectionName
    , schema.options.capped
  );

  <span class="comment">// apply methods</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> schema.methods)
    model.prototype[i] = schema.methods[i];

  <span class="comment">// apply statics</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> schema.statics)
    model[i] = schema.statics[i];

  <span class="comment">// apply named scopes</span>
  <span class="keyword">if</span> (schema.namedScopes) schema.namedScopes.compile(model);

  model.model = model.prototype.model;
  model.options = model.prototype.options;
  model.db = model.prototype.db;
  model.schema = model.prototype.schema;
  model.collection = model.prototype.collection;
  model.base = base;

  <span class="keyword">return</span> model;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>model name</span></li><li><code>schema</code><span class="types"> &lt;<a href="#Schema">Schema</a>&gt; </span><span></span></li><li><code>collectionName</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>connection</code><span class="types"> &lt;<a href="#Connection">Connection</a>&gt; </span><span></span></li><li><code>base</code><span class="types"> &lt;<a href="#Mongoose">Mongoose</a>&gt; </span><span>mongoose instance</span></li></ul></div></div><hr class="private"><div class="property "><h3 id="Model-modelName">Model#<span>modelName</span></h3><p>The name of the model</p></div><hr><div class="property "><h3 id="Model-collection">Model#<span>collection</span></h3><p>Collection the model uses.</p></div><hr><div class="property "><h3 id="Model-db">Model#<span>db</span></h3><p>Connection the model uses.</p></div><hr></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/namedscope.js">lib/namedscope.js</a><div class="method private"><h3 id="NamedScope-decorate">NamedScope#decorate(<code>target</code>, <code>getters</code>)</h3><p>Decorate</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NamedScope.prototype.decorate = <span class="function"><span class="keyword">function</span> <span class="params">(target, getters)</span> {</span>
  <span class="keyword">var</span> name = <span class="keyword">this</span>.name
    , block = <span class="keyword">this</span>.block
    , query = <span class="keyword">this</span>.query;
  <span class="keyword">if</span> (block) {
    <span class="keyword">if</span> (block.length === <span class="number">0</span>) {
      Object.defineProperty(target, name, {
        get: getters.block0(block)
      });
    } <span class="keyword">else</span> {
      target[name] = getters.blockN(block);
    }
  } <span class="keyword">else</span> {
    Object.defineProperty(target, name, {
      get: getters.basic(query)
    });
  }
};

NamedScope.prototype.compile = <span class="function"><span class="keyword">function</span> <span class="params">(model)</span> {</span>
  <span class="keyword">var</span> allScopes = <span class="keyword">this</span>.scopesByName
    , scope;
  <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> allScopes) {
    scope = allScopes[k];
    scope.decorate(model, {
      block0: <span class="function"><span class="keyword">function</span> <span class="params">(block)</span> {</span>
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">var</span> cquery = <span class="keyword">this</span>._cumulativeQuery || (<span class="keyword">this</span>._cumulativeQuery = <span class="keyword">new</span> Query().bind(<span class="keyword">this</span>));
          block.call(cquery);
          <span class="keyword">return</span> <span class="keyword">this</span>;
        };
      },
      blockN: <span class="function"><span class="keyword">function</span> <span class="params">(block)</span> {</span>
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">var</span> cquery = <span class="keyword">this</span>._cumulativeQuery || (<span class="keyword">this</span>._cumulativeQuery = <span class="keyword">new</span> Query().bind(<span class="keyword">this</span>));
          block.apply(cquery, arguments);
          <span class="keyword">return</span> <span class="keyword">this</span>;
        };
      },
      basic: <span class="function"><span class="keyword">function</span> <span class="params">(query)</span> {</span>
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">var</span> cquery = <span class="keyword">this</span>._cumulativeQuery || (<span class="keyword">this</span>._cumulativeQuery = <span class="keyword">new</span> Query().bind(<span class="keyword">this</span>));
          cquery.find(query);
          <span class="keyword">return</span> <span class="keyword">this</span>;
        };
      }
    });
  }
};

module.exports = NamedScope;</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>target</code><span class="types"> &lt;<a href="#NamedScope">NamedScope</a>&gt; </span><span></span></li><li><code>getters</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/promise.js">lib/promise.js</a><div class="method "><h3 id="Promise">Promise(<code>a</code>)</h3><p>Promise constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span> <span class="params">(back)</span> {</span>
  <span class="keyword">this</span>.emitted = {};
  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> back)
    <span class="keyword">this</span>.addBack(back);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>a</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>callback+errback that takes err, ... as signature</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Promise">Promise()</h3><p>Inherits from EventEmitter.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.__proto__ = EventEmitter.prototype;</code></pre></div></div><hr class=""><div class="method "><h3 id="Promise-on">Promise#on()</h3><p>Adds an event or fires the callback right away.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.on = <span class="function"><span class="keyword">function</span> <span class="params">(event, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.emitted[event])
    callback.apply(<span class="keyword">this</span>, <span class="keyword">this</span>.emitted[event]);
  <span class="keyword">else</span>
    EventEmitter.prototype.on.call(<span class="keyword">this</span>, event, callback);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise">promise</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method private"><h3 id="Promise-emit">Promise#emit()</h3><p>Keeps track of emitted events to run them on <code>on</code></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.emit = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
  <span class="comment">// ensures a promise can't be complete() or error() twice</span>
  <span class="keyword">if</span> (event == <span class="string">'err'</span> || event == <span class="string">'complete'</span>){
    <span class="keyword">if</span> (<span class="keyword">this</span>.emitted.err || <span class="keyword">this</span>.emitted.complete) {
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }
    <span class="keyword">this</span>.emitted[event] = util.args(arguments, <span class="number">1</span>);
  }

  <span class="keyword">return</span> EventEmitter.prototype.emit.apply(<span class="keyword">this</span>, arguments);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="Promise-complete">Promise#complete()</h3><p>Shortcut for emitting complete event</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.complete = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> args = util.args(arguments);
  <span class="keyword">return</span> <span class="keyword">this</span>.emit.apply(<span class="keyword">this</span>, [<span class="string">'complete'</span>].concat(args));
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Promise-error">Promise#error()</h3><p>Shortcut for emitting err event</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.error = <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="keyword">if</span> (!(err <span class="keyword">instanceof</span> Error)) err = <span class="keyword">new</span> Error(err);
  <span class="keyword">return</span> <span class="keyword">this</span>.emit(<span class="string">'err'</span>, err);
};</code></pre></div></div><hr class=""><div class="method "><h3 id="Promise-addCallback">Promise#addCallback()</h3><p>Shortcut for <code>.on('complete', fn)</code></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.addCallback = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.on(<span class="string">'complete'</span>, fn);
};</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise">promise</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Promise-addErrback">Promise#addErrback()</h3><p>Shortcut for <code>.on('err', fn)</code></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.addErrback = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.on(<span class="string">'err'</span>, fn);
};</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise">promise</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method private"><h3 id="Promise-addBack">Promise#addBack()</h3><p>Adds a single function that's both callback and errback</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.addBack = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">this</span>.on(<span class="string">'err'</span>, <span class="keyword">function</span>(err){
    fn.call(<span class="keyword">this</span>, err);
  });

  <span class="keyword">this</span>.on(<span class="string">'complete'</span>, <span class="keyword">function</span>(){
    <span class="keyword">var</span> args = util.args(arguments);
    fn.apply(<span class="keyword">this</span>, [<span class="literal">null</span>].concat(args));
  });

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise">promise</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Promise-resolve">Promise#resolve(<code>optional</code>, <code>value</code>)</h3><p>Sugar for handling cases where you may be<br />resolving to either an error condition or a <br />success condition.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.resolve = <span class="function"><span class="keyword">function</span> <span class="params">(err, val)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="keyword">this</span>.error(err);
  <span class="keyword">return</span> <span class="keyword">this</span>.complete(val);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>optional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>error or null</span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to complete the promise with</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Promise-resolve">Promise#resolve()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = Promise;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/query.js">lib/query.js</a><div class="method private"><h3 id="Query">Query()</h3><p>Query constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Query</span> <span class="params">(criteria, options)</span> {</span>
  <span class="keyword">this</span>.setOptions(options, <span class="literal">true</span>);
  <span class="keyword">this</span>._conditions = {};
  <span class="keyword">this</span>._updateArg = {};
  <span class="keyword">if</span> (criteria) <span class="keyword">this</span>.find(criteria);
}</code></pre></div></div><hr class="private"><div class="method "><h3 id="Query-setOptions">Query#setOptions(<code>options</code>)</h3><p>Sets query options.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.setOptions = <span class="function"><span class="keyword">function</span> <span class="params">(options, overwrite)</span> {</span>
  <span class="comment">// overwrite is internal use only</span>
  <span class="keyword">if</span> (overwrite) {
    options = <span class="keyword">this</span>.options = options || {};
    <span class="keyword">this</span>.safe = options.safe

    <span class="comment">// normalize population options</span>
    <span class="keyword">var</span> pop = <span class="keyword">this</span>.options.populate;
    <span class="keyword">this</span>.options.populate = {};

    <span class="keyword">if</span> (pop &amp;&amp; Array.isArray(pop)) {
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = pop.length; i &lt; l; i++) {
        <span class="keyword">this</span>.options.populate[pop[i]] = {};
      }
    }

    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">if</span> (!(options &amp;&amp; <span class="string">'Object'</span> == options.constructor.name))
    <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">if</span> (<span class="string">'safe'</span> <span class="keyword">in</span> options)
    <span class="keyword">this</span>.safe = options.safe;

  <span class="comment">// set arbitrary options</span>
  <span class="keyword">var</span> methods = Object.keys(options)
    , i = methods.length
    , method

  <span class="keyword">while</span> (i--) {
    method = methods[i];

    <span class="comment">// use methods if exist (safer option manipulation)</span>
    <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="keyword">this</span>[method]) {
      <span class="keyword">var</span> args = Array.isArray(options[method])
        ? options[method]
        : [options[method]];
      <span class="keyword">this</span>[method].apply(<span class="keyword">this</span>, args)
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.options[method] = options[method];
    }
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Query-bind">Query#bind(<code>model</code>, <code>op</code>, <code>updateArg</code>)</h3><p>Binds this query to a model.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.bind = <span class="function"><span class="keyword">function</span> <span class="title">bind</span> <span class="params">(model, op, updateArg)</span> {</span>
  <span class="keyword">this</span>.model = model;
  <span class="keyword">this</span>.op = op;

  <span class="keyword">if</span> (model._mapreduce) <span class="keyword">this</span>.options.lean = <span class="literal">true</span>;

  <span class="keyword">if</span> (op == <span class="string">'update'</span> || op == <span class="string">'findOneAndUpdate'</span>) {
    merge(<span class="keyword">this</span>._updateArg, updateArg || {});
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>model</code><span class="types"> &lt;<a href="#Model">Model</a>&gt; </span><span>the model to which the query is bound</span></li><li><code>op</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the operation to execute</span></li><li><code>updateArg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>used in update methods</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Query-exec">Query#exec(<code>[operation]</code>, <code>[callback]</code>)</h3><p>Executes the query</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.exec = <span class="function"><span class="keyword">function</span> <span class="title">exec</span> <span class="params">(op, callback)</span> {</span>
  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise();

  <span class="keyword">switch</span> (<span class="keyword">typeof</span> op) {
    <span class="keyword">case</span> <span class="string">'function'</span>:
      callback = op;
      op = <span class="literal">null</span>;
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">'string'</span>:
      <span class="keyword">this</span>.op = op;
      <span class="keyword">break</span>;
  }

  <span class="keyword">if</span> (callback) promise.addBack(callback);

  <span class="keyword">if</span> (!<span class="keyword">this</span>.op) {
    promise.complete();
    <span class="keyword">return</span> promise;
  }

  <span class="keyword">if</span> (<span class="string">'update'</span> == <span class="keyword">this</span>.op) {
    <span class="keyword">this</span>[<span class="keyword">this</span>.op](<span class="keyword">this</span>._updateArg, promise.resolve.bind(promise));
    <span class="keyword">return</span> promise;
  }

  <span class="keyword">if</span> (<span class="string">'distinct'</span> == <span class="keyword">this</span>.op) {
    <span class="keyword">this</span>.distinct(<span class="keyword">this</span>._distinctArg, promise.resolve.bind(promise));
    <span class="keyword">return</span> promise;
  }

  <span class="keyword">this</span>[<span class="keyword">this</span>.op](promise.resolve.bind(promise));
  <span class="keyword">return</span> promise;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[operation]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Promise">Promise</a>&gt; </span><span></span></li></ul></div><h4>Examples</h4>

<pre><code>query.exec();
query.exec(callback);
query.exec(<span class="string">'update'</span>);
query.exec(<span class="string">'find'</span>, callback);</code></pre></div><hr class=""><div class="method "><h3 id="Query-find">Query#find(<code>[criteria]</code>, <code>[callback]</code>)</h3><p>Finds documents.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.find = <span class="function"><span class="keyword">function</span> <span class="params">(criteria, callback)</span> {</span>
  <span class="keyword">this</span>.op = <span class="string">'find'</span>;
  <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> criteria) {
    callback = criteria;
    criteria = {};
  } <span class="keyword">else</span> <span class="keyword">if</span> (criteria <span class="keyword">instanceof</span> Query) {
    <span class="comment">// TODO Merge options, too</span>
    merge(<span class="keyword">this</span>._conditions, criteria._conditions);
  } <span class="keyword">else</span> <span class="keyword">if</span> (criteria <span class="keyword">instanceof</span> Document) {
    merge(<span class="keyword">this</span>._conditions, criteria.toObject());
  } <span class="keyword">else</span> <span class="keyword">if</span> (criteria &amp;&amp; <span class="string">'Object'</span> === criteria.constructor.name) {
    merge(<span class="keyword">this</span>._conditions, criteria);
  }
  <span class="keyword">if</span> (!callback) <span class="keyword">return</span> <span class="keyword">this</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>.execFind(callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[criteria]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>mongodb selector</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><p>When no <code>callback</code> is passed, the query is not executed.</p>

<h4>Example</h4>

<pre><code>query.find().find({ name: <span class="string">'Los Pollos'</span> }).find(callback)</code></pre></div><hr class=""><div class="method "><h3 id="Query-cast">Query#cast(<code>model</code>, <code>[obj]</code>)</h3><p>Casts this query to the schema of <code>model</code></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(model, obj)</span> {</span>
  obj || (obj= <span class="keyword">this</span>._conditions);

  <span class="keyword">var</span> schema = model.schema
    , paths = Object.keys(obj)
    , i = paths.length
    , any$conditionals
    , schematype
    , nested
    , path
    , type
    , val;

  <span class="keyword">while</span> (i--) {
    path = paths[i];
    val = obj[path];

    <span class="keyword">if</span> (<span class="string">'$or'</span> === path || <span class="string">'$nor'</span> === path) {
      <span class="keyword">var</span> k = val.length
        , orComponentQuery;

      <span class="keyword">while</span> (k--) {
        orComponentQuery = <span class="keyword">new</span> Query(val[k]);
        orComponentQuery.cast(model);
        val[k] = orComponentQuery._conditions;
      }

    } <span class="keyword">else</span> <span class="keyword">if</span> (path === <span class="string">'$where'</span>) {
      type = <span class="keyword">typeof</span> val;

      <span class="keyword">if</span> (<span class="string">'string'</span> !== type &amp;&amp; <span class="string">'function'</span> !== type) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Must have a string or function for $where"</span>);
      }

      <span class="keyword">if</span> (<span class="string">'function'</span> === type) {
        obj[path] = val.toString();
      }

      <span class="keyword">continue</span>;

    } <span class="keyword">else</span> {

      <span class="keyword">if</span> (!schema) {
        <span class="comment">// no casting for Mixed types</span>
        <span class="keyword">continue</span>;
      }

      schematype = schema.path(path);

      <span class="keyword">if</span> (!schematype) {
        <span class="comment">// Handle potential embedded array queries</span>
        <span class="keyword">var</span> split = path.split(<span class="string">'.'</span>)
          , j = split.length
          , pathFirstHalf
          , pathLastHalf
          , remainingConds
          , castingQuery;

        <span class="comment">// Find the part of the var path that is a path of the Schema</span>
        <span class="keyword">while</span> (j--) {
          pathFirstHalf = split.slice(<span class="number">0</span>, j).join(<span class="string">'.'</span>);
          schematype = schema.path(pathFirstHalf);
          <span class="keyword">if</span> (schematype) <span class="keyword">break</span>;
        }

        <span class="comment">// If a substring of the input path resolves to an actual real path...</span>
        <span class="keyword">if</span> (schematype) {
          <span class="comment">// Apply the casting; similar code for $elemMatch in schema/array.js</span>
          <span class="keyword">if</span> (schematype.caster &amp;&amp; schematype.caster.schema) {
            remainingConds = {};
            pathLastHalf = split.slice(j).join(<span class="string">'.'</span>);
            remainingConds[pathLastHalf] = val;
            castingQuery = <span class="keyword">new</span> Query(remainingConds);
            castingQuery.cast(schematype.caster);
            obj[path] = castingQuery._conditions[pathLastHalf];
          } <span class="keyword">else</span> {
            obj[path] = val;
          }
        }

      } <span class="keyword">else</span> <span class="keyword">if</span> (val === <span class="literal">null</span> || val === <span class="literal">undefined</span>) {
        <span class="keyword">continue</span>;
      } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'Object'</span> === val.constructor.name) {

        any$conditionals = Object.keys(val).some(<span class="function"><span class="keyword">function</span> <span class="params">(k)</span> {</span>
          <span class="keyword">return</span> k.charAt(<span class="number">0</span>) === <span class="string">'$'</span> &amp;&amp; k !== <span class="string">'$id'</span> &amp;&amp; k !== <span class="string">'$ref'</span>;
        });

        <span class="keyword">if</span> (!any$conditionals) {
          obj[path] = schematype.castForQuery(val);
        } <span class="keyword">else</span> {

          <span class="keyword">var</span> ks = Object.keys(val)
            , k = ks.length
            , $cond;

          <span class="keyword">while</span> (k--) {
            $cond = ks[k];
            nested = val[$cond];

            <span class="keyword">if</span> (<span class="string">'$exists'</span> === $cond) {
              <span class="keyword">if</span> (<span class="string">'boolean'</span> !== <span class="keyword">typeof</span> nested) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"$exists parameter must be Boolean"</span>);
              }
              <span class="keyword">continue</span>;
            }

            <span class="keyword">if</span> (<span class="string">'$type'</span> === $cond) {
              <span class="keyword">if</span> (<span class="string">'number'</span> !== <span class="keyword">typeof</span> nested) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"$type parameter must be Number"</span>);
              }
              <span class="keyword">continue</span>;
            }

            <span class="keyword">if</span> (<span class="string">'$not'</span> === $cond) {
              <span class="keyword">this</span>.cast(model, nested);
            } <span class="keyword">else</span> {
              val[$cond] = schematype.castForQuery($cond, nested);
            }
          }
        }
      } <span class="keyword">else</span> {
        obj[path] = schematype.castForQuery(val);
      }
    }
  }

  <span class="keyword">return</span> obj;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>model</code><span class="types"> &lt;<a href="#Model">Model</a>&gt; </span><span></span></li><li><code>[obj]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><h4>Note</h4>

<p>If <code>obj</code> is present, it is cast instead of this query.</p></div><hr class=""><div class="method private"><h3 id="Query-_optionsForExec">Query#_optionsForExec(<code>model</code>)</h3><p>Returns default options.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._optionsForExec = <span class="function"><span class="keyword">function</span> <span class="params">(model)</span> {</span>
  <span class="keyword">var</span> options = utils.clone(<span class="keyword">this</span>.options, { retainKeyOrder: <span class="literal">true</span> });
  <span class="keyword">delete</span> options.populate;
  <span class="keyword">if</span> (! (<span class="string">'safe'</span> <span class="keyword">in</span> options)) options.safe = model.schema.options.safe;
  <span class="keyword">return</span> options;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>model</code><span class="types"> &lt;<a href="#Model">Model</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Query-_applyPaths">Query#_applyPaths()</h3><p>Applies schematype selected options to this query.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._applyPaths = <span class="function"><span class="keyword">function</span> <span class="title">applyPaths</span> <span class="params">()</span> {</span>
  <span class="comment">// determine if query is selecting or excluding fields</span>

  <span class="keyword">var</span> fields = <span class="keyword">this</span>._fields
    , exclude
    , keys
    , ki

  <span class="keyword">if</span> (fields) {
    keys = Object.keys(fields);
    ki = keys.length;

    <span class="keyword">while</span> (ki--) {
      <span class="keyword">if</span> (<span class="string">'+'</span> == keys[ki][<span class="number">0</span>]) <span class="keyword">continue</span>;
      exclude = <span class="number">0</span> === fields[keys[ki]];
      <span class="keyword">break</span>;
    }
  }

  <span class="comment">// if selecting, apply default schematype select:true fields</span>
  <span class="comment">// if excluding, apply schematype select:false fields</span>

  <span class="keyword">var</span> selected = []
    , excluded = []

  <span class="keyword">this</span>.model.schema.eachPath(<span class="function"><span class="keyword">function</span> <span class="params">(path, type)</span> {</span>
    <span class="keyword">if</span> (<span class="string">'boolean'</span> != <span class="keyword">typeof</span> type.selected) <span class="keyword">return</span>;

    <span class="keyword">if</span> (fields &amp;&amp; (<span class="string">'+'</span> + path) <span class="keyword">in</span> fields) {
      <span class="comment">// forced inclusion</span>
      <span class="keyword">delete</span> fields[<span class="string">'+'</span> + path];

      <span class="comment">// if there are other fields being included, add this one</span>
      <span class="comment">// if no other included fields, leave this out (implied inclusion)</span>
      <span class="keyword">if</span> (<span class="literal">false</span> === exclude &amp;&amp; keys.length > <span class="number">1</span>) {
        fields[path] = <span class="number">1</span>;
      }

      <span class="keyword">return</span>
    };

    ;(type.selected ? selected : excluded).push(path);
  });

  <span class="keyword">switch</span> (exclude) {
    <span class="keyword">case</span> <span class="literal">true</span>:
      excluded.length &amp;&amp; <span class="keyword">this</span>.select(<span class="string">'-'</span> + excluded.join(<span class="string">' -'</span>));
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="literal">false</span>:
      selected.length &amp;&amp; <span class="keyword">this</span>.select(selected.join(<span class="string">' '</span>));
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="literal">undefined</span>:
      <span class="comment">// user didn't specify fields, implies returning all fields.</span>
      <span class="comment">// only need to apply excluded fields</span>
      excluded.length &amp;&amp; <span class="keyword">this</span>.select(<span class="string">'-'</span> + excluded.join(<span class="string">' -'</span>));
      <span class="keyword">break</span>;
  }
}</code></pre></div></div><hr class="private"><div class="method "><h3 id="Query-$where">Query#$where(<code>js</code>)</h3><p>Specifies a <code>$where</code> condition</p><div class="params"><h4>Parameters:</h4><ul><li><code>js</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>javascript string or function</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><p>Use <code>$where</code> when you need to select documents using a JavaScript expression.</p>

<h4>Example</h4>

<pre><code>query.$where(<span class="string">'this.comments.length &amp;gt; 10 || this.name.length &amp;gt; 5'</span>)

query.$where(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.comments.length &amp;gt; <span class="number">10</span> || <span class="keyword">this</span>.name.length &amp;gt; <span class="number">5</span>;
})</code></pre></div><hr class=""><div class="method "><h3 id="Query-where">Query#where(<code>[path]</code>, <code>[val]</code>)</h3><p>Specifies a <code>path</code> for use with chaining.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.where = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">if</span> (!arguments.length) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> path) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'path must be a string'</span>);
  }

  <span class="keyword">this</span>._currPath = path;

  <span class="keyword">if</span> (<span class="number">2</span> === arguments.length) {
    <span class="keyword">this</span>._conditions[path] = val;
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[val]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><h4>Example</h4>

<pre><code><span class="comment">// instead of writing:</span>
User.find({age: {$gte: <span class="number">21</span>, $lte: <span class="number">65</span>}}, callback);

<span class="comment">// we can instead write:</span>
User.where(<span class="string">'age'</span>).gte(<span class="number">21</span>).lte(<span class="number">65</span>);

<span class="comment">// Moreover, you can also chain a bunch of these together:</span>

User
.where(<span class="string">'age'</span>).gte(<span class="number">21</span>).lte(<span class="number">65</span>)
.where(<span class="string">'name'</span>, <span class="regexp">/^b/i</span>)
.where(<span class="string">'friends'</span>).slice(<span class="number">10</span>)
.exec(callback)</code></pre></div><hr class=""><div class="method "><h3 id="Query-equals">Query#equals(<code>val</code>)</h3><p>Specifies the complementary comparison value for paths specified with <code>where()</code></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.equals = <span class="function"><span class="keyword">function</span> <span class="title">equals</span> <span class="params">(val)</span> {</span>
  <span class="keyword">var</span> path = <span class="keyword">this</span>._currPath;
  <span class="keyword">if</span> (!path) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'equals() must be used after where()'</span>);
  <span class="keyword">this</span>._conditions[path] = val;
  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><h4>Example</h4>

<pre><code>User.where(<span class="string">'age'</span>).equals(<span class="number">49</span>);

<span class="comment">// is the same as</span>

User.where(<span class="string">'age'</span>, <span class="number">49</span>);</code></pre></div><hr class=""><div class="method "><h3 id="Query-or">Query#or(<code>array</code>)</h3><p>Specifies arguments for an <code>$or</code> condition.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.or = <span class="function"><span class="keyword">function</span> <span class="title">or</span> <span class="params">(array)</span> {</span>
  <span class="keyword">var</span> or = <span class="keyword">this</span>._conditions.$or || (<span class="keyword">this</span>._conditions.$or = []);
  <span class="keyword">if</span> (!Array.isArray(array)) array = [array];
  or.push.apply(or, array);
  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>array</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>array of conditions</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><h4>Example</h4>

<pre><code>query.or([{ color: <span class="string">'red'</span> }, { status: <span class="string">'emergency'</span> }])</code></pre></div><hr class=""><div class="method "><h3 id="Query-nor">Query#nor(<code>array</code>)</h3><p>Specifies arguments for a <code>$nor</code> condition.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.nor = <span class="function"><span class="keyword">function</span> <span class="title">nor</span> <span class="params">(array)</span> {</span>
  <span class="keyword">var</span> nor = <span class="keyword">this</span>._conditions.$nor || (<span class="keyword">this</span>._conditions.$nor = []);
  <span class="keyword">if</span> (!Array.isArray(array)) array = [array];
  nor.push.apply(nor, array);
  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>array</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>array of conditions</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><h4>Example</h4>

<pre><code>query.nor([{ color: <span class="string">'green'</span> }, { status: <span class="string">'ok'</span> }])</code></pre></div><hr class=""><div class="method "><h3 id="Query-gt">Query#gt(<code>path</code>, <code>val</code>)</h3><p>Specifies a $gt query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p>

<h4>Example</h4>

<pre><code>Thing.find().where(<span class="string">'age'</span>).gt(<span class="number">21</span>)

<span class="comment">// or</span>
Thing.find().gt(<span class="string">'age'</span>, <span class="number">21</span>)</code></pre></div><hr class=""><div class="method "><h3 id="Query-gte">Query#gte(<code>path</code>, <code>val</code>)</h3><p>Specifies a $gte query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-lt">Query#lt(<code>path</code>, <code>val</code>)</h3><p>Specifies a $lt query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-lte">Query#lte(<code>path</code>, <code>val</code>)</h3><p>Specifies a $lte query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-ne">Query#ne(<code>path</code>, <code>val</code>)</h3><p>Specifies a $ne query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-in">Query#in(<code>path</code>, <code>val</code>)</h3><p>Specifies an $in query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-nin">Query#nin(<code>path</code>, <code>val</code>)</h3><p>Specifies an $nin query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-all">Query#all(<code>path</code>, <code>val</code>)</h3><p>Specifies an $all query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-size">Query#size(<code>path</code>, <code>val</code>)</h3><p>Specifies an $size query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-regex">Query#regex(<code>path</code>, <code>val</code>)</h3><p>Specifies a $regex query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-maxDistance">Query#maxDistance(<code>path</code>, <code>val</code>)</h3><p>Specifies a $maxDistance query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""><div class="method "><h3 id="Query-near">Query#near(<code>path</code>, <code>val</code>)</h3><p>Specifies a <code>$near</code> condition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.near = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    val = path;
    path = <span class="keyword">this</span>._currPath
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">2</span> &amp;&amp; !Array.isArray(val)) {
    val = utils.args(arguments);
    path = <span class="keyword">this</span>._currPath;
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">3</span>) {
    val = utils.args(arguments, <span class="number">1</span>);
  }
  <span class="keyword">var</span> conds = <span class="keyword">this</span>._conditions[path] || (<span class="keyword">this</span>._conditions[path] = {});
  conds.$near = val;
  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Query-mod">Query#mod(<code>path</code>, <code>val</code>)</h3><p>Specifies a <code>$mod</code> condition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.mod = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    val = path;
    path = <span class="keyword">this</span>._currPath
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">2</span> &amp;&amp; !Array.isArray(val)) {
    val = utils.args(arguments);
    path = <span class="keyword">this</span>._currPath;
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">3</span>) {
    val = utils.args(arguments, <span class="number">1</span>);
  }
  <span class="keyword">var</span> conds = <span class="keyword">this</span>._conditions[path] || (<span class="keyword">this</span>._conditions[path] = {});
  conds.$mod = val;
  <span class="keyword">return</span> <span class="keyword">this</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Query-exists">Query#exists(<code>path</code>, <code>val</code>)</h3><p>Specifies an <code>$exists</code> condition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.exists = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">0</span>) {
    path = <span class="keyword">this</span>._currPath
    val = <span class="literal">true</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    <span class="keyword">if</span> (<span class="string">'boolean'</span> === <span class="keyword">typeof</span> path) {
      val = path;
      path = <span class="keyword">this</span>._currPath;
    } <span class="keyword">else</span> {
      val = <span class="literal">true</span>;
    }
  }
  <span class="keyword">var</span> conds = <span class="keyword">this</span>._conditions[path] || (<span class="keyword">this</span>._conditions[path] = {});
  conds[<span class="string">'$exists'</span>] = val;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Query-elemMatch">Query#elemMatch(<code>path</code>, <code>criteria</code>)</h3><p>Specifies an <code>$elemMatch</code> condition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.elemMatch = <span class="function"><span class="keyword">function</span> <span class="params">(path, criteria)</span> {</span>
  <span class="keyword">var</span> block;
  <span class="keyword">if</span> (<span class="string">'Object'</span> === path.constructor.name) {
    criteria = path;
    path = <span class="keyword">this</span>._currPath;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> path) {
    block = path;
    path = <span class="keyword">this</span>._currPath;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'Object'</span> === criteria.constructor.name) {
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> criteria) {
    block = criteria;
  } <span class="keyword">else</span> {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Argument error"</span>);
  }
  <span class="keyword">var</span> conds = <span class="keyword">this</span>._conditions[path] || (<span class="keyword">this</span>._conditions[path] = {});
  <span class="keyword">if</span> (block) {
    criteria = <span class="keyword">new</span> Query();
    block(criteria);
    conds[<span class="string">'$elemMatch'</span>] = criteria._conditions;
  } <span class="keyword">else</span> {
    conds[<span class="string">'$elemMatch'</span>] = criteria;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};

<span class="comment">// Spatial queries</span></code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li><li><code>criteria</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><h4>Example</h4>

<pre><code>query.elemMatch(<span class="string">'comment'</span>, { author: <span class="string">'autobot'</span>, votes: {$gte: <span class="number">5</span>}})

query.where(<span class="string">'comment'</span>).elemMatch({ author: <span class="string">'autobot'</span>, votes: {$gte: <span class="number">5</span>}})

query.elemMatch(<span class="string">'comment'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(elem)</span> {</span>
  elem.where(<span class="string">'author'</span>).equals(<span class="string">'autobot'</span>);
  elem.where(<span class="string">'votes'</span>).gte(<span class="number">5</span>);
})

query.where(<span class="string">'comment'</span>).elemMatch(<span class="function"><span class="keyword">function</span> <span class="params">(elem)</span> {</span>
  elem.where(<span class="string">'author'</span>).equals(<span class="string">'autobot'</span>);
  elem.where(<span class="string">'votes'</span>).gte(<span class="number">5</span>);
})</code></pre></div><hr class=""><div class="method "><h3 id="Query-box">Query#box(<code>path</code>, <code>val</code>)</h3><p>Specifies a $box condition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.box = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    val = path;
    path = <span class="keyword">this</span>._currPath;
  }
  <span class="keyword">var</span> conds = <span class="keyword">this</span>._conditions[path] || (<span class="keyword">this</span>._conditions[path] = {});
  conds[<span class="string">'$within'</span>] = { <span class="string">'$box'</span>: [val.ll, val.ur]  };
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li><li><a href="#Query-within" title="Query#within">Query#within</a></li></ul></div><h4>Example</h4>

<pre><code><span class="keyword">var</span> lowerLeft = [<span class="number">40.73083</span>, -<span class="number">73.99756</span>]
<span class="keyword">var</span> upperRight= [<span class="number">40.741404</span>,  -<span class="number">73.988135</span>]
query.where(<span class="string">'loc'</span>).within.box({ ll: lowerLeft , ur: upperRight })</code></pre></div><hr class=""><div class="method "><h3 id="Query-center">Query#center(<code>path</code>, <code>val</code>)</h3><p>Specifies a $center condition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.center = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    val = path;
    path = <span class="keyword">this</span>._currPath;
  }
  <span class="keyword">var</span> conds = <span class="keyword">this</span>._conditions[path] || (<span class="keyword">this</span>._conditions[path] = {});
  conds[<span class="string">'$within'</span>] = { <span class="string">'$center'</span>: [val.center, val.radius]  };
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li></ul></div><h4>Example</h4>

<pre><code><span class="keyword">var</span> area = { center: [<span class="number">50</span>, <span class="number">50</span>], radius: <span class="number">10</span> }
query.where(<span class="string">'loc'</span>).within.center(area)</code></pre></div><hr class=""><div class="method "><h3 id="Query-centerSphere">Query#centerSphere(<code>path</code>, <code>val</code>)</h3><p>Specifies a $centerSphere condition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.centerSphere = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    val = path;
    path = <span class="keyword">this</span>._currPath;
  }
  <span class="keyword">var</span> conds = <span class="keyword">this</span>._conditions[path] || (<span class="keyword">this</span>._conditions[path] = {});
  conds[<span class="string">'$within'</span>] = { <span class="string">'$centerSphere'</span>: [val.center, val.radius]  };
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li></ul></div></div><hr class=""><div class="method "><h3 id="Query-select">Query#select(<code>arg</code>)</h3><p>Specifies which document fields to include or exclude</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.select = <span class="function"><span class="keyword">function</span> <span class="title">select</span> <span class="params">(arg)</span> {</span>
  <span class="keyword">if</span> (!arg) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">var</span> fields = <span class="keyword">this</span>._fields || (<span class="keyword">this</span>._fields = {});

  <span class="keyword">if</span> (<span class="string">'Object'</span> === arg.constructor.name) {
    Object.keys(arg).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(field)</span> {</span>
      fields[field] = arg[field];
    });
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">1</span> === arguments.length &amp;&amp; <span class="string">'string'</span> == <span class="keyword">typeof</span> arg) {
    arg.split(<span class="regexp">/\s+/</span>).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(field)</span> {</span>
      <span class="keyword">if</span> (!field) <span class="keyword">return</span>;
      <span class="keyword">var</span> include = <span class="string">'-'</span> == field[<span class="number">0</span>] ? <span class="number">0</span> : <span class="number">1</span>;
      <span class="keyword">if</span> (include === <span class="number">0</span>) field = field.substring(<span class="number">1</span>);
      fields[field] = include;
    });
  } <span class="keyword">else</span> {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid select() argument. Must be a string or object.'</span>);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#SchemaType" title="SchemaType">SchemaType</a></li></ul></div><p>When using string syntax, prefixing a path with <code>-</code> will flag that path as excluded. When a path does not have the <code>-</code> prefix, it is included. Lastly, if a path is prefixed with <code>+</code>, it forces inclusion of the path, which is useful for paths excluded at the <a href="/docs/todo">schema level</a>.</p>

<h4>Example</h4>

<pre><code><span class="comment">// include a and b, exclude c</span>
query.select(<span class="string">'a b -c'</span>);

<span class="comment">// or you may use object notation, useful when</span>
<span class="comment">// you have keys already prefixed with a "-"</span>
query.select({a: <span class="number">1</span>, b: <span class="number">1</span>, c: <span class="number">0</span>});

<span class="comment">// force inclusion of field excluded at schema level</span>
query.select(<span class="string">'+path'</span>)</code></pre></div><hr class=""><div class="method "><h3 id="Query-slice">Query#slice(<code>path</code>, <code>val</code>)</h3><p>Specifies a $slice condition</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.slice = <span class="function"><span class="keyword">function</span> <span class="params">(path, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
      val = path;
      path = <span class="keyword">this</span>._currPath
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    <span class="keyword">if</span> (<span class="string">'number'</span> === <span class="keyword">typeof</span> path) {
      val = [path, val];
      path = <span class="keyword">this</span>._currPath;
    }
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">3</span>) {
    val = utils.args(arguments, <span class="number">1</span>);
  }
  <span class="keyword">var</span> myFields = <span class="keyword">this</span>._fields || (<span class="keyword">this</span>._fields = {});
  myFields[path] = { <span class="string">'$slice'</span>: val };
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>number of elements to slice</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Retrieving+a+Subset+of+Fields#RetrievingaSubsetofFields-RetrievingaSubrangeofArrayElements" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>query.slice(<span class="string">'comments'</span>, <span class="number">5</span>)
query.slice(<span class="string">'comments'</span>, -<span class="number">5</span>)
query.slice(<span class="string">'comments'</span>, [<span class="number">10</span>, <span class="number">5</span>])
query.where(<span class="string">'comments'</span>).slice(<span class="number">5</span>)
query.where(<span class="string">'comments'</span>).slice([-<span class="number">10</span>, <span class="number">5</span>])</code></pre></div><hr class=""><div class="method "><h3 id="Query-sort">Query#sort(<code>arg</code>)</h3><p>Sets the sort order</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.sort = <span class="function"><span class="keyword">function</span> <span class="params">(arg)</span> {</span>
  <span class="keyword">if</span> (!arg) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">var</span> sort = <span class="keyword">this</span>.options.sort || (<span class="keyword">this</span>.options.sort = []);

  <span class="keyword">if</span> (<span class="string">'Object'</span> === arg.constructor.name) {
    Object.keys(arg).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(field)</span> {</span>
      push(sort, field, arg[field]);
    });
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">1</span> === arguments.length &amp;&amp; <span class="string">'string'</span> == <span class="keyword">typeof</span> arg) {
    arg.split(<span class="regexp">/\s+/</span>).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(field)</span> {</span>
      <span class="keyword">if</span> (!field) <span class="keyword">return</span>;
      <span class="keyword">var</span> ascend = <span class="string">'-'</span> == field[<span class="number">0</span>] ? -<span class="number">1</span> : <span class="number">1</span>;
      <span class="keyword">if</span> (ascend === -<span class="number">1</span>) field = field.substring(<span class="number">1</span>);
      push(sort, field, ascend);
    });
  } <span class="keyword">else</span> {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid sort() argument. Must be a string or object.'</span>);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><p>If an object is passed, values allowed are 'asc', 'desc', 'ascending', 'descending', 1, and -1.</p>

<p>If a string is passed, it must be a space delimited list of path names. The sort order of each path is ascending unless the path name is prefixed with <code>-</code> which will be treated as descending.</p>

<h4>Example</h4>

<pre><code><span class="comment">// these are equivalent</span>
query.sort({ field: <span class="string">'asc'</span>, test: -<span class="number">1</span> });
query.sort(<span class="string">'field -test'</span>);</code></pre></div><hr class=""><div class="method "><h3 id="Query-limit">Query#limit(<code>val</code>)</h3><p>Specifies the limit option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7Blimit%28%29%7D%7D" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Kitten.find().limit(<span class="number">20</span>)</code></pre></div><hr class=""><div class="method "><h3 id="Query-skip">Query#skip(<code>val</code>)</h3><p>Specifies the skip option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7Bskip%28%29%7D%7D" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Kitten.find().skip(<span class="number">100</span>).limit(<span class="number">20</span>)</code></pre></div><hr class=""><div class="method "><h3 id="Query-maxscan">Query#maxscan(<code>val</code>)</h3><p>Specifies the maxscan option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%24maxScan" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Kitten.find().maxscan(<span class="number">100</span>)</code></pre></div><hr class=""><div class="method "><h3 id="Query-batchSize">Query#batchSize(<code>val</code>)</h3><p>Specifies the batchSize option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7BbatchSize%28%29%7D%7D" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Kitten.find().batchSize(<span class="number">100</span>)</code></pre></div><hr class=""><div class="method "><h3 id="Query-comment">Query#comment(<code>val</code>)</h3><p>Specifies the <code>comment</code> option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%24comment" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Kitten.findOne(condition).comment(<span class="string">'login query'</span>)</code></pre></div><hr class=""><div class="method "><h3 id="Query-snapshot">Query#snapshot()</h3><p>Specifies this query as a <code>snapshot</code> query.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.snapshot = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.options.snapshot = <span class="literal">true</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7Bsnapshot%28%29%7D%7D" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Kitten.find().snapshot()</code></pre></div><hr class=""><div class="method "><h3 id="Query-hint">Query#hint(<code>val</code>)</h3><p>Sets query hints.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.hint = <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
  <span class="keyword">if</span> (!val) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">var</span> hint = <span class="keyword">this</span>.options.hint || (<span class="keyword">this</span>.options.hint = {});

  <span class="keyword">if</span> (<span class="string">'Object'</span> === val.constructor.name) {
    <span class="comment">// must keep object keys in order so don't use Object.keys()</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> val) {
      hint[k] = val[k];
    }
  } <span class="keyword">else</span> {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid hint. '</span> + val);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>a hint object</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%24hint" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Model.find().hint({ indexA: <span class="number">1</span>, indexB: -<span class="number">1</span>})</code></pre></div><hr class=""><div class="method "><h3 id="Query-slaveOk">Query#slaveOk(<code>v</code>)</h3><p>Sets the slaveOk option.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.slaveOk = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
  <span class="keyword">this</span>.options.slaveOk = arguments.length ? !!v : <span class="literal">true</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>v</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>defaults to true</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/applications/replication/#read-preference" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code><span class="keyword">new</span> Query().slaveOk() <span class="comment">// true</span>
<span class="keyword">new</span> Query().slaveOk(<span class="literal">true</span>)
<span class="keyword">new</span> Query().slaveOk(<span class="literal">false</span>)</code></pre></div><hr class=""><div class="method "><h3 id="Query-tailable">Query#tailable(<code>v</code>)</h3><p>Sets tailable option.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.tailable = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
  <span class="keyword">this</span>.options.tailable = arguments.length ? !!v : <span class="literal">true</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>v</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>defaults to true</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Tailable+Cursors" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Kitten.find().tailable() &amp;lt;== <span class="literal">true</span>
Kitten.find().tailable(<span class="literal">true</span>)
Kitten.find().tailable(<span class="literal">false</span>)</code></pre></div><hr class=""><div class="method private"><h3 id="Query-execFind">Query#execFind(<code>callback</code>)</h3><p>Executes the query as a find() operation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.execFind = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  <span class="keyword">var</span> model = <span class="keyword">this</span>.model
    , promise = <span class="keyword">new</span> Promise(callback);

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(model);
  } <span class="keyword">catch</span> (err) {
    promise.error(err);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="comment">// apply default schematype path selections</span>
  <span class="keyword">this</span>._applyPaths();

  <span class="keyword">var</span> self = <span class="keyword">this</span>
    , castQuery = <span class="keyword">this</span>._conditions
    , options = <span class="keyword">this</span>._optionsForExec(model)

  <span class="keyword">var</span> fields = utils.clone(options.fields = <span class="keyword">this</span>._fields);

  model.collection.find(castQuery, options, <span class="function"><span class="keyword">function</span> <span class="params">(err, cursor)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> promise.error(err);
    cursor.toArray(tick(cb));
  });

  <span class="function"><span class="keyword">function</span> <span class="title">cb</span> <span class="params">(err, docs)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> promise.error(err);

    <span class="keyword">if</span> (<span class="literal">true</span> === options.lean)
      <span class="keyword">return</span> promise.complete(docs);

    <span class="keyword">var</span> arr = []
      , count = docs.length;

    <span class="keyword">if</span> (!count) <span class="keyword">return</span> promise.complete([]);

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = docs.length; i &lt; l; i++) {
      arr[i] = <span class="keyword">new</span> model(<span class="literal">undefined</span>, fields, <span class="literal">true</span>);
      arr[i].init(docs[i], self, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
        <span class="keyword">if</span> (err) <span class="keyword">return</span> promise.error(err);
        --count || promise.complete(arr);
      });
    }
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Query-findOne">Query#findOne(<code>callback</code>)</h3><p>Executes the query as a findOne() operation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.findOne = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  <span class="keyword">this</span>.op = <span class="string">'findOne'</span>;

  <span class="keyword">if</span> (!callback) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">var</span> model = <span class="keyword">this</span>.model;
  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise(callback);

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(model);
  } <span class="keyword">catch</span> (err) {
    promise.error(err);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="comment">// apply default schematype path selections</span>
  <span class="keyword">this</span>._applyPaths();

  <span class="keyword">var</span> self = <span class="keyword">this</span>
    , castQuery = <span class="keyword">this</span>._conditions
    , options = <span class="keyword">this</span>._optionsForExec(model)

  <span class="keyword">var</span> fields = utils.clone(options.fields = <span class="keyword">this</span>._fields);

  model.collection.findOne(castQuery, options, tick(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> promise.error(err);
    <span class="keyword">if</span> (!doc) <span class="keyword">return</span> promise.complete(<span class="literal">null</span>);

    <span class="keyword">if</span> (<span class="literal">true</span> === options.lean) <span class="keyword">return</span> promise.complete(doc);

    <span class="keyword">var</span> casted = <span class="keyword">new</span> model(<span class="literal">undefined</span>, fields, <span class="literal">true</span>);
    casted.init(doc, self, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      <span class="keyword">if</span> (err) <span class="keyword">return</span> promise.error(err);
      promise.complete(casted);
    });
  }));

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><h4>Example</h4>

<pre><code>Kitten.where(<span class="string">'color'</span>, <span class="string">'white'</span>).findOne(<span class="function"><span class="keyword">function</span> <span class="params">(err, kitten)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);

  <span class="comment">// kitten may be null if no document matched</span>
  <span class="keyword">if</span> (kitten) {
    ...
  }
})</code></pre></div><hr class=""><div class="method "><h3 id="Query-count">Query#count(<code>callback</code>)</h3><p>Exectues the query as a count() operation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.count = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  <span class="keyword">this</span>.op = <span class="string">'count'</span>;
  <span class="keyword">var</span> model = <span class="keyword">this</span>.model;

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">return</span> callback(err);
  }

  <span class="keyword">var</span> castQuery = <span class="keyword">this</span>._conditions;
  model.collection.count(castQuery, tick(callback));

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Aggregation#Aggregation-Count" title="mongodb">mongodb</a></li></ul></div><h4>Example</h4>

<pre><code>Kitten.where(<span class="string">'color'</span>, <span class="string">'black'</span>).count(<span class="function"><span class="keyword">function</span> <span class="params">(err, count)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
  console.log(<span class="string">'there are %d black kittens'</span>, count);
})</code></pre></div><hr class=""><div class="method "><h3 id="Query-distinct">Query#distinct(<code>field</code>, <code>callback</code>)</h3><p>Executes this query as a distict() operation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.distinct = <span class="function"><span class="keyword">function</span> <span class="params">(field, callback)</span> {</span>
  <span class="keyword">this</span>.op = <span class="string">'distinct'</span>;
  <span class="keyword">var</span> model = <span class="keyword">this</span>.model;

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">return</span> callback(err);
  }

  <span class="keyword">var</span> castQuery = <span class="keyword">this</span>._conditions;
  model.collection.distinct(field, castQuery, tick(callback));

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>field</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Aggregation#Aggregation-Distinct" title="mongodb">mongodb</a></li></ul></div></div><hr class=""><div class="method "><h3 id="Query-update">Query#update(<code>doc</code>, <code>callback</code>)</h3><p>Executes this query as an update() operation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.update = <span class="function"><span class="keyword">function</span> <span class="title">update</span> <span class="params">(doc, callback)</span> {</span>
  <span class="keyword">this</span>.op = <span class="string">'update'</span>;
  <span class="keyword">this</span>._updateArg = doc;

  <span class="keyword">var</span> model = <span class="keyword">this</span>.model
    , options = <span class="keyword">this</span>._optionsForExec(model)
    , fn = <span class="string">'function'</span> == <span class="keyword">typeof</span> callback
    , castedQuery
    , castedDoc

  castedQuery = castQuery(<span class="keyword">this</span>);
  <span class="keyword">if</span> (castedQuery <span class="keyword">instanceof</span> Error) {
    <span class="keyword">if</span> (fn) {
      process.nextTick(callback.bind(<span class="literal">null</span>, castedQuery));
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }
    <span class="keyword">throw</span> castedQuery;
  }

  castedDoc = castDoc(<span class="keyword">this</span>);
  <span class="keyword">if</span> (!castedDoc) {
    fn &amp;&amp; process.nextTick(callback.bind(<span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>));
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">if</span> (castedDoc <span class="keyword">instanceof</span> Error) {
    <span class="keyword">if</span> (fn) {
      process.nextTick(callback.bind(<span class="literal">null</span>, castedDoc));
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }
    <span class="keyword">throw</span> castedDoc;
  }

  <span class="keyword">if</span> (!fn) {
    <span class="keyword">delete</span> options.safe;
  }

  model.collection.update(castedQuery, castedDoc, options, tick(callback));
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the update conditions</span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><p><em>All paths passed that are not $atomic operations will become $set ops so we retain backwards compatibility.</em></p>

<h4>Example</h4>

<pre><code>Model.update({..}, { title: <span class="string">'remove words'</span> }, ...)</code></pre>

<p>becomes</p>

<pre><code>Model.update({..}, { $set: { title: <span class="string">'remove words'</span> }}, ...)</code></pre>

<h4>Note</h4>

<p>Passing an empty object <code>{}</code> as the doc will result in a no-op. The update operation will be ignored and the callback executed without sending the command to MongoDB so as to prevent accidently overwritting the collection.</p></div><hr class=""><div class="method private"><h3 id="Query-_castUpdate">Query#_castUpdate(<code>obj</code>)</h3><p>Casts obj for an update command.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._castUpdate = <span class="function"><span class="keyword">function</span> <span class="title">_castUpdate</span> <span class="params">(obj)</span> {</span>
  <span class="keyword">var</span> ops = Object.keys(obj)
    , i = ops.length
    , ret = {}
    , hasKeys
    , val

  <span class="keyword">while</span> (i--) {
    <span class="keyword">var</span> op = ops[i];
    <span class="keyword">if</span> (<span class="string">'$'</span> !== op[<span class="number">0</span>]) {
      <span class="comment">// fix up $set sugar</span>
      <span class="keyword">if</span> (!ret.$set) {
        <span class="keyword">if</span> (obj.$set) {
          ret.$set = obj.$set;
        } <span class="keyword">else</span> {
          ret.$set = {};
        }
      }
      ret.$set[op] = obj[op];
      ops.splice(i, <span class="number">1</span>);
      <span class="keyword">if</span> (!~ops.indexOf(<span class="string">'$set'</span>)) ops.push(<span class="string">'$set'</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'$set'</span> === op) {
      <span class="keyword">if</span> (!ret.$set) {
        ret[op] = obj[op];
      }
    } <span class="keyword">else</span> {
      ret[op] = obj[op];
    }
  }

  <span class="comment">// cast each value</span>
  i = ops.length;

  <span class="keyword">while</span> (i--) {
    op = ops[i];
    val = ret[op];
    <span class="keyword">if</span> (<span class="string">'Object'</span> === val.constructor.name) {
      hasKeys |= <span class="keyword">this</span>._walkUpdatePath(val, op);
    } <span class="keyword">else</span> {
      <span class="keyword">var</span> msg = <span class="string">'Invalid atomic update value for '</span> + op + <span class="string">'. '</span>
              + <span class="string">'Expected an object, received '</span> + <span class="keyword">typeof</span> val;
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(msg);
    }
  }

  <span class="keyword">return</span> hasKeys &amp;&amp; ret;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>obj after casting its values</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Query-_walkUpdatePath">Query#_walkUpdatePath(<code>obj</code>, <code>op</code>, <code>pref</code>)</h3><p>Walk each path of obj and cast its values<br />according to its schema.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._walkUpdatePath = <span class="function"><span class="keyword">function</span> <span class="title">_walkUpdatePath</span> <span class="params">(obj, op, pref)</span> {</span>
  <span class="keyword">var</span> strict = <span class="keyword">this</span>.model.schema.options.strict
    , prefix = pref ? pref + <span class="string">'.'</span> : <span class="string">''</span>
    , keys = Object.keys(obj)
    , i = keys.length
    , hasKeys = <span class="literal">false</span>
    , schema
    , key
    , val

  <span class="keyword">while</span> (i--) {
    key = keys[i];
    val = obj[key];

    <span class="keyword">if</span> (val &amp;&amp; <span class="string">'Object'</span> === val.constructor.name) {
      <span class="comment">// watch for embedded doc schemas</span>
      schema = <span class="keyword">this</span>._getSchema(prefix + key);
      <span class="keyword">if</span> (schema &amp;&amp; schema.caster &amp;&amp; op <span class="keyword">in</span> castOps) {
        <span class="comment">// embedded doc schema</span>

        <span class="keyword">if</span> (strict &amp;&amp; !schema) {
          <span class="comment">// path is not in our strict schema</span>
          <span class="keyword">if</span> (<span class="string">'throw'</span> == strict) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Field `'</span> + key + <span class="string">'` is not in schema.'</span>);
          } <span class="keyword">else</span> {
            <span class="comment">// ignore paths not specified in schema</span>
            <span class="keyword">delete</span> obj[key];
          }
        } <span class="keyword">else</span> {
          hasKeys = <span class="literal">true</span>;
          <span class="keyword">if</span> (<span class="string">'$each'</span> <span class="keyword">in</span> val) {
            obj[key] = {
                $each: <span class="keyword">this</span>._castUpdateVal(schema, val.$each, op)
            }
          } <span class="keyword">else</span> {
            obj[key] = <span class="keyword">this</span>._castUpdateVal(schema, val, op);
          }
        }
      } <span class="keyword">else</span> {
        hasKeys |= <span class="keyword">this</span>._walkUpdatePath(val, op, prefix + key);
      }
    } <span class="keyword">else</span> {
      schema = <span class="string">'$each'</span> === key
        ? <span class="keyword">this</span>._getSchema(pref)
        : <span class="keyword">this</span>._getSchema(prefix + key);

      <span class="keyword">var</span> skip = strict &amp;&amp;
                 !schema &amp;&amp;
                 !<span class="regexp">/real|nested/</span>.test(<span class="keyword">this</span>.model.schema.pathType(prefix + key));

      <span class="keyword">if</span> (skip) {
        <span class="keyword">if</span> (<span class="string">'throw'</span> == strict) {
          <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Field `'</span> + prefix + key + <span class="string">'` is not in schema.'</span>);
        } <span class="keyword">else</span> {
          <span class="keyword">delete</span> obj[key];
        }
      } <span class="keyword">else</span> {
        hasKeys = <span class="literal">true</span>;
        obj[key] = <span class="keyword">this</span>._castUpdateVal(schema, val, op, key);
      }
    }
  }
  <span class="keyword">return</span> hasKeys;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>- part of a query</span></li><li><code>op</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>- the atomic operator ($pull, $set, etc)</span></li><li><code>pref</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>- path prefix (internal only)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Bool">Bool</a>&gt; </span><span>true if this path has keys to update</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Query-_castUpdateVal">Query#_castUpdateVal(<code>schema</code>, <code>val</code>, <code>op</code>, <code>[$conditional]</code>)</h3><p>Casts <code>val</code> according to <code>schema</code> and atomic <code>op</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._castUpdateVal = <span class="function"><span class="keyword">function</span> <span class="title">_castUpdateVal</span> <span class="params">(schema, val, op, $conditional)</span> {</span>
  <span class="keyword">if</span> (!schema) {
    <span class="comment">// non-existing schema path</span>
    <span class="keyword">return</span> op <span class="keyword">in</span> numberOps
      ? Number(val)
      : val
  }

  <span class="keyword">if</span> (schema.caster &amp;&amp; op <span class="keyword">in</span> castOps &amp;&amp;
    (<span class="string">'Object'</span> === val.constructor.name || Array.isArray(val))) {
    <span class="comment">// Cast values for ops that add data to MongoDB.</span>
    <span class="comment">// Ensures embedded documents get ObjectIds etc.</span>
    <span class="keyword">var</span> tmp = schema.cast(val);

    <span class="keyword">if</span> (Array.isArray(val)) {
      val = tmp;
    } <span class="keyword">else</span> {
      val = tmp[<span class="number">0</span>];
    }
  }

  <span class="keyword">if</span> (op <span class="keyword">in</span> numberOps) <span class="keyword">return</span> Number(val);
  <span class="keyword">if</span> (<span class="regexp">/^\$/</span>.test($conditional)) <span class="keyword">return</span> schema.castForQuery($conditional, val);
  <span class="keyword">return</span> schema.castForQuery(val)
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>schema</code><span class="types"> &lt;<a href="#Schema">Schema</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>op</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>- the atomic operator ($pull, $set, etc)</span></li><li><code>[$conditional]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="Query-_getSchema">Query#_getSchema(<code>path</code>)</h3><p>Finds the schema for <code>path</code>. This is different than<br />calling <code>schema.path</code> as it also resolves paths with<br />positional selectors (something.$.another.$.path).</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._getSchema = <span class="function"><span class="keyword">function</span> <span class="title">_getSchema</span> <span class="params">(path)</span> {</span>
  <span class="keyword">var</span> schema = <span class="keyword">this</span>.model.schema
    , pathschema = schema.path(path);

  <span class="keyword">if</span> (pathschema)
    <span class="keyword">return</span> pathschema;

  <span class="comment">// look for arrays</span>
  <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span> <span class="title">search</span> <span class="params">(parts, schema)</span> {</span>
    <span class="keyword">var</span> p = parts.length + <span class="number">1</span>
      , foundschema
      , trypath

    <span class="keyword">while</span> (p--) {
      trypath = parts.slice(<span class="number">0</span>, p).join(<span class="string">'.'</span>);
      foundschema = schema.path(trypath);
      <span class="keyword">if</span> (foundschema) {
        <span class="keyword">if</span> (foundschema.caster) {

          <span class="comment">// array of Mixed?</span>
          <span class="keyword">if</span> (foundschema.caster <span class="keyword">instanceof</span> Types.Mixed) {
            <span class="keyword">return</span> foundschema.caster;
          }

          <span class="comment">// Now that we found the array, we need to check if there</span>
          <span class="comment">// are remaining document paths to look up for casting.</span>
          <span class="comment">// Also we need to handle array.$.path since schema.path</span>
          <span class="comment">// doesn't work for that.</span>
          <span class="keyword">if</span> (p !== parts.length) {
            <span class="keyword">if</span> (<span class="string">'$'</span> === parts[p]) {
              <span class="comment">// comments.$.comments.$.title</span>
              <span class="keyword">return</span> search(parts.slice(p+<span class="number">1</span>), foundschema.schema);
            } <span class="keyword">else</span> {
              <span class="comment">// this is the last path of the selector</span>
              <span class="keyword">return</span> search(parts.slice(p), foundschema.schema);
            }
          }
        }
        <span class="keyword">return</span> foundschema;
      }
    }
  })(path.split(<span class="string">'.'</span>), schema)
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Query-remove">Query#remove(<code>callback</code>)</h3><p>Executes this query as a remove() operation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.remove = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  <span class="keyword">this</span>.op = <span class="string">'remove'</span>;

  <span class="keyword">var</span> model = <span class="keyword">this</span>.model
    , options = <span class="keyword">this</span>._optionsForExec(model)
    , cb = <span class="string">'function'</span> == <span class="keyword">typeof</span> callback

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">if</span> (cb) <span class="keyword">return</span> callback(err);
    <span class="keyword">throw</span> err;
  }

  <span class="keyword">if</span> (!cb) {
    <span class="keyword">delete</span> options.safe;
  }

  <span class="keyword">var</span> castQuery = <span class="keyword">this</span>._conditions;
  model.collection.remove(castQuery, options, tick(callback));
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><h4>Example</h4>

<pre><code>Cassette.where(<span class="string">'artist'</span>).equals(<span class="string">'Anne Murray'</span>).remove(callback)</code></pre></div><hr class=""><div class="method "><h3 id="Query-findOneAndUpdate">Query#findOneAndUpdate(<code>[query]</code>, <code>[doc]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Issues a mongodb <a href="http://www.mongodb.org/display/DOCS/findAndModify+Command">findAndModify</a> update command.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.findOneAndUpdate = <span class="function"><span class="keyword">function</span> <span class="params">(query, doc, options, callback)</span> {</span>
  <span class="keyword">this</span>.op = <span class="string">'findOneAndUpdate'</span>;

  <span class="keyword">switch</span> (arguments.length) {
    <span class="keyword">case</span> <span class="number">3</span>:
      <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> options)
        callback = options, options = {};
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="number">2</span>:
      <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> doc) {
        callback = doc;
        doc = query;
        query = <span class="literal">undefined</span>;
      }
      options = <span class="literal">undefined</span>;
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="number">1</span>:
      <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> query) {
        callback = query;
        query = options = doc = <span class="literal">undefined</span>;
      } <span class="keyword">else</span> {
        doc = query;
        query = options = <span class="literal">undefined</span>;
      }
  }

  <span class="comment">// apply query</span>
  <span class="keyword">if</span> (query) {
    <span class="keyword">if</span> (<span class="string">'Object'</span> === query.constructor.name) {
      merge(<span class="keyword">this</span>._conditions, query);
    } <span class="keyword">else</span> <span class="keyword">if</span> (query <span class="keyword">instanceof</span> Query) {
      merge(<span class="keyword">this</span>._conditions, query._conditions);
    } <span class="keyword">else</span> <span class="keyword">if</span> (query <span class="keyword">instanceof</span> Document) {
      merge(<span class="keyword">this</span>._conditions, query.toObject());
    }
  }

  <span class="comment">// apply doc</span>
  <span class="keyword">if</span> (doc) {
    merge(<span class="keyword">this</span>._updateArg, doc);
  }

  <span class="comment">// apply options</span>
  options &amp;&amp; <span class="keyword">this</span>.setOptions(options);

  <span class="keyword">if</span> (!callback) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">return</span> <span class="keyword">this</span>._findAndModify(<span class="string">'update'</span>, callback);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[query]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[doc]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/findAndModify+Command" title="mongodb">mongodb</a></li></ul></div><p>Finds a matching document, updates it according to the <code>update</code> arg, passing any <code>options</code>, and returns the found document (if any) to the callback. The query executes immediately if <code>callback</code> is passed else a Query object is returned.</p>

<h4>Available options</h4>

<ul>
<li><code>new</code>: bool - true to return the modified document rather than the original. defaults to true</li>
<li><code>upsert</code>: bool - creates the object if it doesn't exist. defaults to false.</li>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
</ul>

<h4>Examples</h4>

<pre><code>query.findOneAndUpdate(conditions, update, options, callback) <span class="comment">// executes</span>
query.findOneAndUpdate(conditions, update, options)  <span class="comment">// returns Query</span>
query.findOneAndUpdate(conditions, update, callback) <span class="comment">// executes</span>
query.findOneAndUpdate(conditions, update)           <span class="comment">// returns Query</span>
query.findOneAndUpdate(callback)                     <span class="comment">// executes</span>
query.findOneAndUpdate()                             <span class="comment">// returns Query</span></code></pre></div><hr class=""><div class="method "><h3 id="Query-findOneAndRemove">Query#findOneAndRemove(<code>[conditions]</code>, <code>[options]</code>, <code>[callback]</code>)</h3><p>Issues a mongodb <a href="http://www.mongodb.org/display/DOCS/findAndModify+Command">findAndModify</a> remove command.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.findOneAndRemove = <span class="function"><span class="keyword">function</span> <span class="params">(conditions, options, callback)</span> {</span>
  <span class="keyword">this</span>.op = <span class="string">'findOneAndRemove'</span>;

  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> options) {
    callback = options;
    options = <span class="literal">undefined</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> conditions) {
    callback = conditions;
    conditions = <span class="literal">undefined</span>;
  }

  <span class="comment">// apply conditions</span>
  <span class="keyword">if</span> (conditions) {
    <span class="keyword">if</span> (<span class="string">'Object'</span> === conditions.constructor.name) {
      merge(<span class="keyword">this</span>._conditions, conditions);
    } <span class="keyword">else</span> <span class="keyword">if</span> (conditions <span class="keyword">instanceof</span> Query) {
      merge(<span class="keyword">this</span>._conditions, conditions._conditions);
    } <span class="keyword">else</span> <span class="keyword">if</span> (conditions <span class="keyword">instanceof</span> Document) {
      merge(<span class="keyword">this</span>._conditions, conditions.toObject());
    }
  }

  <span class="comment">// apply options</span>
  options &amp;&amp; <span class="keyword">this</span>.setOptions(options);

  <span class="keyword">if</span> (!callback) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">return</span> <span class="keyword">this</span>._findAndModify(<span class="string">'remove'</span>, callback);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/findAndModify+Command" title="mongodb">mongodb</a></li></ul></div><p>Finds a matching document, removes it, passing the found document (if any) to the callback. Executes immediately if <code>callback</code> is passed else a Query object is returned.</p>

<h4>Available options</h4>

<ul>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
</ul>

<h4>Examples</h4>

<pre><code>A.where().findOneAndRemove(conditions, options, callback) <span class="comment">// executes</span>
A.where().findOneAndRemove(conditions, options)  <span class="comment">// return Query</span>
A.where().findOneAndRemove(conditions, callback) <span class="comment">// executes</span>
A.where().findOneAndRemove(conditions) <span class="comment">// returns Query</span>
A.where().findOneAndRemove(callback)   <span class="comment">// executes</span>
A.where().findOneAndRemove()           <span class="comment">// returns Query</span></code></pre></div><hr class=""><div class="method private"><h3 id="Query-_findAndModify">Query#_findAndModify(<code>type</code>, <code>callback</code>)</h3><p>_findAndModify</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._findAndModify = <span class="function"><span class="keyword">function</span> <span class="params">(type, callback)</span> {</span>
  <span class="keyword">var</span> model = <span class="keyword">this</span>.model
    , promise = <span class="keyword">new</span> Promise(callback)
    , self = <span class="keyword">this</span>
    , castedQuery
    , castedDoc
    , fields
    , sort
    , opts

  castedQuery = castQuery(<span class="keyword">this</span>);
  <span class="keyword">if</span> (castedQuery <span class="keyword">instanceof</span> Error) {
    process.nextTick(promise.error.bind(promise, castedQuery));
    <span class="keyword">return</span> promise;
  }

  opts = <span class="keyword">this</span>._optionsForExec(model);

  <span class="keyword">if</span> (<span class="string">'remove'</span> == type) {
    opts.remove = <span class="literal">true</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">if</span> (!(<span class="string">'new'</span> <span class="keyword">in</span> opts)) opts.<span class="keyword">new</span> = <span class="literal">true</span>;
    <span class="keyword">if</span> (!(<span class="string">'upsert'</span> <span class="keyword">in</span> opts)) opts.upsert = <span class="literal">false</span>;

    castedDoc = castDoc(<span class="keyword">this</span>);
    <span class="keyword">if</span> (!castedDoc) {
      <span class="keyword">if</span> (opts.upsert) {
        <span class="comment">// still need to do the upsert to empty doc</span>
        castedDoc = { $set: {} };
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> <span class="keyword">this</span>.findOne(callback);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (castedDoc <span class="keyword">instanceof</span> Error) {
      process.nextTick(promise.error.bind(promise, castedDoc));
      <span class="keyword">return</span> promise;
    }
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>._fields) {
    fields = utils.clone(opts.fields = <span class="keyword">this</span>._fields);
  }

  <span class="comment">// the driver needs a default</span>
  sort = opts.sort || [];

  model
  .collection
  .findAndModify(castedQuery, sort, castedDoc, opts, tick(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> promise.error(err);
    <span class="keyword">if</span> (!doc) <span class="keyword">return</span> promise.complete(<span class="literal">null</span>);

    <span class="keyword">if</span> (<span class="literal">true</span> === opts.lean) {
      <span class="keyword">return</span> promise.complete(doc);
    }

    <span class="keyword">var</span> casted = <span class="keyword">new</span> model(<span class="literal">undefined</span>, fields, <span class="literal">true</span>);
    casted.init(doc, self, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      <span class="keyword">if</span> (err) <span class="keyword">return</span> promise.error(err);
      promise.complete(casted);
    });
  }));

  <span class="keyword">return</span> promise;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>type</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>- either &quot;remove&quot; or &quot;update&quot;</span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Query-populate">Query#populate(<code>path</code>, <code>[fields]</code>, <code>[model]</code>, <code>[conditions]</code>, <code>[options]</code>)</h3><p>Specifies paths which should be populated.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.populate = <span class="function"><span class="keyword">function</span> <span class="params">(path, fields, model, conditions, options)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'string'</span> !== <span class="keyword">typeof</span> model) {
    options = conditions;
    conditions = model;
    model = <span class="literal">undefined</span>;
  }
  <span class="comment">// The order of fields/conditions args is opposite Model.find but</span>
  <span class="comment">// necessary to keep backward compatibility (fields could be</span>
  <span class="comment">// an array, string, or object literal).</span>
  <span class="keyword">this</span>.options.populate[path] =
    <span class="keyword">new</span> PopulateOptions(fields, conditions, options, model);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[fields]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[model]</code><span class="types"> &lt;<a href="#Model">Model</a>&gt; </span><span></span></li><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div><p>Paths are populated after the query executes and a response is received. A separate query is then executed for each path specified for population. After a response for each query has also been returned, the results are passed to the callback.</p>

<h4>Example</h4>

<pre><code>Kitten.find().populate(<span class="string">'owner'</span>).exec(callback)</code></pre></div><hr class=""><div class="method "><h3 id="Query-stream">Query#stream()</h3><p>Returns a stream interface</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.stream = <span class="function"><span class="keyword">function</span> <span class="title">stream</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> QueryStream(<span class="keyword">this</span>);
}

<span class="comment">// helpers</span></code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#QueryStream">QueryStream</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#QueryStream" title="QueryStream">QueryStream</a></li></ul></div><h4>Example</h4>

<pre><code><span class="comment">// follows the nodejs stream api</span>
Thing.find({ name: <span class="regexp">/^hello/</span> }).stream().pipe(res)

<span class="comment">// manual streaming</span>
<span class="keyword">var</span> stream = Thing.find({ name: <span class="regexp">/^hello/</span> }).stream();

stream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
  <span class="comment">// do something with the mongoose document</span>
}).on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="comment">// handle the error</span>
}).on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="comment">// the stream is closed</span>
});</code></pre></div><hr class=""><div class="method private"><h3 id="castDoc">castDoc()</h3><p>castDoc</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">castDoc</span> <span class="params">(query)</span> {</span>
  <span class="keyword">try</span> {
    <span class="keyword">return</span> query._castUpdate(query._updateArg);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">return</span> err;
  }
}</code></pre></div></div><hr class="private"><div class="method private"><h3 id="castQuery">castQuery()</h3><p>castQuery</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">castQuery</span> <span class="params">(query)</span> {</span>
  <span class="keyword">try</span> {
    <span class="keyword">return</span> query.cast(query.model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">return</span> err;
  }
}</code></pre></div></div><hr class="private"><div class="property "><h3 id="Query-within">Query#<span>within</span></h3><p>Syntax sugar for expressive queries.</p>

<h4>Example</h4>

<pre><code>query.within.box()
query.within.center()</code></pre><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span>this</span></li></ul></div></div><hr></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/querystream.js">lib/querystream.js</a><div class="method "><h3 id="QueryStream">QueryStream(<code>query</code>)</h3><p>Returns a stream interface for the <code>query</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">QueryStream</span> <span class="params">(query)</span> {</span>
  Stream.call(<span class="keyword">this</span>);

  <span class="keyword">this</span>.query = query;
  <span class="keyword">this</span>.readable = <span class="literal">true</span>;
  <span class="keyword">this</span>.paused = <span class="literal">false</span>;
  <span class="keyword">this</span>._cursor = <span class="literal">null</span>;
  <span class="keyword">this</span>._destroyed = <span class="literal">null</span>;
  <span class="keyword">this</span>._fields = <span class="literal">null</span>;
  <span class="keyword">this</span>._ticks = <span class="number">0</span>;
  <span class="keyword">this</span>._inline = T_INIT;

  <span class="comment">// give time to hook up events</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    self._init();
  });
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>query</code><span class="types"> &lt;<a href="#Query">Query</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://nodejs.org/api/stream.html" title="NodeJS Stream">NodeJS Stream</a></li></ul></div></div><hr class=""><div class="method private"><h3 id="QueryStream">QueryStream()</h3><p>Inherit from Stream</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.__proto__ = Stream.prototype;</code></pre></div></div><hr class="private"><div class="method private"><h3 id="QueryStream-_init">QueryStream#_init()</h3><p>Initializes the query.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype._init = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._destroyed) <span class="keyword">return</span>;

  <span class="keyword">var</span> query = <span class="keyword">this</span>.query
    , model = query.model
    , options = query._optionsForExec(model)
    , self = <span class="keyword">this</span>

  <span class="keyword">try</span> {
    query.cast(model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">return</span> self.destroy(err);
  }

  self._fields = utils.clone(options.fields = query._fields);

  model.collection.find(query._conditions, options, <span class="function"><span class="keyword">function</span> <span class="params">(err, cursor)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> self.destroy(err);
    self._cursor = cursor;
    self._next();
  });
}</code></pre></div></div><hr class="private"><div class="method private"><h3 id="QueryStream-_next">QueryStream#_next()</h3><p>Trampoline for pulling the next doc from cursor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype._next = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="comment">// avoid stack overflows with large result sets.</span>
  <span class="comment">// trampoline instead of recursion.</span>
  <span class="keyword">var</span> fn;
  <span class="keyword">while</span> (fn = <span class="keyword">this</span>.__next()) fn.call(<span class="keyword">this</span>);
}</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#QueryStream-__next" title="QueryStream#__next">QueryStream#__next</a></li></ul></div></div><hr class="private"><div class="method private"><h3 id="QueryStream-__next">QueryStream#__next()</h3><p>Pull the next doc from the cursor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.__next = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.paused || <span class="keyword">this</span>._destroyed) <span class="keyword">return</span>;

  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  self._inline = T_INIT;

  self._cursor.nextObject(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
    self._onNextObject(err, doc);
  });

  <span class="comment">// if onNextObject() was already called in this tick</span>
  <span class="comment">// return ourselves to the trampoline.</span>
  <span class="keyword">if</span> (T_CONT === <span class="keyword">this</span>._inline) {
    <span class="keyword">return</span> <span class="keyword">this</span>.__next;
  } <span class="keyword">else</span> {
    <span class="comment">// onNextObject() hasn't fired yet. tell onNextObject</span>
    <span class="comment">// that its ok to call _next b/c we are not within</span>
    <span class="comment">// the trampoline anymore.</span>
    <span class="keyword">this</span>._inline = T_IDLE;
  }
}</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#QueryStream-_next" title="QueryStream#_next">QueryStream#_next</a></li></ul></div></div><hr class="private"><div class="method private"><h3 id="QueryStream-_onNextObject">QueryStream#_onNextObject(<code>err</code>, <code>doc</code>)</h3><p>Transforms raw <code>doc</code>s returned from the cursor into a model instance.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype._onNextObject = <span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="keyword">this</span>.destroy(err);

  <span class="comment">// when doc is null we hit the end of the cursor</span>
  <span class="keyword">if</span> (!doc) {
    <span class="keyword">return</span> <span class="keyword">this</span>.destroy();
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.query.options &amp;&amp; <span class="keyword">this</span>.query.options.lean === <span class="literal">true</span>)  {
    <span class="keyword">this</span>.emit(<span class="string">'data'</span>, doc);
    <span class="keyword">this</span>._next();
    <span class="keyword">return</span>;
  }

  <span class="keyword">var</span> instance = <span class="keyword">new</span> <span class="keyword">this</span>.query.model(<span class="literal">undefined</span>, <span class="keyword">this</span>._fields);

  <span class="comment">// skip _id for pre-init hooks</span>
  <span class="keyword">delete</span> instance._doc._id;

  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  instance.init(doc, <span class="keyword">this</span>.query, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> self.destroy(err);
    self.emit(<span class="string">'data'</span>, instance);

    <span class="comment">// trampoline management</span>
    <span class="keyword">if</span> (T_IDLE === self._inline) {
      <span class="comment">// no longer in trampoline. restart it.</span>
      self._next();
    } <span class="keyword">else</span>
      <span class="comment">// in a trampoline. tell __next that its</span>
      <span class="comment">// ok to continue jumping.</span>
      self._inline = T_CONT;
  });
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>, <a href="#null">null</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="QueryStream-pause">QueryStream#pause()</h3><p>Pauses this stream.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.pause = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.paused = <span class="literal">true</span>;
}</code></pre></div></div><hr class=""><div class="method "><h3 id="QueryStream-resume">QueryStream#resume()</h3><p>Resumes this stream.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.resume = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.paused = <span class="literal">false</span>;
  <span class="keyword">this</span>._next();
}</code></pre></div></div><hr class=""><div class="method "><h3 id="QueryStream-destroy">QueryStream#destroy()</h3><p>Destroys the stream, closing the underlying cursor.<br />No more events will be emitted.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.destroy = <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._destroyed) <span class="keyword">return</span>;
  <span class="keyword">this</span>._destroyed = <span class="literal">true</span>;
  <span class="keyword">this</span>.readable = <span class="literal">false</span>;

  <span class="keyword">if</span> (<span class="keyword">this</span>._cursor) {
    <span class="keyword">this</span>._cursor.close();
  }

  <span class="keyword">if</span> (err) {
    <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err);
  }

  <span class="keyword">this</span>.emit(<span class="string">'close'</span>);
}</code></pre></div></div><hr class=""><div class="property "><h3 id="QueryStream-paused">QueryStream#<span>paused</span></h3><p>Flag stating whether or not this stream is paused.</p></div><hr><div class="property "><h3 id="QueryStream-readable">QueryStream#<span>readable</span></h3><p>Flag stating whether or not this stream is readable.</p></div><hr></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/array.js">lib/schema/array.js</a><div class="method private"><h3 id="SchemaArray">SchemaArray(<code>key</code>, <code>cast</code>)</h3><p>Array SchemaType constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaArray</span> <span class="params">(key, cast, options)</span> {</span>
  <span class="keyword">if</span> (cast) {
    <span class="keyword">var</span> castOptions = {};

    <span class="keyword">if</span> (<span class="string">'Object'</span> === cast.constructor.name) {
      <span class="keyword">if</span> (cast.type) {
        <span class="comment">// support { type: Woot }</span>
        castOptions = cast;
        cast = cast.type;
        <span class="keyword">delete</span> castOptions.type;
      } <span class="keyword">else</span> {
        cast = Mixed;
      }
    }

    <span class="keyword">var</span> caster = cast.name <span class="keyword">in</span> Types ? Types[cast.name] : cast;
    <span class="keyword">this</span>.casterConstructor = caster;
    <span class="keyword">this</span>.caster = <span class="keyword">new</span> caster(<span class="literal">null</span>, castOptions);
  }

  SchemaType.call(<span class="keyword">this</span>, key, options);

  <span class="keyword">var</span> self = <span class="keyword">this</span>
    , defaultArr
    , fn;

  <span class="keyword">if</span> (<span class="keyword">this</span>.defaultValue) {
    defaultArr = <span class="keyword">this</span>.defaultValue;
    fn = <span class="string">'function'</span> == <span class="keyword">typeof</span> defaultArr;
  }

  <span class="keyword">this</span>.<span class="keyword">default</span>(<span class="keyword">function</span>(){
    <span class="keyword">var</span> arr = fn ? defaultArr() : defaultArr || [];
    <span class="keyword">return</span> <span class="keyword">new</span> MongooseArray(arr, self.path, <span class="keyword">this</span>);
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>cast</code><span class="types"> &lt;<a href="#SchemaType">SchemaType</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaArray">SchemaArray()</h3><p>Inherits from SchemaType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.__proto__ = SchemaType.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="SchemaArray-checkRequired">SchemaArray#checkRequired()</h3><p>Check required</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
  <span class="keyword">return</span> !!(value &amp;&amp; value.length);
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="SchemaArray-applyGetters">SchemaArray#applyGetters(<code>value</code>, <code>scope</code>)</h3><p>Overrides the getters application for the population special-case<br />TODO: implement this in SchemaObjectIdArray</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.applyGetters = <span class="function"><span class="keyword">function</span> <span class="params">(value, scope)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.caster.options &amp;&amp; <span class="keyword">this</span>.caster.options.ref) {
    <span class="comment">// means the object id was populated</span>
    <span class="keyword">return</span> value;
  }

  <span class="keyword">return</span> SchemaType.prototype.applyGetters.call(<span class="keyword">this</span>, value, scope);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="SchemaArray-cast">SchemaArray#cast(<code>value</code>, <code>document</code>, <code>whether</code>)</h3><p>Casts contents</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(value, doc, init)</span> {</span>
  <span class="keyword">if</span> (Array.isArray(value)) {
    <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> MongooseArray)) {
      value = <span class="keyword">new</span> MongooseArray(value, <span class="keyword">this</span>.path, doc);
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.caster) {
      <span class="keyword">try</span> {
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = value.length; i &lt; l; i++) {
          value[i] = <span class="keyword">this</span>.caster.cast(value[i], doc, init);
        }
      } <span class="keyword">catch</span> (e) {
        <span class="comment">// rethrow</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> CastError(e.type, value);
      }
    }

    <span class="keyword">return</span> value;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> <span class="keyword">this</span>.cast([value], doc, init);
  }
};

SchemaArray.prototype.castForQuery = <span class="function"><span class="keyword">function</span> <span class="params">($conditional, value)</span> {</span>
  <span class="keyword">var</span> handler
    , val;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler)
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Can't use "</span> + $conditional + <span class="string">" with Array."</span>);
    val = handler.call(<span class="keyword">this</span>, value);
  } <span class="keyword">else</span> {
    val = $conditional;
    <span class="keyword">var</span> proto = <span class="keyword">this</span>.casterConstructor.prototype;
    <span class="keyword">var</span> method = proto.castForQuery || proto.cast;
    <span class="keyword">if</span> (Array.isArray(val)) {
      val = val.map(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
        <span class="keyword">if</span> (method) v = method.call(proto, v);
        <span class="keyword">return</span> isMongooseObject(v)
          ? v.toObject()
          : v;
      });
    } <span class="keyword">else</span> <span class="keyword">if</span> (method) {
      val = method.call(proto, val);
    }
  }
  <span class="keyword">return</span> val &amp;&amp; isMongooseObject(val)
    ? val.toObject()
    : val;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>document</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span>that triggers the casting</span></li><li><code>whether</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>this is an initialization cast</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaArray-cast">SchemaArray#cast()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = SchemaArray;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/boolean.js">lib/schema/boolean.js</a><div class="method private"><h3 id="SchemaBoolean">SchemaBoolean(<code>path</code>, <code>options</code>)</h3><p>Boolean SchemaType constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaBoolean</span> <span class="params">(path, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, path, options);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaBoolean">SchemaBoolean()</h3><p>Inherits from SchemaType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBoolean.prototype.__proto__ = SchemaType.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="SchemaBoolean-checkRequired">SchemaBoolean#checkRequired()</h3><p>Required validator for date</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBoolean.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
  <span class="keyword">return</span> value === <span class="literal">true</span> || value === <span class="literal">false</span>;
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="SchemaBoolean-cast">SchemaBoolean#cast(<code>value</code>)</h3><p>Casts to boolean</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBoolean.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
  <span class="keyword">if</span> (value === <span class="literal">null</span>) <span class="keyword">return</span> value;
  <span class="keyword">if</span> (value === <span class="string">'0'</span>) <span class="keyword">return</span> <span class="literal">false</span>;
  <span class="keyword">return</span> !!value;
};

SchemaBoolean.prototype.castForQuery = <span class="function"><span class="keyword">function</span> <span class="params">($conditional, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    val = $conditional;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.cast(val);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to cast</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaBoolean-cast">SchemaBoolean#cast()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = SchemaBoolean;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/buffer.js">lib/schema/buffer.js</a><div class="method private"><h3 id="SchemaBuffer">SchemaBuffer(<code>key</code>, <code>cast</code>)</h3><p>Buffer SchemaType constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaBuffer</span> <span class="params">(key, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'Buffer'</span>);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>cast</code><span class="types"> &lt;<a href="#SchemaType">SchemaType</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaBuffer">SchemaBuffer()</h3><p>Inherits from SchemaType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.__proto__ = SchemaType.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="SchemaBuffer-checkRequired">SchemaBuffer#checkRequired()</h3><p>Check required</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
  <span class="keyword">return</span> !!(value &amp;&amp; value.length);
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="SchemaBuffer-cast">SchemaBuffer#cast(<code>value</code>, <code>document</code>)</h3><p>Casts contents</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(value, doc, init)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, init)) <span class="keyword">return</span> value;

  <span class="keyword">if</span> (Buffer.isBuffer(value)) {
    <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> MongooseBuffer)) {
      value = <span class="keyword">new</span> MongooseBuffer(value, [<span class="keyword">this</span>.path, doc]);
    }

    <span class="keyword">return</span> value;
  } <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Binary) {
    <span class="keyword">return</span> <span class="keyword">new</span> MongooseBuffer(value.value(<span class="literal">true</span>), [<span class="keyword">this</span>.path, doc]);
  }

  <span class="keyword">if</span> (<span class="string">'string'</span> === <span class="keyword">typeof</span> value || Array.isArray(value)) {
    <span class="keyword">return</span> <span class="keyword">new</span> MongooseBuffer(value, [<span class="keyword">this</span>.path, doc]);
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'buffer'</span>, value);
};

<span class="function"><span class="keyword">function</span> <span class="title">handleSingle</span> <span class="params">(val)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.castForQuery(val);
}

<span class="function"><span class="keyword">function</span> <span class="title">handleArray</span> <span class="params">(val)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">return</span> val.map( <span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
    <span class="keyword">return</span> self.castForQuery(m);
  });
}

SchemaBuffer.prototype.$conditionalHandlers = {
    <span class="string">'$ne'</span> : handleSingle
  , <span class="string">'$in'</span> : handleArray
  , <span class="string">'$nin'</span>: handleArray
  , <span class="string">'$gt'</span> : handleSingle
  , <span class="string">'$lt'</span> : handleSingle
  , <span class="string">'$gte'</span>: handleSingle
  , <span class="string">'$lte'</span>: handleSingle
};

SchemaBuffer.prototype.castForQuery = <span class="function"><span class="keyword">function</span> <span class="params">($conditional, val)</span> {</span>
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler)
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Can't use "</span> + $conditional + <span class="string">" with Buffer."</span>);
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  } <span class="keyword">else</span> {
    val = $conditional;
    <span class="keyword">return</span> <span class="keyword">this</span>.cast(val).toObject();
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>document</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span>that triggers the casting</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaBuffer-cast">SchemaBuffer#cast()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = SchemaBuffer;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/date.js">lib/schema/date.js</a><div class="method private"><h3 id="SchemaDate">SchemaDate(<code>key</code>, <code>options</code>)</h3><p>Date SchemaType constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaDate</span> <span class="params">(key, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, key, options);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaDate">SchemaDate()</h3><p>Inherits from SchemaType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.__proto__ = SchemaType.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="SchemaDate-checkRequired">SchemaDate#checkRequired()</h3><p>Required validator for date</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
  <span class="keyword">return</span> value <span class="keyword">instanceof</span> Date;
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="SchemaDate-cast">SchemaDate#cast(<code>value</code>)</h3><p>Casts to date</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
  <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="string">''</span>)
    <span class="keyword">return</span> <span class="literal">null</span>;

  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Date)
    <span class="keyword">return</span> value;

  <span class="keyword">var</span> date;

  <span class="comment">// support for timestamps</span>
  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Number || <span class="string">'number'</span> == <span class="keyword">typeof</span> value 
      || String(value) == Number(value))
    date = <span class="keyword">new</span> Date(Number(value));

  <span class="comment">// support for date strings</span>
  <span class="keyword">else</span> <span class="keyword">if</span> (value.toString)
    date = <span class="keyword">new</span> Date(value.toString());

  <span class="keyword">if</span> (date.toString() != <span class="string">'Invalid Date'</span>)
    <span class="keyword">return</span> date;

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'date'</span>, value);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to cast</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="handleSingle">handleSingle()</h3><p>Date Query casting.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">handleSingle</span> <span class="params">(val)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.cast(val);
}

<span class="function"><span class="keyword">function</span> <span class="title">handleArray</span> <span class="params">(val)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">return</span> val.map( <span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
    <span class="keyword">return</span> self.cast(m);
  });
}

SchemaDate.prototype.$conditionalHandlers = {
    <span class="string">'$lt'</span>: handleSingle
  , <span class="string">'$lte'</span>: handleSingle
  , <span class="string">'$gt'</span>: handleSingle
  , <span class="string">'$gte'</span>: handleSingle
  , <span class="string">'$ne'</span>: handleSingle
  , <span class="string">'$in'</span>: handleArray
  , <span class="string">'$nin'</span>: handleArray
  , <span class="string">'$all'</span>: handleArray
};

SchemaDate.prototype.castForQuery = <span class="function"><span class="keyword">function</span> <span class="params">($conditional, val)</span> {</span>
  <span class="keyword">var</span> handler;

  <span class="keyword">if</span> (<span class="number">2</span> !== arguments.length) {
    <span class="keyword">return</span> <span class="keyword">this</span>.cast($conditional);
  }

  handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];

  <span class="keyword">if</span> (!handler) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Can't use "</span> + $conditional + <span class="string">" with Date."</span>);
  }

  <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="handleSingle">handleSingle()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = SchemaDate;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/documentarray.js">lib/schema/documentarray.js</a><div class="method private"><h3 id="DocumentArray">DocumentArray(<code>key</code>, <code>schema</code>, <code>options</code>)</h3><p>SubdocsArray SchemaType constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">DocumentArray</span> <span class="params">(key, schema, options)</span> {</span>
  <span class="comment">// compile an embedded document for this schema</span>
  <span class="comment">// TODO Move this into parent model compilation for performance improvement?</span>
  <span class="function"><span class="keyword">function</span> <span class="title">EmbeddedDocument</span> <span class="params">()</span> {</span>
    Subdocument.apply(<span class="keyword">this</span>, arguments);
  };

  EmbeddedDocument.prototype.__proto__ = Subdocument.prototype;
  EmbeddedDocument.prototype._setSchema(schema);
  EmbeddedDocument.schema = schema;

  <span class="comment">// apply methods</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> schema.methods) {
    EmbeddedDocument.prototype[i] = schema.methods[i];
  }

  <span class="comment">// apply statics</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> schema.statics)
    EmbeddedDocument[i] = schema.statics[i];

  EmbeddedDocument.options = options;
  <span class="keyword">this</span>.schema = schema;

  ArrayType.call(<span class="keyword">this</span>, key, EmbeddedDocument, options);

  <span class="keyword">this</span>.schema = schema;
  <span class="keyword">var</span> path = <span class="keyword">this</span>.path;
  <span class="keyword">var</span> fn = <span class="keyword">this</span>.defaultValue;

  <span class="keyword">this</span>.<span class="keyword">default</span>(<span class="keyword">function</span>(){
    <span class="keyword">var</span> arr = fn.call(<span class="keyword">this</span>);
    <span class="keyword">if</span> (!Array.isArray(arr)) arr = [arr];
    <span class="keyword">return</span> <span class="keyword">new</span> MongooseDocumentArray(arr, path, <span class="keyword">this</span>);
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>schema</code><span class="types"> &lt;<a href="#Schema">Schema</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="DocumentArray">DocumentArray()</h3><p>Inherits from ArrayType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.prototype.__proto__ = ArrayType.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="DocumentArray-doValidate">DocumentArray#doValidate()</h3><p>Performs local validations first, then validations on each embedded doc</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.prototype.doValidate = <span class="function"><span class="keyword">function</span> <span class="params">(array, fn, scope)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  SchemaType.prototype.doValidate.call(<span class="keyword">this</span>, array, <span class="keyword">function</span>(err){
    <span class="keyword">if</span> (err) <span class="keyword">return</span> fn(err);

    <span class="keyword">var</span> count = array &amp;&amp; array.length
      , error = <span class="literal">false</span>;

    <span class="keyword">if</span> (!count) <span class="keyword">return</span> fn();

    array.forEach(<span class="keyword">function</span>(doc, index){
      doc.validate(<span class="keyword">function</span>(err){
        <span class="keyword">if</span> (err &amp;&amp; !error){
          <span class="comment">// rewrite they key</span>
          err.key = self.key + <span class="string">'.'</span> + index + <span class="string">'.'</span> + err.key;
          fn(err);
          error = <span class="literal">true</span>;
        } <span class="keyword">else</span> {
          --count || fn();
        }
      });
    });
  }, scope);
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="DocumentArray-cast">DocumentArray#cast(<code>value</code>, <code>document</code>)</h3><p>Casts contents</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(value, doc, init, prev)</span> {</span>
  <span class="keyword">var</span> subdoc
    , i

  <span class="keyword">if</span> (Array.isArray(value)) {
    <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> MongooseDocumentArray)) {
      value = <span class="keyword">new</span> MongooseDocumentArray(value, <span class="keyword">this</span>.path, doc);
    }

    i = value.length;

    <span class="keyword">while</span> (i--) {
      <span class="keyword">if</span> (!(value[i] <span class="keyword">instanceof</span> Subdocument)) {
        <span class="keyword">if</span> (init) {
          subdoc = <span class="keyword">new</span> <span class="keyword">this</span>.casterConstructor(<span class="literal">null</span>, value, <span class="literal">true</span>);
          value[i] = subdoc.init(value[i]);
        } <span class="keyword">else</span> {
          subdoc = prev &amp;&amp; prev.id(value[i]._id) ||
                   <span class="keyword">new</span> <span class="keyword">this</span>.casterConstructor(value[i], value);
          <span class="comment">// if set() is hooked it will have no return value</span>
          <span class="comment">// see gh-746</span>
          value[i] = subdoc;
        }
      }
    }

    <span class="keyword">return</span> value;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> <span class="keyword">this</span>.cast([value], doc, init, prev);
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'documentarray'</span>, value);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>document</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span>that triggers the casting</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="DocumentArray-cast">DocumentArray#cast()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = DocumentArray;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/index.js">lib/schema/index.js</a></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/mixed.js">lib/schema/mixed.js</a><div class="method private"><h3 id="Mixed">Mixed(<code>path</code>, <code>options</code>)</h3><p>Mixed SchemaType constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Mixed</span> <span class="params">(path, options)</span> {</span>
  <span class="comment">// make sure empty array defaults are handled</span>
  <span class="keyword">if</span> (options &amp;&amp;
      options.<span class="keyword">default</span> &amp;&amp;
      Array.isArray(options.<span class="keyword">default</span>) &amp;&amp;
      <span class="number">0</span> === options.<span class="keyword">default</span>.length) {
    options.<span class="keyword">default</span> = Array;
  }

  SchemaType.call(<span class="keyword">this</span>, path, options);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Mixed">Mixed()</h3><p>Inherits from SchemaType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mixed.prototype.__proto__ = SchemaType.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="Mixed-checkRequired">Mixed#checkRequired()</h3><p>Required validator for mixed type</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mixed.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
  <span class="keyword">return</span> <span class="literal">true</span>;
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="Mixed-cast">Mixed#cast(<code>value</code>)</h3><p>Noop casting</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mixed.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
  <span class="keyword">return</span> val;
};

Mixed.prototype.castForQuery = <span class="function"><span class="keyword">function</span> <span class="params">($cond, val)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) <span class="keyword">return</span> val;
  <span class="keyword">return</span> $cond;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to cast</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Mixed-cast">Mixed#cast()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = Mixed;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/number.js">lib/schema/number.js</a><div class="method private"><h3 id="SchemaNumber">SchemaNumber(<code>key</code>, <code>options</code>)</h3><p>Number SchemaType constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaNumber</span> <span class="params">(key, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'Number'</span>);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaNumber">SchemaNumber()</h3><p>Inherits from SchemaType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.__proto__ = SchemaType.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="SchemaNumber-checkRequired">SchemaNumber#checkRequired()</h3><p>Required validator for number</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="title">checkRequired</span> <span class="params">(value)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, <span class="literal">true</span>)) {
    <span class="keyword">return</span> <span class="literal">null</span> != value;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> <span class="keyword">typeof</span> value == <span class="string">'number'</span> || value <span class="keyword">instanceof</span> Number;
  }
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="SchemaNumber-min">SchemaNumber#min(<code>minimum</code>)</h3><p>Sets a maximum number validator</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.min = <span class="function"><span class="keyword">function</span> <span class="params">(value, message)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.minValidator)
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v){
      <span class="keyword">return</span> v[<span class="number">1</span>] != <span class="string">'min'</span>;
    });
  <span class="keyword">if</span> (value != <span class="literal">null</span>)
    <span class="keyword">this</span>.validators.push([<span class="keyword">function</span>(v){
      <span class="keyword">return</span> v === <span class="literal">null</span> || v >= value;
    }, <span class="string">'min'</span>]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>minimum</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>number</span></li></ul></div></div><hr class=""><div class="method "><h3 id="SchemaNumber-max">SchemaNumber#max(<code>maximum</code>)</h3><p>Sets a maximum number validator</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.max = <span class="function"><span class="keyword">function</span> <span class="params">(value, message)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.maxValidator)
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v){
      <span class="keyword">return</span> v[<span class="number">1</span>] != <span class="string">'max'</span>;
    });
  <span class="keyword">if</span> (value != <span class="literal">null</span>)
    <span class="keyword">this</span>.validators.push([<span class="keyword">this</span>.maxValidator = <span class="keyword">function</span>(v){
      <span class="keyword">return</span> v === <span class="literal">null</span> || v &lt;= value;
    }, <span class="string">'max'</span>]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>maximum</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>number</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="SchemaNumber-cast">SchemaNumber#cast(<code>value</code>, <code>document</code>)</h3><p>Casts to number</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(value, doc, init)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, init)) <span class="keyword">return</span> value;

  <span class="keyword">if</span> (!isNaN(value)){
    <span class="keyword">if</span> (<span class="literal">null</span> === value) <span class="keyword">return</span> value;
    <span class="keyword">if</span> (<span class="string">''</span> === value) <span class="keyword">return</span> <span class="literal">null</span>;
    <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> value) value = Number(value);
    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Number) <span class="keyword">return</span> value
    <span class="keyword">if</span> (<span class="string">'number'</span> == <span class="keyword">typeof</span> value) <span class="keyword">return</span> value;
    <span class="keyword">if</span> (value.toString &amp;&amp; !Array.isArray(value) &amp;&amp;
        value.toString() == Number(value)) {
      <span class="keyword">return</span> <span class="keyword">new</span> Number(value)
    }
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'number'</span>, value);
};

<span class="function"><span class="keyword">function</span> <span class="title">handleSingle</span> <span class="params">(val)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.cast(val)
}

<span class="function"><span class="keyword">function</span> <span class="title">handleArray</span> <span class="params">(val)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">return</span> val.map( <span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
    <span class="keyword">return</span> self.cast(m)
  });
}

SchemaNumber.prototype.$conditionalHandlers = {
    <span class="string">'$lt'</span> : handleSingle
  , <span class="string">'$lte'</span>: handleSingle
  , <span class="string">'$gt'</span> : handleSingle
  , <span class="string">'$gte'</span>: handleSingle
  , <span class="string">'$ne'</span> : handleSingle
  , <span class="string">'$in'</span> : handleArray
  , <span class="string">'$nin'</span>: handleArray
  , <span class="string">'$mod'</span>: handleArray
  , <span class="string">'$all'</span>: handleArray
};

SchemaNumber.prototype.castForQuery = <span class="function"><span class="keyword">function</span> <span class="params">($conditional, val)</span> {</span>
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler)
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Can't use "</span> + $conditional + <span class="string">" with Number."</span>);
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  } <span class="keyword">else</span> {
    val = <span class="keyword">this</span>.cast($conditional);
    <span class="keyword">return</span> val == <span class="literal">null</span> ? val : val
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to cast</span></li><li><code>document</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span>that triggers the casting</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaNumber-cast">SchemaNumber#cast()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = SchemaNumber;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/objectid.js">lib/schema/objectid.js</a><div class="method private"><h3 id="ObjectId">ObjectId(<code>key</code>, <code>options</code>)</h3><p>ObjectId SchemaType constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ObjectId</span> <span class="params">(key, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'ObjectID'</span>);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="ObjectId">ObjectId()</h3><p>Inherits from SchemaType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.__proto__ = SchemaType.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="ObjectId-checkRequired">ObjectId#checkRequired()</h3><p>Check required</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="title">checkRequired</span> <span class="params">(value)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, <span class="literal">true</span>)) {
    <span class="keyword">return</span> <span class="literal">null</span> != value;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> value <span class="keyword">instanceof</span> oid;
  }
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="ObjectId-cast">ObjectId#cast(<code>value</code>, <code>scope</code>, <code>whether</code>)</h3><p>Casts to ObjectId</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(value, scope, init)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, init)) <span class="keyword">return</span> value;

  <span class="keyword">if</span> (value === <span class="literal">null</span>) <span class="keyword">return</span> value;

  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> oid)
    <span class="keyword">return</span> value;

  <span class="keyword">if</span> (value._id &amp;&amp; value._id <span class="keyword">instanceof</span> oid)
    <span class="keyword">return</span> value._id;

  <span class="keyword">if</span> (value.toString)
    <span class="keyword">return</span> oid.fromString(value.toString());

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'object id'</span>, value);
};

<span class="function"><span class="keyword">function</span> <span class="title">handleSingle</span> <span class="params">(val)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.cast(val);
}

<span class="function"><span class="keyword">function</span> <span class="title">handleArray</span> <span class="params">(val)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">return</span> val.map(<span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
    <span class="keyword">return</span> self.cast(m);
  });
}

ObjectId.prototype.$conditionalHandlers = {
    <span class="string">'$ne'</span>: handleSingle
  , <span class="string">'$in'</span>: handleArray
  , <span class="string">'$nin'</span>: handleArray
  , <span class="string">'$gt'</span>: handleSingle
  , <span class="string">'$lt'</span>: handleSingle
  , <span class="string">'$gte'</span>: handleSingle
  , <span class="string">'$lte'</span>: handleSingle
  , <span class="string">'$all'</span>: handleArray
};

ObjectId.prototype.castForQuery = <span class="function"><span class="keyword">function</span> <span class="params">($conditional, val)</span> {</span>
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler)
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Can't use "</span> + $conditional + <span class="string">" with ObjectId."</span>);
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> <span class="keyword">this</span>.cast($conditional);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>whether</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>this is an initialization cast</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="ObjectId-auto">ObjectId#auto(<code>turnOn</code>)</h3><p>Adds an auto-generated ObjectId default if turnOn is true.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.auto = <span class="function"><span class="keyword">function</span> <span class="params">(turnOn)</span> {</span>
  <span class="keyword">if</span> (turnOn) {
    <span class="keyword">this</span>.<span class="keyword">default</span>(defaultId);
    <span class="keyword">this</span>.set(resetId)
  }
};

<span class="function"><span class="keyword">function</span> <span class="title">defaultId</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> oid();
};

<span class="function"><span class="keyword">function</span> <span class="title">resetId</span> <span class="params">(v)</span> {</span>
  <span class="keyword">this</span>.__id = <span class="literal">null</span>;
  <span class="keyword">return</span> v;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>turnOn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>auto generated ObjectId defaults</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="ObjectId-auto">ObjectId#auto()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = ObjectId;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema/string.js">lib/schema/string.js</a><div class="method private"><h3 id="SchemaString">SchemaString(<code>key</code>)</h3><p>String SchemaType constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaString</span> <span class="params">(key, options)</span> {</span>
  <span class="keyword">this</span>.enumValues = [];
  <span class="keyword">this</span>.regExp = <span class="literal">null</span>;
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'String'</span>);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaString">SchemaString()</h3><p>Inherits from SchemaType.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.__proto__ = SchemaType.prototype;</code></pre></div></div><hr class=""><div class="method "><h3 id="SchemaString-enum">SchemaString#enum(<code>enumeration</code>)</h3><p>Adds enumeration values</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.enum = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> len = arguments.length;
  <span class="keyword">if</span> (!len || <span class="literal">undefined</span> === arguments[<span class="number">0</span>] || <span class="literal">false</span> === arguments[<span class="number">0</span>]) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.enumValidator){
      <span class="keyword">this</span>.enumValidator = <span class="literal">false</span>;
      <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v){
        <span class="keyword">return</span> v[<span class="number">1</span>] != <span class="string">'enum'</span>;
      });
    }
    <span class="keyword">return</span>;
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) {
    <span class="keyword">if</span> (<span class="literal">undefined</span> !== arguments[i]) {
      <span class="keyword">this</span>.enumValues.push(<span class="keyword">this</span>.cast(arguments[i]));
    }
  }

  <span class="keyword">if</span> (!<span class="keyword">this</span>.enumValidator) {
    <span class="keyword">var</span> values = <span class="keyword">this</span>.enumValues;
    <span class="keyword">this</span>.enumValidator = <span class="keyword">function</span>(v){
      <span class="keyword">return</span> <span class="literal">undefined</span> === v || ~values.indexOf(v);
    };
    <span class="keyword">this</span>.validators.push([<span class="keyword">this</span>.enumValidator, <span class="string">'enum'</span>]);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>enumeration</code><span class="types"> &lt;<a href="#multiple">multiple</a>&gt; </span><span>values</span></li></ul></div></div><hr class=""><div class="method "><h3 id="SchemaString-lowercase">SchemaString#lowercase()</h3><p>Adds a lowercase setter</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.lowercase = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.set(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
    <span class="keyword">return</span> v.toLowerCase();
  });
};</code></pre></div></div><hr class=""><div class="method "><h3 id="SchemaString-uppercase">SchemaString#uppercase()</h3><p>Adds an uppercase setter</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.uppercase = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.set(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
    <span class="keyword">return</span> v.toUpperCase();
  });
};</code></pre></div></div><hr class=""><div class="method "><h3 id="SchemaString-trim">SchemaString#trim()</h3><p>Adds a trim setter</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.trim = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.set(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
    <span class="keyword">return</span> v.trim();
  });
};</code></pre></div></div><hr class=""><div class="method "><h3 id="SchemaString-match">SchemaString#match(<code>regular</code>)</h3><p>Sets a regexp test</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.match = <span class="function"><span class="keyword">function</span> <span class="title">match</span> <span class="params">(regExp)</span> {</span>
  <span class="keyword">this</span>.validators.push([<span class="keyword">function</span>(v){
    <span class="keyword">return</span> <span class="literal">null</span> != v &amp;&amp; <span class="string">''</span> !== v
      ? regExp.test(v)
      : <span class="literal">true</span>
  }, <span class="string">'regexp'</span>]);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>regular</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/RegExp">RegExp</a>&gt; </span><span>expression to test against</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="SchemaString-checkRequired">SchemaString#checkRequired()</h3><p>Check required</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="title">checkRequired</span> <span class="params">(value)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, <span class="literal">true</span>)) {
    <span class="keyword">return</span> <span class="literal">null</span> != value;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> (value <span class="keyword">instanceof</span> String || <span class="keyword">typeof</span> value == <span class="string">'string'</span>) &amp;&amp; value.length;
  }
};</code></pre></div></div><hr class="private"><div class="method private"><h3 id="SchemaString-cast">SchemaString#cast()</h3><p>Casts to String</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.cast = <span class="function"><span class="keyword">function</span> <span class="params">(value, scope, init)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, init)) <span class="keyword">return</span> value;
  <span class="keyword">if</span> (value === <span class="literal">null</span>) <span class="keyword">return</span> value;
  <span class="keyword">if</span> (<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> value &amp;&amp; value.toString) <span class="keyword">return</span> value.toString();
  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'string'</span>, value);
};

<span class="function"><span class="keyword">function</span> <span class="title">handleSingle</span> <span class="params">(val)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.castForQuery(val);
}

<span class="function"><span class="keyword">function</span> <span class="title">handleArray</span> <span class="params">(val)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">return</span> val.map(<span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
    <span class="keyword">return</span> self.castForQuery(m);
  });
}

SchemaString.prototype.$conditionalHandlers = {
    <span class="string">'$ne'</span> : handleSingle
  , <span class="string">'$in'</span> : handleArray
  , <span class="string">'$nin'</span>: handleArray
  , <span class="string">'$gt'</span> : handleSingle
  , <span class="string">'$lt'</span> : handleSingle
  , <span class="string">'$gte'</span>: handleSingle
  , <span class="string">'$lte'</span>: handleSingle
  , <span class="string">'$all'</span>: handleArray
  , <span class="string">'$regex'</span>: handleSingle
  , <span class="string">'$options'</span>: handleSingle
};

SchemaString.prototype.castForQuery = <span class="function"><span class="keyword">function</span> <span class="params">($conditional, val)</span> {</span>
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler)
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Can't use "</span> + $conditional + <span class="string">" with String."</span>);
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  } <span class="keyword">else</span> {
    val = $conditional;
    <span class="keyword">if</span> (val <span class="keyword">instanceof</span> RegExp) <span class="keyword">return</span> val;
    <span class="keyword">return</span> <span class="keyword">this</span>.cast(val);
  }
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="SchemaString-cast">SchemaString#cast()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = SchemaString;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schema.js">lib/schema.js</a><div class="method "><h3 id="Schema">Schema(<code>definition</code>)</h3><p>Schema constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Schema</span> <span class="params">(obj, options)</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Schema))
    <span class="keyword">return</span> <span class="keyword">new</span> Schema(obj, options);

  <span class="keyword">this</span>.paths = {};
  <span class="keyword">this</span>.subpaths = {};
  <span class="keyword">this</span>.virtuals = {};
  <span class="keyword">this</span>.nested = {};
  <span class="keyword">this</span>.inherits = {};
  <span class="keyword">this</span>.callQueue = [];
  <span class="keyword">this</span>._indexes = [];
  <span class="keyword">this</span>.methods = {};
  <span class="keyword">this</span>.statics = {};
  <span class="keyword">this</span>.tree = {};
  <span class="keyword">this</span>._requiredpaths = <span class="literal">undefined</span>;

  <span class="comment">// set options</span>
  <span class="keyword">this</span>.options = utils.options({
      safe: <span class="literal">true</span>
    , strict: <span class="literal">true</span>
    , capped: <span class="literal">false</span> <span class="comment">// { size, max, autoIndexId }</span>
    , versionKey: <span class="string">'__v'</span>
    , minimize: <span class="literal">true</span>
    , autoIndex: <span class="literal">true</span>
  }, options);

  <span class="comment">// build paths</span>
  <span class="keyword">if</span> (obj) {
    <span class="keyword">this</span>.add(obj);
  }

  <span class="keyword">if</span> (!<span class="keyword">this</span>.paths[<span class="string">'_id'</span>] &amp;&amp; !<span class="keyword">this</span>.options.noId) {
    <span class="keyword">this</span>.add({ _id: {type: ObjectId, auto: <span class="literal">true</span>} });
  }

  <span class="keyword">if</span> (!<span class="keyword">this</span>.paths[<span class="string">'id'</span>] &amp;&amp; !<span class="keyword">this</span>.options.noVirtualId) {
    <span class="keyword">this</span>.virtual(<span class="string">'id'</span>).get(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.__id) {
        <span class="keyword">return</span> <span class="keyword">this</span>.__id;
      }

      <span class="keyword">return</span> <span class="keyword">this</span>.__id = <span class="literal">null</span> == <span class="keyword">this</span>._id
        ? <span class="literal">null</span>
        : <span class="keyword">this</span>._id.toString();
    });
  }

  <span class="keyword">delete</span> <span class="keyword">this</span>.options.noVirtualId;

  <span class="comment">// versioning not directly added to schema b/c we only want</span>
  <span class="comment">// it in the top level document, not embedded ones.</span>
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>definition</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema">Schema()</h3><p>Inherit from EventEmitter.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.__proto__ = EventEmitter.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3>MISSING method name</h3><p>Schema by paths</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.paths;</code></pre></div><p>Example (embedded doc):<br />   {<br />       'test'       : SchemaType,<br />     , 'test.test'  : SchemaType,<br />     , 'first_name' : SchemaType<br />   }</p></div><hr class="private"><div class="method private"><h3>MISSING method name</h3><p>Schema as a tree</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.tree;</code></pre></div><h2>Example</h2>

<p>{<br />       '_id'     : ObjectId<br />     , 'nested'  : {<br />           'key': String<br />       }<br />   }</p></div><hr class="private"><div class="method "><h3 id="Schema-add">Schema#add(<code>keys</code>, <code>prefix</code>)</h3><p>Sets the keys</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.add = <span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">(obj, prefix)</span> {</span>
  prefix = prefix || <span class="string">''</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> obj) {
    <span class="keyword">if</span> (<span class="literal">null</span> == obj[i]) {
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid value for schema path `'</span>+ prefix + i +<span class="string">'`'</span>);
    }

    <span class="keyword">if</span> (obj[i].constructor.name == <span class="string">'Object'</span> &amp;&amp; (!obj[i].type || obj[i].type.type)) {
      <span class="keyword">if</span> (Object.keys(obj[i]).length) {
        <span class="comment">// nested object { last: { name: String }}</span>
        <span class="keyword">this</span>.nested[prefix + i] = <span class="literal">true</span>;
        <span class="keyword">this</span>.add(obj[i], prefix + i + <span class="string">'.'</span>);
      }
      <span class="keyword">else</span>
        <span class="keyword">this</span>.path(prefix + i, obj[i]); <span class="comment">// mixed type</span>
    } <span class="keyword">else</span>
      <span class="keyword">this</span>.path(prefix + i, obj[i]);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>keys</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>prefix</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-add">Schema#add()</h3><p>Reserved document keys.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> reserved = Object.create(<span class="literal">null</span>);
reserved.on =
reserved.db =
reserved.init =
reserved.isNew =
reserved.errors =
reserved.schema =
reserved.modelName =
reserved.collection = <span class="number">1</span>;</code></pre></div><p>Keys in this object are names that are rejected<br />in schema declarations b/c they conflict with<br />mongoose functionality.</p></div><hr class=""><div class="method "><h3 id="Schema-path">Schema#path(<code>path</code>, <code>constructor</code>)</h3><p>Sets a path (if arity 2)<br />Gets a path (if arity 1)</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.path = <span class="function"><span class="keyword">function</span> <span class="params">(path, obj)</span> {</span>
  <span class="keyword">if</span> (obj == <span class="literal">undefined</span>) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.paths[path]) <span class="keyword">return</span> <span class="keyword">this</span>.paths[path];
    <span class="keyword">if</span> (<span class="keyword">this</span>.subpaths[path]) <span class="keyword">return</span> <span class="keyword">this</span>.subpaths[path];

    <span class="comment">// subpaths?</span>
    <span class="keyword">return</span> <span class="regexp">/\.\d+\.?/</span>.test(path)
      ? getPositionalPath(<span class="keyword">this</span>, path)
      : <span class="literal">undefined</span>;
  }

  <span class="comment">// some path names conflict with document methods</span>
  <span class="keyword">if</span> (reserved[path]) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"`"</span> + path + <span class="string">"` may not be used as a schema pathname"</span>);
  }

  <span class="comment">// update the tree</span>
  <span class="keyword">var</span> subpaths = path.split(<span class="regexp">/\./</span>)
    , last = subpaths.pop()
    , branch = <span class="keyword">this</span>.tree;

  subpaths.forEach(<span class="keyword">function</span>(path) {
    <span class="keyword">if</span> (!branch[path]) branch[path] = {};
    branch = branch[path];
  });

  branch[last] = utils.clone(obj);

  <span class="keyword">this</span>.paths[path] = Schema.interpretAsType(path, obj);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>constructor</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-interpretAsType">function Object() { [native code] }#interpretAsType(<code>path</code>, <code>constructor</code>)</h3><p>Converts -- e.g., Number, [SomeSchema],<br />{ type: String, enum: ['m', 'f'] } -- into<br />the appropriate Mongoose Type, which we use<br />later for casting, validation, etc.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.interpretAsType = function (path, obj) {
  if (obj.constructor.name != 'Object')
    obj = { type: obj };

  // Get the type making sure to allow keys named "type"
  // and default to mixed if not specified.
  // { type: { type: String, default: 'freshcut' } }
  var type = obj.type &amp;&amp; !obj.type.type
    ? obj.type
    : {};

  if ('Object' == type.constructor.name || 'mixed' == type) {
    return new Types.Mixed(path, obj);
  }

  if (Array.isArray(type) || Array == type || 'array' == type) {
    // if it was specified through { type } look for `cast`
    var cast = (Array == type || 'array' == type)
      ? obj.cast
      : type[0];

    if (cast instanceof Schema) {
      return new Types.DocumentArray(path, cast, obj);
    }

    if ('string' == typeof cast) {
      cast = Types[cast.charAt(0).toUpperCase() + cast.substring(1)];
    } else if (cast &amp;&amp; !cast.type
                    &amp;&amp; 'Object' == cast.constructor.name
                    &amp;&amp; Object.keys(cast).length) {
      return new Types.DocumentArray(path, new Schema(cast), obj);
    }

    return new Types.Array(path, cast || Types.Mixed, obj);
  }

  var name = 'string' == typeof type
    ? type
    : type.name;

  if (name) {
    name = name.charAt(0).toUpperCase() + name.substring(1);
  }

  if (undefined == Types[name]) {
    throw new TypeError('Undefined type at `' + path +
        '`
  Did you try nesting Schemas? ' +
        'You can only nest using refs or arrays.');
  }

  return new Types[name](path, obj);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>constructor</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-eachPath">Schema#eachPath(<code>callback</code>)</h3><p>Iterates through the schema's paths, passing the path string and type object<br />to the callback.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.eachPath = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">var</span> keys = Object.keys(<span class="keyword">this</span>.paths)
    , len = keys.length;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) {
    fn(keys[i], <span class="keyword">this</span>.paths[keys[i]]);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>function - fn(pathstring, type)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Schema">Schema</a>&gt; </span><span>this for chaining</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-requiredPaths">Schema#requiredPaths()</h3><p>Returns an Array of path strings that are required.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.requiredPaths = <span class="function"><span class="keyword">function</span> <span class="title">requiredPaths</span> <span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._requiredpaths) <span class="keyword">return</span> <span class="keyword">this</span>._requiredpaths;

  <span class="keyword">var</span> paths = Object.keys(<span class="keyword">this</span>.paths)
    , i = paths.length
    , ret = [];

  <span class="keyword">while</span> (i--) {
    <span class="keyword">var</span> path = paths[i];
    <span class="keyword">if</span> (<span class="keyword">this</span>.paths[path].isRequired) ret.push(path);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>._requiredpaths = ret;
}</code></pre></div></div><hr class=""><div class="method "><h3 id="Schema-pathType">Schema#pathType(<code>path</code>)</h3><p>Given a path, returns whether it is a real, virtual,<br />nested, or ad-hoc/undefined path.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.pathType = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.paths) <span class="keyword">return</span> <span class="string">'real'</span>;
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.virtuals) <span class="keyword">return</span> <span class="string">'virtual'</span>;
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.nested) <span class="keyword">return</span> <span class="string">'nested'</span>;
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.subpaths) <span class="keyword">return</span> <span class="string">'real'</span>;

  <span class="keyword">if</span> (<span class="regexp">/\.\d+\.?/</span>.test(path) &amp;&amp; getPositionalPath(<span class="keyword">this</span>, path)) {
    <span class="keyword">return</span> <span class="string">'real'</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> <span class="string">'adhocOrUndefined'</span>
  }
};

<span class="function"><span class="keyword">function</span> <span class="title">getPositionalPath</span> <span class="params">(self, path)</span> {</span>
  <span class="keyword">var</span> subpaths = path.split(<span class="regexp">/\.(\d+)\.?/</span>).filter(Boolean);
  <span class="keyword">if</span> (subpaths.length &lt; <span class="number">2</span>) {
    <span class="keyword">return</span> self.paths[subpaths[<span class="number">0</span>]];
  }

  <span class="keyword">var</span> val = self.path(subpaths[<span class="number">0</span>])
    , last = subpaths.length - <span class="number">1</span>
    , subpath;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; subpaths.length; ++i) {
    <span class="keyword">var</span> subpath = subpaths[i];

    <span class="keyword">if</span> (i === last &amp;&amp;
        val &amp;&amp;
        !val.schema &amp;&amp;
        !<span class="regexp">/\D/</span>.test(subpath) &amp;&amp;
        val <span class="keyword">instanceof</span> Types.Array) {
      <span class="comment">// StringSchema, NumberSchema, etc</span>
      val = val.caster;
      <span class="keyword">continue</span>;
    }

    <span class="comment">// 'path.0.subpath'</span>
    <span class="keyword">if</span> (!<span class="regexp">/\D/</span>.test(subpath)) <span class="keyword">continue</span>;
    val = val.schema.path(subpath);
  }

  <span class="keyword">return</span> self.subpaths[path] = val;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method private"><h3 id="Schema-queue">Schema#queue(<code>method</code>, <code>arguments</code>)</h3><p>Adds a method call to the queue</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.queue = <span class="keyword">function</span>(name, args){
  <span class="keyword">this</span>.callQueue.push([name, args]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name</span></li><li><code>arguments</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="Schema-pre">Schema#pre(<code>method</code>, <code>callback</code>)</h3><p>Defines a pre for the document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.pre = <span class="keyword">function</span>(){
  <span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="string">'pre'</span>, arguments);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-post">Schema#post(<code>method</code>, <code>callback</code>)</h3><p>Defines a post for the document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.post = <span class="keyword">function</span>(method, fn){
  <span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="string">'on'</span>, arguments);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-plugin">Schema#plugin(<code>plugin</code>)</h3><p>Registers a plugin for this schema</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.plugin = <span class="function"><span class="keyword">function</span> <span class="params">(fn, opts)</span> {</span>
  fn(<span class="keyword">this</span>, opts);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>plugin</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>callback</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-method">Schema#method(<code>method</code>, <code>handler</code>)</h3><p>Adds a method</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.method = <span class="function"><span class="keyword">function</span> <span class="params">(name, fn)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> name)
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> name)
      <span class="keyword">this</span>.methods[i] = name[i];
  <span class="keyword">else</span>
    <span class="keyword">this</span>.methods[name] = fn;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name</span></li><li><code>handler</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-static">Schema#static(<code>name</code>, <code>handler</code>)</h3><p>Defines a static method</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.static = <span class="keyword">function</span>(name, fn) {
  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> name)
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> name)
      <span class="keyword">this</span>.statics[i] = name[i];
  <span class="keyword">else</span>
    <span class="keyword">this</span>.statics[name] = fn;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>handler</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-index">Schema#index(<code>field</code>, <code>optional</code>)</h3><p>Defines an index (most likely compound)</p>

<h2>Example</h2>

<p>schema.index({ first: 1, last: -1 })</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.index = <span class="function"><span class="keyword">function</span> <span class="params">(fields, options)</span> {</span>
  <span class="keyword">this</span>._indexes.push([fields, options || {}]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>field</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>optional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options object</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-set">Schema#set(<code>key</code>, <code>optional</code>)</h3><p>Sets/gets an option</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.set = <span class="function"><span class="keyword">function</span> <span class="params">(key, value)</span> {</span>
  <span class="keyword">if</span> (arguments.length == <span class="number">1</span>)
    <span class="keyword">return</span> <span class="keyword">this</span>.options[key];
  <span class="keyword">this</span>.options[key] = value;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>optional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>value</span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-indexes">Schema#indexes()</h3><p>Compiles indexes from fields and schema-level indexes</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.indexes = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> indexes = []
    , seenSchemas = [];

  collectIndexes(<span class="keyword">this</span>);

  <span class="keyword">return</span> indexes;

  <span class="function"><span class="keyword">function</span> <span class="title">collectIndexes</span> <span class="params">(schema, prefix)</span> {</span>
    <span class="keyword">if</span> (~seenSchemas.indexOf(schema)) <span class="keyword">return</span>;
    seenSchemas.push(schema);

    <span class="keyword">var</span> index;
    <span class="keyword">var</span> paths = schema.paths;
    prefix = prefix || <span class="string">''</span>;

    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> paths) {
      <span class="keyword">if</span> (paths[i]) {
        <span class="keyword">if</span> (paths[i] <span class="keyword">instanceof</span> Types.DocumentArray) {
          collectIndexes(paths[i].schema, i + <span class="string">'.'</span>);
        } <span class="keyword">else</span> {
          index = paths[i]._index;

          <span class="keyword">if</span> (index !== <span class="literal">false</span> &amp;&amp; index !== <span class="literal">null</span>){
            <span class="keyword">var</span> field = {};
            field[prefix + i] = <span class="string">'2d'</span> === index ? index : <span class="number">1</span>;
            <span class="keyword">var</span> options = <span class="string">'Object'</span> === index.constructor.name ? index : {};
            <span class="keyword">if</span> (!(<span class="string">'background'</span> <span class="keyword">in</span> options)) options.background = <span class="literal">true</span>;
            indexes.push([field, options]);
          }
        }
      }
    }

    <span class="keyword">if</span> (prefix) {
      fixSubIndexPaths(schema, prefix);
    } <span class="keyword">else</span> {
      schema._indexes.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(index)</span> {</span>
        <span class="keyword">if</span> (!(<span class="string">'background'</span> <span class="keyword">in</span> index[<span class="number">1</span>])) index[<span class="number">1</span>].background = <span class="literal">true</span>;
      });
      indexes = indexes.concat(schema._indexes);
    }
  }</code></pre></div></div><hr class=""><div class="method "><h3 id="fixSubIndexPaths">fixSubIndexPaths()</h3><p>Checks for indexes added to subdocs using Schema.index().<br />These indexes need their paths prefixed properly.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">fixSubIndexPaths</span> <span class="params">(schema, prefix)</span> {</span>
    <span class="keyword">var</span> subindexes = schema._indexes
      , len = subindexes.length
      , indexObj
      , newindex
      , klen
      , keys
      , key
      , i = <span class="number">0</span>
      , j

    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; ++i) {
      indexObj = subindexes[i][<span class="number">0</span>];
      keys = Object.keys(indexObj);
      klen = keys.length;
      newindex = {};

      <span class="comment">// use forward iteration, order matters</span>
      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; klen; ++j) {
        key = keys[j];
        newindex[prefix + key] = indexObj[key];
      }

      indexes.push([newindex, subindexes[i][<span class="number">1</span>]]);
    }
  }

}</code></pre></div><p>schema._indexes = [ [indexObj, options], [indexObj, options] ..]</p></div><hr class=""><div class="method "><h3 id="Schema-virtual">Schema#virtual(<code>name</code>)</h3><p>Retrieves or creates the virtual type with the given name.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.virtual = <span class="function"><span class="keyword">function</span> <span class="params">(name, options)</span> {</span>
  <span class="keyword">var</span> virtuals = <span class="keyword">this</span>.virtuals;
  <span class="keyword">var</span> parts = name.split(<span class="string">'.'</span>);
  <span class="keyword">return</span> virtuals[name] = parts.reduce(<span class="function"><span class="keyword">function</span> <span class="params">(mem, part, i)</span> {</span>
    mem[part] || (mem[part] = (i === parts.length-<span class="number">1</span>)
                            ? <span class="keyword">new</span> VirtualType(options)
                            : {});
    <span class="keyword">return</span> mem[part];
  }, <span class="keyword">this</span>.tree);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#VirtualType">VirtualType</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="Schema-virtualpath">Schema#virtualpath(<code>name</code>)</h3><p>Fetches the virtual type with the given name.<br />Should be distinct from virtual because virtual auto-defines a new VirtualType<br />if the path doesn't exist.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.virtualpath = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.virtuals[name];
};

Schema.prototype.namedScope = <span class="function"><span class="keyword">function</span> <span class="params">(name, fn)</span> {</span>
  <span class="keyword">var</span> namedScopes = <span class="keyword">this</span>.namedScopes || (<span class="keyword">this</span>.namedScopes = <span class="keyword">new</span> NamedScope)
    , newScope = Object.create(namedScopes)
    , allScopes = namedScopes.scopesByName || (namedScopes.scopesByName = {});
  allScopes[name] = newScope;
  newScope.name = name;
  newScope.block = fn;
  newScope.query = <span class="keyword">new</span> Query();
  newScope.decorate(namedScopes, {
    block0: <span class="function"><span class="keyword">function</span> <span class="params">(block)</span> {</span>
      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        block.call(<span class="keyword">this</span>.query);
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };
    },
    blockN: <span class="function"><span class="keyword">function</span> <span class="params">(block)</span> {</span>
      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        block.apply(<span class="keyword">this</span>.query, arguments);
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };
    },
    basic: <span class="function"><span class="keyword">function</span> <span class="params">(query)</span> {</span>
      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">this</span>.query.find(query);
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };
    }
  });
  <span class="keyword">return</span> newScope;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#VirtualType">VirtualType</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="ObjectId">ObjectId()</h3><p>ObjectId schema identifier. Not an actual ObjectId, only used for Schemas.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ObjectId</span> <span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'This is an abstract interface. Its only purpose is to mark '</span>
                + <span class="string">'fields as ObjectId in the schema creation.'</span>);
}</code></pre></div></div><hr class=""><div class="method "><h3 id="ObjectId">ObjectId()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = exports = Schema;

<span class="comment">// require down here because of reference issues</span>
exports.Types = Types = require(<span class="string">'./schema/index'</span>);
NamedScope = require(<span class="string">'./namedscope'</span>)
Query = require(<span class="string">'./query'</span>);

exports.ObjectId = ObjectId;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schemadefault.js">lib/schemadefault.js</a><div class="method "><h3>MISSING method name</h3><p>Default model for querying the system.profiles<br />collection (it only exists when profiling is<br />enabled.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports[<span class="string">'system.profile'</span>] = <span class="keyword">new</span> Schema({
    ts: Date
  , info: String <span class="comment">// deprecated</span>
  , millis: Number
  , op: String
  , ns: String
  , query: Schema.Types.Mixed
  , updateobj: Schema.Types.Mixed
  , ntoreturn: Number
  , nreturned: Number
  , nscanned: Number
  , responseLength: Number
  , client: String
  , user: String
  , idhack: Boolean
  , scanAndOrder: Boolean
  , keyUpdates: Number
  , cursorid: Number
}, { noVirtualId: <span class="literal">true</span>, noId: <span class="literal">true</span> });</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/schematype.js">lib/schematype.js</a><div class="method "><h3 id="SchemaType">SchemaType(<code>path</code>)</h3><p>SchemaType constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaType</span> <span class="params">(path, options, instance)</span> {</span>
  <span class="keyword">this</span>.path = path;
  <span class="keyword">this</span>.instance = instance;
  <span class="keyword">this</span>.validators = [];
  <span class="keyword">this</span>.setters = [];
  <span class="keyword">this</span>.getters = [];
  <span class="keyword">this</span>.options = options;
  <span class="keyword">this</span>._index = <span class="literal">null</span>;
  <span class="keyword">this</span>.selected;

  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> options) <span class="keyword">if</span> (<span class="keyword">this</span>[i] &amp;&amp; <span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="keyword">this</span>[i]) {
    <span class="comment">// { unique: true, index: true }</span>
    <span class="keyword">if</span> (<span class="string">'index'</span> == i &amp;&amp; <span class="keyword">this</span>._index) <span class="keyword">continue</span>;

    <span class="keyword">var</span> opts = Array.isArray(options[i])
      ? options[i]
      : [options[i]];

    <span class="keyword">this</span>[i].apply(<span class="keyword">this</span>, opts);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="SchemaType-default">SchemaType#default(<code>default</code>)</h3><p>Sets a default</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.<span class="keyword">default</span> = <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
  <span class="keyword">if</span> (<span class="number">1</span> === arguments.length) {
    <span class="keyword">this</span>.defaultValue = <span class="keyword">typeof</span> val === <span class="string">'function'</span>
      ? val
      : <span class="keyword">this</span>.cast(val);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length > <span class="number">1</span>) {
    <span class="keyword">this</span>.defaultValue = utils.args(arguments);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.defaultValue;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>default</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>value</span></li></ul></div></div><hr class=""><div class="method "><h3 id="SchemaType-index">SchemaType#index(<code>true/</code>)</h3><p>Sets index. It can be a boolean or a hash of options</p>

<h2>Example</h2>

<p>Schema.path('my.path').index(true);<br />   Schema.path('my.path').index({ unique: true });</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.index = <span class="function"><span class="keyword">function</span> <span class="params">(index)</span> {</span>
  <span class="keyword">this</span>._index = index;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>true/</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><p>"Direction doesn't matter for single key indexes"<br /><a href='http://www.mongodb.org/display/DOCS/Indexes#Indexes-CompoundKeysIndexes'>http://www.mongodb.org/display/DOCS/Indexes#Indexes-CompoundKeysIndexes</a></p></div><hr class=""><div class="method private"><h3 id="SchemaType-unique">SchemaType#unique(<code></code>)</h3><p>Adds an unique index</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.unique = <span class="function"><span class="keyword">function</span> <span class="params">(bool)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>._index || <span class="string">'Object'</span> !== <span class="keyword">this</span>._index.constructor.name) {
    <span class="keyword">this</span>._index = {};
  }

  <span class="keyword">this</span>._index.unique = bool;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="SchemaType-sparse">SchemaType#sparse(<code></code>)</h3><p>Adds an unique index</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.sparse = <span class="function"><span class="keyword">function</span> <span class="params">(bool)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>._index || <span class="string">'Object'</span> !== <span class="keyword">this</span>._index.constructor.name) {
    <span class="keyword">this</span>._index = {};
  }

  <span class="keyword">this</span>._index.sparse = bool;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaType-set">SchemaType#set(<code>setter</code>)</h3><p>Adds a setter</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.set = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> != <span class="keyword">typeof</span> fn)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'A setter must be a function.'</span>);
  <span class="keyword">this</span>.setters.push(fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>setter</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="SchemaType-get">SchemaType#get(<code>getter</code>)</h3><p>Adds a getter</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.get = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> != <span class="keyword">typeof</span> fn)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'A getter must be a function.'</span>);
  <span class="keyword">this</span>.getters.push(fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>getter</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="SchemaType-validate">SchemaType#validate(<code>validator</code>, <code>optional</code>)</h3><h2>validate</h2><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.validate = <span class="function"><span class="keyword">function</span> <span class="params">(obj, error)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> obj || obj &amp;&amp; <span class="string">'RegExp'</span> === obj.constructor.name) {
    <span class="keyword">this</span>.validators.push([obj, error]);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> i = arguments.length
    , arg

  <span class="keyword">while</span> (i--) {
    arg = arguments[i];
    <span class="keyword">this</span>.validators.push([arg.validator, arg.msg]);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>validator</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>optional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>error message</span></li></ul></div><p>Adds validators.</p>

<h2>Examples</h2>

<pre><code><span class="function"><span class="keyword">function</span> <span class="title">validator</span> <span class="params">()</span> {</span> ... }

<span class="keyword">var</span> single = [validator, <span class="string">'failed'</span>]
<span class="keyword">new</span> Schema({ name: { type: String, validate: single }});

<span class="keyword">var</span> many = [
    { validator: validator, msg: <span class="string">'uh oh'</span> }
  , { validator: fn, msg: <span class="string">'failed'</span> }
]
<span class="keyword">new</span> Schema({ name: { type: String, validate: many }});</code></pre></div><hr class=""><div class="method "><h3 id="SchemaType-required">SchemaType#required(<code>enable/disable</code>)</h3><p>Adds a required validator</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.required = <span class="function"><span class="keyword">function</span> <span class="params">(required)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">__checkRequired</span> <span class="params">(v)</span> {</span>
    <span class="comment">// in here, `this` refers to the validating document.</span>
    <span class="comment">// no validation when this path wasn't selected in the query.</span>
    <span class="keyword">if</span> (<span class="string">'isSelected'</span> <span class="keyword">in</span> <span class="keyword">this</span> &amp;&amp;
        !<span class="keyword">this</span>.isSelected(self.path) &amp;&amp;
        !<span class="keyword">this</span>.isModified(self.path)) <span class="keyword">return</span> <span class="literal">true</span>;
    <span class="keyword">return</span> self.checkRequired(v);
  }

  <span class="keyword">if</span> (<span class="literal">false</span> === required) {
    <span class="keyword">this</span>.isRequired = <span class="literal">false</span>;
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
      <span class="keyword">return</span> v[<span class="number">0</span>].name !== <span class="string">'__checkRequired'</span>;
    });
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.isRequired = <span class="literal">true</span>;
    <span class="keyword">this</span>.validators.push([__checkRequired, <span class="string">'required'</span>]);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>enable/disable</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>the validator</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="SchemaType-getDefault">SchemaType#getDefault(<code>scope</code>)</h3><p>Gets the default value</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.getDefault = <span class="function"><span class="keyword">function</span> <span class="params">(scope, init)</span> {</span>
  <span class="keyword">var</span> ret = <span class="string">'function'</span> === <span class="keyword">typeof</span> <span class="keyword">this</span>.defaultValue
    ? <span class="keyword">this</span>.defaultValue.call(scope)
    : <span class="keyword">this</span>.defaultValue;

  <span class="keyword">if</span> (<span class="literal">null</span> !== ret &amp;&amp; <span class="literal">undefined</span> !== ret) {
    <span class="keyword">return</span> <span class="keyword">this</span>.cast(ret, scope, init);
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> ret;
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>for callback defaults</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="SchemaType-applySetters">SchemaType#applySetters(<code>value</code>, <code>scope</code>)</h3><p>Applies setters</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.applySetters = <span class="function"><span class="keyword">function</span> <span class="params">(value, scope, init)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, init)) <span class="keyword">return</span> value;

  <span class="keyword">var</span> v = value
    , setters = <span class="keyword">this</span>.setters
    , len = setters.length

  <span class="keyword">if</span> (!len) {
    <span class="keyword">if</span> (<span class="literal">null</span> === v || <span class="literal">undefined</span> === v) <span class="keyword">return</span> v;
    <span class="keyword">return</span> init
      ? v <span class="comment">// if we just initialized we dont recast</span>
      : <span class="keyword">this</span>.cast(v, scope, init)
  }

  <span class="keyword">while</span> (len--) {
    v = setters[len].call(scope, v, <span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (<span class="literal">null</span> === v || <span class="literal">undefined</span> === v) <span class="keyword">return</span> v;

  <span class="comment">// do not cast until all setters are applied #665</span>
  v = <span class="keyword">this</span>.cast(v, scope);

  <span class="keyword">return</span> v;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="SchemaType-applyGetters">SchemaType#applyGetters(<code>value</code>, <code>scope</code>)</h3><p>Applies getters to a value</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.applyGetters = <span class="function"><span class="keyword">function</span> <span class="params">(value, scope)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, <span class="literal">true</span>)) <span class="keyword">return</span> value;

  <span class="keyword">var</span> v = value
    , getters = <span class="keyword">this</span>.getters
    , len = getters.length;

  <span class="keyword">if</span> (!len) {
    <span class="keyword">return</span> v;
  }

  <span class="keyword">while</span> (len--) {
    v = getters[len].call(scope, v, <span class="keyword">this</span>);
  }

  <span class="keyword">return</span> v;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="SchemaType-select">SchemaType#select()</h3><h2>select</h2><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.select = <span class="function"><span class="keyword">function</span> <span class="title">select</span> <span class="params">(val)</span> {</span>
  <span class="keyword">this</span>.selected = !! val;
}</code></pre></div><p>Set default select() behavior for this path. True if<br />this path should always be included in the results,<br />false if it should be excluded by default. This setting<br />can be overridden at the query level.</p>

<pre><code>T = db.model(<span class="string">'T'</span>, <span class="keyword">new</span> Schema({ x: { type: String, select: <span class="literal">true</span> }}));
T.find(..); <span class="comment">// x will always be selected ..</span>
<span class="comment">// .. unless overridden;</span>
T.find().select({ x: <span class="number">0</span> }).exec();</code></pre></div><hr class=""><div class="method private"><h3 id="SchemaType-doValidate">SchemaType#doValidate(<code>callback</code>, <code>scope</code>)</h3><p>Performs a validation</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.doValidate = <span class="function"><span class="keyword">function</span> <span class="params">(value, fn, scope)</span> {</span>
  <span class="keyword">var</span> err = <span class="literal">false</span>
    , path = <span class="keyword">this</span>.path
    , count = <span class="keyword">this</span>.validators.length;

  <span class="keyword">if</span> (!count) <span class="keyword">return</span> fn(<span class="literal">null</span>);

  <span class="function"><span class="keyword">function</span> <span class="title">validate</span> <span class="params">(val, msg)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span>;
    <span class="keyword">if</span> (val === <span class="literal">undefined</span> || val) {
      --count || fn(<span class="literal">null</span>);
    } <span class="keyword">else</span> {
      fn(err = <span class="keyword">new</span> ValidatorError(path, msg));
    }
  }

  <span class="keyword">this</span>.validators.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
    <span class="keyword">var</span> validator = v[<span class="number">0</span>]
      , message   = v[<span class="number">1</span>];

    <span class="keyword">if</span> (validator <span class="keyword">instanceof</span> RegExp) {
      validate(validator.test(value), message);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> validator) {
      <span class="keyword">if</span> (<span class="number">2</span> === validator.length) {
        validator.call(scope, value, <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
          validate(val, message);
        });
      } <span class="keyword">else</span> {
        validate(validator.call(scope, value), message);
      }
    }
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="function Object() { [native code] }-_isRef">function Object() { [native code] }#_isRef(<code>self</code>, <code>value</code>, <code>init</code>, <code>instance</code>)</h3><p>Determines if value is a valid Reference.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType._isRef = <span class="function"><span class="keyword">function</span> <span class="params">(self, value, init)</span> {</span>
  <span class="keyword">if</span> (init &amp;&amp; self.options &amp;&amp; self.options.ref) {
    <span class="keyword">if</span> (<span class="literal">null</span> == value) <span class="keyword">return</span> <span class="literal">true</span>;
    <span class="keyword">if</span> (value._id &amp;&amp; value._id.constructor.name === self.instance) <span class="keyword">return</span> <span class="literal">true</span>;
  }

  <span class="keyword">return</span> <span class="literal">false</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>self</code><span class="types"> &lt;<a href="#SchemaType">SchemaType</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="#object">object</a>&gt; </span><span></span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li><li><code>instance</code><span class="types"> &lt;<a href="#MongooseType">MongooseType</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method private"><h3 id="ValidatorError">ValidatorError(<code>path</code>, <code>msg</code>)</h3><p>Schema validator error</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ValidatorError</span> <span class="params">(path, type)</span> {</span>
  <span class="keyword">var</span> msg = type
    ? <span class="string">'"'</span> + type + <span class="string">'" '</span>
    : <span class="string">''</span>;
  MongooseError.call(<span class="keyword">this</span>, <span class="string">'Validator '</span> + msg + <span class="string">'failed for path '</span> + path);
  Error.captureStackTrace(<span class="keyword">this</span>, arguments.callee);
  <span class="keyword">this</span>.name = <span class="string">'ValidatorError'</span>;
  <span class="keyword">this</span>.path = path;
  <span class="keyword">this</span>.type = type;
};

ValidatorError.prototype.toString = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.message;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>msg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="ValidatorError">ValidatorError()</h3><p>Inherits from MongooseError</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ValidatorError.prototype.__proto__ = MongooseError.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="CastError">CastError()</h3><p>Cast error</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">CastError</span> <span class="params">(type, value)</span> {</span>
  MongooseError.call(<span class="keyword">this</span>, <span class="string">'Cast to '</span> + type + <span class="string">' failed for value "'</span> + value + <span class="string">'"'</span>);
  Error.captureStackTrace(<span class="keyword">this</span>, arguments.callee);
  <span class="keyword">this</span>.name = <span class="string">'CastError'</span>;
  <span class="keyword">this</span>.type = type;
  <span class="keyword">this</span>.value = value;
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="CastError">CastError()</h3><p>Inherits from MongooseError.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">CastError.prototype.__proto__ = MongooseError.prototype;</code></pre></div></div><hr class=""><div class="method "><h3 id="CastError">CastError()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = exports = SchemaType;

exports.CastError = CastError;

exports.ValidatorError = ValidatorError;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/statemachine.js">lib/statemachine.js</a><div class="method private"><h3>()</h3><p>StateMachine represents a minimal <code>interface</code> for the<br />constructors it builds via StateMachine.ctor(...).</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> StateMachine = module.exports = exports = <span class="function"><span class="keyword">function</span> <span class="title">StateMachine</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.paths = {};
  <span class="keyword">this</span>.states = {};
}</code></pre></div></div><hr class="private"><div class="method "><h3 id="function Object() { [native code] }-ctor">function Object() { [native code] }#ctor(<code>state</code>, <code>[state]</code>)</h3><p>StateMachine.ctor('state1', 'state2', ...)<br />A factory method for subclassing StateMachine.<br />The arguments are a list of states. For each state,<br />the constructor's prototype gets state transition<br />methods named after each state. These transition methods<br />place their path argument into the given state.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StateMachine.ctor = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> states = utils.args(arguments);

  <span class="keyword">var</span> ctor = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    StateMachine.apply(<span class="keyword">this</span>, arguments);
    <span class="keyword">this</span>.stateNames = states;

    <span class="keyword">var</span> i = states.length
      , state;

    <span class="keyword">while</span> (i--) {
      state = states[i];
      <span class="keyword">this</span>.states[state] = {};
    }
  };

  ctor.prototype.__proto__ = StateMachine.prototype;

  states.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(state)</span> {</span>
    <span class="comment">// Changes the `path`'s state to `state`.</span>
    ctor.prototype[state] = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
      <span class="keyword">this</span>._changeState(path, state);
    }
  });

  <span class="keyword">return</span> ctor;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>state</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[state]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span>subclass constructor</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="StateMachine-_changeState">StateMachine#_changeState()</h3><h2>This function is wrapped by the state change functions</h2>

<ul>
<li><code>require(path)</code></li>
<li><code>modify(path)</code></li>
<li><code>init(path)</code></li>
</ul><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StateMachine.prototype._changeState = <span class="function"><span class="keyword">function</span> <span class="title">_changeState</span> <span class="params">(path, nextState)</span> {</span>
  <span class="keyword">var</span> prevBucket = <span class="keyword">this</span>.states[<span class="keyword">this</span>.paths[path]];
  <span class="keyword">if</span> (prevBucket) <span class="keyword">delete</span> prevBucket[path];

  <span class="keyword">this</span>.paths[path] = nextState;
  <span class="keyword">this</span>.states[nextState][path] = <span class="literal">true</span>;
}

StateMachine.prototype.clear = <span class="function"><span class="keyword">function</span> <span class="title">clear</span> <span class="params">(state)</span> {</span>
  <span class="keyword">var</span> keys = Object.keys(<span class="keyword">this</span>.states[state])
    , i = keys.length
    , path

  <span class="keyword">while</span> (i--) {
    path = keys[i];
    <span class="keyword">delete</span> <span class="keyword">this</span>.states[state][path];
    <span class="keyword">delete</span> <span class="keyword">this</span>.paths[path];
  }
}</code></pre></div></div><hr class="private"><div class="method "><h3 id="StateMachine-some">StateMachine#some(<code>state</code>)</h3><p>Checks to see if at least one path is in the states passed in via <code>arguments</code><br />e.g., this.some('required', 'inited')</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StateMachine.prototype.some = <span class="function"><span class="keyword">function</span> <span class="title">some</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">var</span> what = arguments.length ? arguments : <span class="keyword">this</span>.stateNames;
  <span class="keyword">return</span> Array.prototype.some.call(what, <span class="function"><span class="keyword">function</span> <span class="params">(state)</span> {</span>
    <span class="keyword">return</span> Object.keys(self.states[state]).length;
  });
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>state</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>that we want to check for.</span></li></ul></div></div><hr class=""><div class="method private"><h3 id="StateMachine-_iter">StateMachine#_iter(<code>iterMethod</code>)</h3><p>This function builds the functions that get assigned to <code>forEach</code> and <code>map</code>,<br />since both of those methods share a lot of the same logic.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StateMachine.prototype._iter = <span class="function"><span class="keyword">function</span> <span class="title">_iter</span> <span class="params">(iterMethod)</span> {</span>
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> numArgs = arguments.length
      , states = utils.args(arguments, <span class="number">0</span>, numArgs-<span class="number">1</span>)
      , callback = arguments[numArgs-<span class="number">1</span>];

    <span class="keyword">if</span> (!states.length) states = <span class="keyword">this</span>.stateNames;

    <span class="keyword">var</span> self = <span class="keyword">this</span>;

    <span class="keyword">var</span> paths = states.reduce(<span class="function"><span class="keyword">function</span> <span class="params">(paths, state)</span> {</span>
      <span class="keyword">return</span> paths.concat(Object.keys(self.states[state]));
    }, []);

    <span class="keyword">return</span> paths[iterMethod](<span class="function"><span class="keyword">function</span> <span class="params">(path, i, paths)</span> {</span>
      <span class="keyword">return</span> callback(path, i, paths);
    });
  };
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>iterMethod</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>is either 'forEach' or 'map'</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="StateMachine-forEach">StateMachine#forEach(<code>[state]</code>, <code>[state]</code>, <code>callback</code>)</h3><p>Iterates over the paths that belong to one of the parameter states.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StateMachine.prototype.forEach = <span class="function"><span class="keyword">function</span> <span class="title">forEach</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.forEach = <span class="keyword">this</span>._iter(<span class="string">'forEach'</span>);
  <span class="keyword">return</span> <span class="keyword">this</span>.forEach.apply(<span class="keyword">this</span>, arguments);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[state]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[state]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><h2>The function profile can look like</h2>

<p>this.forEach(state1, fn);         // iterates over all paths in state1<br />this.forEach(state1, state2, fn); // iterates over all paths in state1 or state2<br />this.forEach(fn);                 // iterates over all paths in all states</p></div><hr class=""><div class="method "><h3 id="StateMachine-map">StateMachine#map(<code>[state]</code>, <code>[state]</code>, <code>callback</code>)</h3><p>Maps over the paths that belong to one of the parameter states.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StateMachine.prototype.map = <span class="function"><span class="keyword">function</span> <span class="title">map</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.map = <span class="keyword">this</span>._iter(<span class="string">'map'</span>);
  <span class="keyword">return</span> <span class="keyword">this</span>.map.apply(<span class="keyword">this</span>, arguments);
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[state]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[state]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><h2>The function profile can look like</h2>

<p>this.forEach(state1, fn);         // iterates over all paths in state1<br />this.forEach(state1, state2, fn); // iterates over all paths in state1 or state2<br />this.forEach(fn);                 // iterates over all paths in all states</p></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/types/array.js">lib/types/array.js</a><div class="method private"><h3 id="MongooseArray">MongooseArray(<code>values</code>, <code>key</code>, <code>parent</code>)</h3><p>Mongoose Array constructor.<br />Values always have to be passed to the constructor to initialize, since<br />otherwise MongooseArray#push will mark the array as modified to the parent.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseArray</span> <span class="params">(values, path, doc)</span> {</span>
  <span class="keyword">var</span> arr = [];
  arr.push.apply(arr, values);
  arr.__proto__ = MongooseArray.prototype;

  arr._atomics = {};
  arr.validators = [];
  arr._path = path;

  <span class="keyword">if</span> (doc) {
    arr._parent = doc;
    arr._schema = doc.schema.path(path);
  }

  <span class="keyword">return</span> arr;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>values</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>path</span></li><li><code>parent</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span>document</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bit.ly/f6CnZU">http://bit.ly/f6CnZU</a></li></ul></div></div><hr class="private"><div class="method "><h3 id="MongooseArray">MongooseArray()</h3><p>Inherit from Array</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype = <span class="keyword">new</span> Array;</code></pre></div></div><hr class=""><div class="method private"><h3>MISSING method name</h3><p>Stores a queue of atomic operations to perform</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype._atomics;</code></pre></div></div><hr class="private"><div class="method private"><h3>MISSING method name</h3><p>Parent owner document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype._parent;</code></pre></div></div><hr class="private"><div class="method private"><h3 id="MongooseArray-_cast">MongooseArray#_cast()</h3><p>Casts a member</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype._cast = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
  <span class="keyword">var</span> cast = <span class="keyword">this</span>._schema.caster.cast
    , doc = <span class="keyword">this</span>._parent;

  <span class="keyword">return</span> cast.call(<span class="literal">null</span>, value, doc);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="MongooseArray-_markModified">MongooseArray#_markModified(<code>embeddedDoc</code>, <code>embeddedPath</code>)</h3><p>Marks this array as modified.<br />It is called during a nonAtomicPush, an atomic opteration,<br />or by an existing embedded document that is modified.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype._markModified = <span class="function"><span class="keyword">function</span> <span class="params">(embeddedDoc, embeddedPath)</span> {</span>
  <span class="keyword">var</span> parent = <span class="keyword">this</span>._parent
    , dirtyPath;

  <span class="keyword">if</span> (parent) {
    <span class="keyword">if</span> (arguments.length) {
      <span class="comment">// If an embedded doc bubbled up the change</span>
      dirtyPath = [<span class="keyword">this</span>._path, <span class="keyword">this</span>.indexOf(embeddedDoc), embeddedPath].join(<span class="string">'.'</span>);
    } <span class="keyword">else</span> {
      dirtyPath = <span class="keyword">this</span>._path;
    }
    parent.markModified(dirtyPath);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>embeddedDoc</code><span class="types"> &lt;<a href="#EmbeddedDocument">EmbeddedDocument</a>&gt; </span><span>that invokes this method on the Array</span></li><li><code>embeddedPath</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>is what changed inthe embeddedDoc</span></li></ul></div><p>If it bubbles up from an embedded document change,<br />then it takes the following arguments (otherwise, takes<br />0 arguments)</p></div><hr class=""><div class="method private"><h3 id="MongooseArray-_registerAtomic">MongooseArray#_registerAtomic(<code>operation</code>)</h3><p>Register an atomic operation with the parent</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype._registerAtomic = <span class="function"><span class="keyword">function</span> <span class="params">(op, val)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'$set'</span> == op) {
    <span class="comment">// $set takes precedence over all other ops.</span>
    <span class="comment">// mark entire array modified.</span>
    <span class="keyword">this</span>._atomics = { $set: val };
    <span class="keyword">this</span>._markModified();
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> atomics = <span class="keyword">this</span>._atomics;

  <span class="comment">// reset pop/shift after save</span>
  <span class="keyword">if</span> (<span class="string">'$pop'</span> == op &amp;&amp; !(<span class="string">'$pop'</span> <span class="keyword">in</span> atomics)) {
    <span class="keyword">var</span> self = <span class="keyword">this</span>;
    <span class="keyword">this</span>._parent.once(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      self._popped = self._shifted = <span class="literal">null</span>;
    });
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>._atomics.$set) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="comment">// check for impossible $atomic combos (Mongo denies more than one</span>
  <span class="comment">// $atomic op on a single path</span>
  <span class="keyword">if</span> (Object.keys(atomics).length &amp;&amp; !(op <span class="keyword">in</span> atomics)) {
    <span class="comment">// a different op was previously registered.</span>
    <span class="comment">// save the entire thing.</span>
    <span class="keyword">this</span>._atomics = { $set: <span class="keyword">this</span> };
    <span class="keyword">this</span>._markModified();
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">if</span> (op === <span class="string">'$pullAll'</span> || op === <span class="string">'$pushAll'</span> || op === <span class="string">'$addToSet'</span>) {
    atomics[op] || (atomics[op] = []);
    atomics[op] = atomics[op].concat(val);
  } <span class="keyword">else</span> <span class="keyword">if</span> (op === <span class="string">'$pullDocs'</span>) {
    <span class="keyword">var</span> pullOp = atomics[<span class="string">'$pull'</span>] || (atomics[<span class="string">'$pull'</span>] = {})
      , selector = pullOp[<span class="string">'_id'</span>] || (pullOp[<span class="string">'_id'</span>] = {<span class="string">'$in'</span> : [] });
    selector[<span class="string">'$in'</span>] = selector[<span class="string">'$in'</span>].concat(val);
  } <span class="keyword">else</span> {
    atomics[op] = val;
  }

  <span class="keyword">this</span>._markModified();
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>operation</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="MongooseArray-hasAtomics">MongooseArray#hasAtomics()</h3><p>Returns true if we have to perform atomics for this, and no normal<br />operations</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.hasAtomics = <span class="function"><span class="keyword">function</span> <span class="title">hasAtomics</span> <span class="params">()</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span>._atomics &amp;&amp; <span class="string">'Object'</span> === <span class="keyword">this</span>._atomics.constructor.name)) {
    <span class="keyword">return</span> <span class="number">0</span>;
  }

  <span class="keyword">return</span> Object.keys(<span class="keyword">this</span>._atomics).length;
}</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseArray-push">MongooseArray#push(<code>value</code>)</h3><p>Pushes item/s to the array atomically. Overrides Array#push</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.push = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> values = [].map.call(arguments, <span class="keyword">this</span>._cast, <span class="keyword">this</span>)
    , ret = [].push.apply(<span class="keyword">this</span>, values);

  <span class="comment">// $pushAll might be fibbed (could be $push). But it makes it easier to</span>
  <span class="comment">// handle what could have been $push, $pushAll combos</span>
  <span class="keyword">this</span>._registerAtomic(<span class="string">'$pushAll'</span>, values);
  <span class="keyword">return</span> ret;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="MongooseArray-nonAtomicPush">MongooseArray#nonAtomicPush(<code>value</code>)</h3><p>Pushes item/s to the array non-atomically</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.nonAtomicPush = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> values = [].map.call(arguments, <span class="keyword">this</span>._cast, <span class="keyword">this</span>)
    , ret = [].push.apply(<span class="keyword">this</span>, values);
  <span class="keyword">this</span>._registerAtomic(<span class="string">'$set'</span>, <span class="keyword">this</span>);
  <span class="keyword">return</span> ret;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Pops the array atomically</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.$pop = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>._registerAtomic(<span class="string">'$pop'</span>, <span class="number">1</span>);

  <span class="comment">// only allow popping once</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._popped) <span class="keyword">return</span>;
  <span class="keyword">this</span>._popped = <span class="literal">true</span>;

  <span class="keyword">return</span> [].pop.call(<span class="keyword">this</span>);
};</code></pre></div><p>Only works once per doc.save(). Calling this mulitple<br />times on an array before saving sends the same command<br />as calling it once. See MongoDB docs.</p></div><hr class=""><div class="method "><h3 id="MongooseArray-pop">MongooseArray#pop()</h3><p>Non-atomically pops the array.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.pop = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> ret = [].pop.call(<span class="keyword">this</span>);
  <span class="keyword">this</span>._registerAtomic(<span class="string">'$set'</span>, <span class="keyword">this</span>);
  <span class="keyword">return</span> ret;
};</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#the $pop atomic alternative method." title="the $pop atomic alternative method.">the $pop atomic alternative method.</a></li></ul></div><p>Note: marks the <em>entire</em> array as modified which<br />will pass the entire thing to $set potentially<br />overwritting any changes that happen between<br />when you retrieved the object and when you save<br />it.</p></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Atomically shifts the array.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.$shift = <span class="function"><span class="keyword">function</span> <span class="title">$shift</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>._registerAtomic(<span class="string">'$pop'</span>, -<span class="number">1</span>);

  <span class="comment">// only allow shifting once</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._shifted) <span class="keyword">return</span>;
  <span class="keyword">this</span>._shifted = <span class="literal">true</span>;

  <span class="keyword">return</span> [].shift.call(<span class="keyword">this</span>);
};</code></pre></div><p>Only works once per doc.save(). Calling this mulitple<br />times on an array before saving sends the same command<br />as calling it once. See MongoDB docs.</p></div><hr class=""><div class="method "><h3 id="MongooseArray-shift">MongooseArray#shift()</h3><p>shift</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.shift = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> ret = [].shift.call(<span class="keyword">this</span>);
  <span class="keyword">this</span>._registerAtomic(<span class="string">'$set'</span>, <span class="keyword">this</span>);
  <span class="keyword">return</span> ret;
};</code></pre></div><p>Non-atomically shifts the array.</p>

<p>Note: marks the <em>entire</em> array as modified which<br />will pass the entire thing to $set potentially<br />overwritting any changes that happen between<br />when you retrieved the object and when you save<br />it.</p></div><hr class=""><div class="method "><h3 id="MongooseArray-remove">MongooseArray#remove(<code>value</code>)</h3><p>remove</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.remove = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> args = [].map.call(arguments, <span class="keyword">this</span>._cast, <span class="keyword">this</span>);
  <span class="keyword">if</span> (args.length == <span class="number">1</span>)
    <span class="keyword">this</span>.pull(args[<span class="number">0</span>]);
  <span class="keyword">else</span>
    <span class="keyword">this</span>.pull.apply(<span class="keyword">this</span>, args);
  <span class="keyword">return</span> args;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to remove</span></li></ul></div><p>Removes items from an array atomically</p>

<h2>Examples</h2>

<pre><code>doc.array.remove(ObjectId)
doc.array.remove(<span class="string">'tag 1'</span>, <span class="string">'tag 2'</span>)</code></pre></div><hr class=""><div class="method "><h3 id="MongooseArray-pull">MongooseArray#pull()</h3><p>Pulls from the array</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.pull = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> values = [].map.call(arguments, <span class="keyword">this</span>._cast, <span class="keyword">this</span>)
    , cur = <span class="keyword">this</span>._parent.get(<span class="keyword">this</span>._path)
    , i = cur.length
    , mem;

  <span class="keyword">while</span> (i--) {
    mem = cur[i];
    <span class="keyword">if</span> (mem <span class="keyword">instanceof</span> EmbeddedDocument) {
      <span class="keyword">if</span> (values.some(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span> <span class="keyword">return</span> v.equals(mem); } )) {
        [].splice.call(cur, i, <span class="number">1</span>);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (~cur.indexOf.call(values, mem)) {
      [].splice.call(cur, i, <span class="number">1</span>);
    }
  }

  <span class="keyword">if</span> (values[<span class="number">0</span>] <span class="keyword">instanceof</span> EmbeddedDocument) {
    <span class="keyword">this</span>._registerAtomic(<span class="string">'$pullDocs'</span>, values.map( <span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span> <span class="keyword">return</span> v._id; } ));
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>._registerAtomic(<span class="string">'$pullAll'</span>, values);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseArray-splice">MongooseArray#splice()</h3><p>Splices the array.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.splice = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">if</span> (arguments.length) {
    <span class="keyword">var</span> ret = [].splice.apply(<span class="keyword">this</span>, arguments);
    <span class="keyword">this</span>._registerAtomic(<span class="string">'$set'</span>, <span class="keyword">this</span>);
  }
  <span class="keyword">return</span> ret;
};</code></pre></div><p>Note: marks the <em>entire</em> array as modified which<br />will pass the entire thing to $set potentially<br />overwritting any changes that happen on the db between<br />when you retrieved the object and when you save<br />it.</p></div><hr class=""><div class="method "><h3 id="MongooseArray-unshift">MongooseArray#unshift()</h3><p>Non-atomically unshifts onto the array.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.unshift = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> values = [].map.call(arguments, <span class="keyword">this</span>._cast, <span class="keyword">this</span>);
  [].unshift.apply(<span class="keyword">this</span>, values);
  <span class="keyword">this</span>._registerAtomic(<span class="string">'$set'</span>, <span class="keyword">this</span>);
  <span class="keyword">return</span> <span class="keyword">this</span>.length;
};</code></pre></div><p>Note: marks the <em>entire</em> array as modified which<br />will pass the entire thing to $set potentially<br />overwritting any changes that happen between<br />when you retrieved the object and when you save<br />it.</p></div><hr class=""><div class="method "><h3 id="MongooseArray-sort">MongooseArray#sort()</h3><p>sort</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.sort = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> ret = [].sort.apply(<span class="keyword">this</span>, arguments);
  <span class="keyword">this</span>._registerAtomic(<span class="string">'$set'</span>, <span class="keyword">this</span>);
  <span class="keyword">return</span> ret;
}</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseArray-addToSet">MongooseArray#addToSet()</h3><p>Adds values to the array if not already present.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.addToSet = <span class="function"><span class="keyword">function</span> <span class="title">addToSet</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> values = [].map.call(arguments, <span class="keyword">this</span>._cast, <span class="keyword">this</span>)
    , added = []
    , type = values[<span class="number">0</span>] <span class="keyword">instanceof</span> EmbeddedDocument ? <span class="string">'doc'</span> :
             values[<span class="number">0</span>] <span class="keyword">instanceof</span> Date ? <span class="string">'date'</span> :
             <span class="string">''</span>;

  values.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
    <span class="keyword">var</span> found;
    <span class="keyword">switch</span> (type) {
      <span class="keyword">case</span> <span class="string">'doc'</span>:
        found = <span class="keyword">this</span>.some(<span class="keyword">function</span>(doc){ <span class="keyword">return</span> doc.equals(v) });
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'date'</span>:
        <span class="keyword">var</span> val = +v;
        found = <span class="keyword">this</span>.some(<span class="keyword">function</span>(d){ <span class="keyword">return</span> +d === val });
        <span class="keyword">break</span>;
      <span class="keyword">default</span>:
        found = ~<span class="keyword">this</span>.indexOf(v);
    }

    <span class="keyword">if</span> (!found) {
      [].push.call(<span class="keyword">this</span>, v);
      <span class="keyword">this</span>._registerAtomic(<span class="string">'$addToSet'</span>, v);
      [].push.call(added, v);
    }
  }, <span class="keyword">this</span>);

  <span class="keyword">return</span> added;
};</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseArray-toObject">MongooseArray#toObject()</h3><p>Returns an native js Array</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.toObject = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>
  <span class="keyword">if</span> (options &amp;&amp; options.depopulate &amp;&amp; <span class="keyword">this</span>[<span class="number">0</span>] <span class="keyword">instanceof</span> Document) {
    <span class="keyword">return</span> <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
      <span class="keyword">return</span> doc._id;
    });
  }

  <span class="comment">// return this.slice()?</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
    <span class="keyword">return</span> doc;
  });
};</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="MongooseArray-inspect">MongooseArray#inspect()</h3><p>Helper for console.log</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.inspect = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="string">'['</span> + <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
    <span class="keyword">return</span> <span class="string">' '</span> + doc;
  }) + <span class="string">' ]'</span>;
};</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseArray-indexOf">MongooseArray#indexOf(<code>obj</code>)</h3><p>Return the index of <code>obj</code> or <code>-1.</code></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseArray.prototype.indexOf = <span class="function"><span class="keyword">function</span> <span class="title">indexOf</span> <span class="params">(obj)</span> {</span>
  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ObjectId) obj = obj.toString();
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="keyword">this</span>.length; i &lt; len; ++i) {
    <span class="keyword">if</span> (obj == <span class="keyword">this</span>[i])
      <span class="keyword">return</span> i;
  }
  <span class="keyword">return</span> -<span class="number">1</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="MongooseArray-indexOf">MongooseArray#indexOf()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = exports = MongooseArray;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/types/buffer.js">lib/types/buffer.js</a><div class="method private"><h3 id="MongooseBuffer">MongooseBuffer(<code>value</code>, <code>key</code>, <code>parent</code>)</h3><p>Mongoose Buffer constructor.<br />Values always have to be passed to the constructor to initialize, since<br />otherwise MongooseBuffer#push will mark the buffer as modified to the parent.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseBuffer</span> <span class="params">(value, encode, offset)</span> {</span>
  <span class="keyword">var</span> length = arguments.length;
  <span class="keyword">var</span> val;

  <span class="keyword">if</span> (<span class="number">0</span> === length || <span class="literal">null</span> === arguments[<span class="number">0</span>] || <span class="literal">undefined</span> === arguments[<span class="number">0</span>]) {
    val = <span class="number">0</span>;
  } <span class="keyword">else</span> {
    val = value;
  }

  <span class="keyword">var</span> encoding;
  <span class="keyword">var</span> path;
  <span class="keyword">var</span> doc;

  <span class="keyword">if</span> (Array.isArray(encode)) {
    <span class="comment">// internal casting</span>
    path = encode[<span class="number">0</span>];
    doc = encode[<span class="number">1</span>];
  } <span class="keyword">else</span> {
    encoding = encode;
  }

  <span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(val, encoding, offset);
  buf.__proto__ = MongooseBuffer.prototype;

  <span class="comment">// make sure these internal props don't show up in Object.keys()</span>
  Object.defineProperties(buf, {
      validators: { value: [] }
    , _path: { value: path }
    , _parent: { value: doc }
  });

  <span class="keyword">if</span> (doc &amp;&amp; <span class="string">"string"</span> === <span class="keyword">typeof</span> path) {
    Object.defineProperty(buf, <span class="string">'_schema'</span>, {
        value: doc.schema.path(path)
    });
  }

  <span class="keyword">return</span> buf;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Buffer">Buffer</a>&gt; </span><span></span></li><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>path</span></li><li><code>parent</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span>document</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bit.ly/f6CnZU">http://bit.ly/f6CnZU</a></li></ul></div></div><hr class="private"><div class="method "><h3 id="MongooseBuffer">MongooseBuffer()</h3><p>Inherit from Buffer.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseBuffer.prototype = <span class="keyword">new</span> Buffer(<span class="number">0</span>);</code></pre></div></div><hr class=""><div class="method private"><h3>MISSING method name</h3><p>Parent owner document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseBuffer.prototype._parent;</code></pre></div></div><hr class="private"><div class="method "><h3 id="MongooseBuffer-_markModified">MongooseBuffer#_markModified()</h3><p>Marks this buffer as modified.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseBuffer.prototype._markModified = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> parent = <span class="keyword">this</span>._parent;

  <span class="keyword">if</span> (parent) {
    parent.markModified(<span class="keyword">this</span>._path);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseBuffer-write">MongooseBuffer#write()</h3><p>Writes the buffer.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseBuffer.prototype.write = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> written = Buffer.prototype.write.apply(<span class="keyword">this</span>, arguments);

  <span class="keyword">if</span> (written > <span class="number">0</span>) {
    <span class="keyword">this</span>._markModified();
  }

  <span class="keyword">return</span> written;
};</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseBuffer-copy">MongooseBuffer#copy()</h3><p>Copy the buffer.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseBuffer.prototype.copy = <span class="function"><span class="keyword">function</span> <span class="params">(target)</span> {</span>
  <span class="keyword">var</span> ret = Buffer.prototype.copy.apply(<span class="keyword">this</span>, arguments);

  <span class="keyword">if</span> (target <span class="keyword">instanceof</span> MongooseBuffer) {
    target._markModified();
  }

  <span class="keyword">return</span> ret;
};</code></pre></div><p>Note: Buffer#copy will not mark target as modified so<br />you must copy from a MongooseBuffer for it to work<br />as expected.</p>

<p>Work around since copy modifies the target, not this.</p></div><hr class=""><div class="method "><h3>MISSING method name</h3><p>Compile other Buffer methods marking this buffer as modified.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">;(
<span class="comment">// node &lt; 0.5</span>
<span class="string">'writeUInt8 writeUInt16 writeUInt32 writeInt8 writeInt16 writeInt32 '</span> +
<span class="string">'writeFloat writeDouble fill '</span> +
<span class="string">'utf8Write binaryWrite asciiWrite set '</span> +

<span class="comment">// node >= 0.5</span>
<span class="string">'writeUInt16LE writeUInt16BE writeUInt32LE writeUInt32BE '</span> +
<span class="string">'writeInt16LE writeInt16BE writeInt32LE writeInt32BE '</span> +
<span class="string">'writeFloatLE writeFloatBE writeDoubleLE writeDoubleBE'</span>
).split(<span class="string">' '</span>).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(method)</span> {</span>
  <span class="keyword">if</span> (!Buffer.prototype[method]) <span class="keyword">return</span>;
  MongooseBuffer.prototype[method] = <span class="keyword">new</span> Function(
    <span class="string">'var ret = Buffer.prototype.'</span>+method+<span class="string">'.apply(this, arguments);'</span> +
    <span class="string">'this._markModified();'</span> +
    <span class="string">'return ret;'</span>
  )
});</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseBuffer-toObject">MongooseBuffer#toObject(<code>subtype</code>)</h3><p>Converts this buffer to its Binary type representation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseBuffer.prototype.toObject = <span class="function"><span class="keyword">function</span> <span class="params">(subtype)</span> {</span>
  subtype = <span class="keyword">typeof</span> subtype !== <span class="string">'undefined'</span> ? subtype : <span class="number">0x00</span>
  <span class="keyword">return</span> <span class="keyword">new</span> Binary(<span class="keyword">this</span>, subtype);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>subtype</code><span class="types"> &lt;<a href="#Hex">Hex</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Binary">Binary</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bsonspec.org/#/specification">http://bsonspec.org/#/specification</a></li></ul></div><h2>SubTypes are valid BSON spec types</h2>

<ul>
<li>0x00: Binary/Generic</li>
<li>0x01: Function</li>
<li>0x02: Binary (Deprecated, 0x00 is new default)</li>
<li>0x03: UUID</li>
<li>0x04: MD5</li>
<li>0x80: User Defined</li>
</ul></div><hr class=""><div class="method "><h3 id="MongooseBuffer-toObject">MongooseBuffer#toObject()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseBuffer.Binary = Binary;

module.exports = MongooseBuffer;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/types/documentarray.js">lib/types/documentarray.js</a><div class="method private"><h3 id="MongooseDocumentArray">MongooseDocumentArray(<code>values</code>, <code>key</code>, <code>parent</code>)</h3><p>Array of embedded documents<br />Values always have to be passed to the constructor to initialize, since<br />otherwise MongooseArray#push will mark the array as modified to the parent.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseDocumentArray</span> <span class="params">(values, path, doc)</span> {</span>
  <span class="keyword">var</span> arr = [];
  arr.push.apply(arr, values);
  arr.__proto__ = MongooseDocumentArray.prototype;

  arr._atomics = {};
  arr.validators = [];
  arr._path = path;

  <span class="keyword">if</span> (doc) {
    arr._parent = doc;
    arr._schema = doc.schema.path(path);
    doc.on(<span class="string">'save'</span>, arr.notify(<span class="string">'save'</span>));
    doc.on(<span class="string">'isNew'</span>, arr.notify(<span class="string">'isNew'</span>));
  }

  <span class="keyword">return</span> arr;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>values</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>path</span></li><li><code>parent</code><span class="types"> &lt;<a href="#Document">Document</a>&gt; </span><span>document</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bit.ly/f6CnZU">http://bit.ly/f6CnZU</a></li></ul></div></div><hr class="private"><div class="method "><h3 id="MongooseDocumentArray">MongooseDocumentArray()</h3><p>Inherits from MongooseArray</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseDocumentArray.prototype.__proto__ = MongooseArray.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3 id="MongooseDocumentArray-_cast">MongooseDocumentArray#_cast()</h3><p>Overrides cast</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseDocumentArray.prototype._cast = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
  <span class="keyword">var</span> doc = <span class="keyword">new</span> <span class="keyword">this</span>._schema.casterConstructor(value, <span class="keyword">this</span>);
  <span class="keyword">return</span> doc;
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="MongooseDocumentArray-id">MongooseDocumentArray#id(<code>id</code>)</h3><p>Filters items by id</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseDocumentArray.prototype.id = <span class="function"><span class="keyword">function</span> <span class="params">(id)</span> {</span>
  <span class="keyword">var</span> casted
    , _id;

  <span class="keyword">try</span> {
    casted = ObjectId.toString(ObjectIdSchema.prototype.cast.call({}, id));
  } <span class="keyword">catch</span> (e) {
    casted = <span class="literal">null</span>;
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.length; i &lt; l; i++) {
    _id = <span class="keyword">this</span>[i].get(<span class="string">'_id'</span>);
    <span class="keyword">if</span> (!(_id <span class="keyword">instanceof</span> ObjectId)) {
      <span class="keyword">if</span> (String(id) == _id)
        <span class="keyword">return</span> <span class="keyword">this</span>[i];
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (casted == _id)
        <span class="keyword">return</span> <span class="keyword">this</span>[i];
    }
  }

  <span class="keyword">return</span> <span class="literal">null</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="MongooseDocumentArray-toObject">MongooseDocumentArray#toObject()</h3><p>Returns an Array and converts any Document<br />members toObject.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseDocumentArray.prototype.toObject = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
    <span class="keyword">return</span> doc &amp;&amp; doc.toObject() || <span class="literal">null</span>;
  });
};</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="MongooseDocumentArray-inspect">MongooseDocumentArray#inspect()</h3><p>Helper for console.log</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseDocumentArray.prototype.inspect = function () {
  return '[' + this.map(function (doc) {
    if (doc) {
      return doc.inspect
        ? doc.inspect()
        : util.inspect(doc)
    }
    return 'null'
  }).join('
') + ']';
};</code></pre></div></div><hr class=""><div class="method "><h3 id="MongooseDocumentArray-create">MongooseDocumentArray#create()</h3><p>create</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseDocumentArray.prototype.create = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>._schema.casterConstructor(v);
}</code></pre></div><p>Creates a subdocument casted to this schema.</p></div><hr class=""><div class="method private"><h3 id="MongooseDocumentArray-notify">MongooseDocumentArray#notify(<code>event</code>)</h3><p>Create fn that notifies all child docs of event.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseDocumentArray.prototype.notify = <span class="function"><span class="keyword">function</span> <span class="title">notify</span> <span class="params">(event)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span> <span class="params">(val)</span> {</span>
    <span class="keyword">var</span> i = self.length;
    <span class="keyword">while</span> (i--) {
      self[i].emit(event, val);
    }
  }
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>event</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="MongooseDocumentArray-notify">MongooseDocumentArray#notify()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = MongooseDocumentArray;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/types/embedded.js">lib/types/embedded.js</a><div class="method private"><h3 id="EmbeddedDocument">EmbeddedDocument(<code>object</code>, <code>parent</code>)</h3><p>EmbeddedDocument constructor.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">EmbeddedDocument</span> <span class="params">(obj, parentArr, skipId)</span> {</span>
  <span class="keyword">if</span> (parentArr) {
    <span class="keyword">this</span>.__parentArray = parentArr;
    <span class="keyword">this</span>.__parent = parentArr._parent;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.__parentArray = <span class="literal">undefined</span>;
    <span class="keyword">this</span>.__parent = <span class="literal">undefined</span>;
  }

  Document.call(<span class="keyword">this</span>, obj, <span class="literal">undefined</span>, skipId);

  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">this</span>.on(<span class="string">'isNew'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
    self.isNew = val;
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>object</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>from db</span></li><li><code>parent</code><span class="types"> &lt;<a href="#MongooseDocumentArray">MongooseDocumentArray</a>&gt; </span><span>array</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="EmbeddedDocument">EmbeddedDocument()</h3><p>Inherit from Document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.__proto__ = Document.prototype;</code></pre></div></div><hr class=""><div class="method private"><h3>MISSING method name</h3><p>Marks parent array as modified</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="comment">// TODO remove commit alias</span>
EmbeddedDocument.prototype.commit =
EmbeddedDocument.prototype.markModified = <span class="function"><span class="keyword">function</span> <span class="params">(path)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.__parentArray) <span class="keyword">return</span>;

  <span class="keyword">this</span>._activePaths.modify(path);

  <span class="keyword">if</span> (<span class="keyword">this</span>.isNew) {
    <span class="comment">// Mark the WHOLE parent array as modified</span>
    <span class="comment">// if this is a new document (i.e., we are initializing</span>
    <span class="comment">// a document),</span>
    <span class="keyword">this</span>.__parentArray._markModified();
  } <span class="keyword">else</span>
    <span class="keyword">this</span>.__parentArray._markModified(<span class="keyword">this</span>, path);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="EmbeddedDocument-save">EmbeddedDocument#save()</h3><p>Noop. Does not actually save the doc to the db.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.save = <span class="keyword">function</span>(fn) {
  <span class="keyword">if</span> (fn)
    fn(<span class="literal">null</span>);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div></div><hr class=""><div class="method "><h3 id="EmbeddedDocument-remove">EmbeddedDocument#remove()</h3><p>Remove the subdocument</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.remove = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.__parentArray) <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">var</span> _id;
  <span class="keyword">if</span> (!<span class="keyword">this</span>.willRemove) {
    _id = <span class="keyword">this</span>._doc._id;
    <span class="keyword">if</span> (!_id) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'For your own good, Mongoose does not know '</span> + 
                      <span class="string">'how to remove an EmbeddedDocument that has no _id'</span>);
    }
    <span class="keyword">this</span>.__parentArray.pull({ _id: _id });
    <span class="keyword">this</span>.willRemove = <span class="literal">true</span>;
  }

  <span class="keyword">if</span> (fn)
    fn(<span class="literal">null</span>);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div></div><hr class=""><div class="method "><h3 id="EmbeddedDocument-inspect">EmbeddedDocument#inspect()</h3><p>Helper for console.log</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.inspect = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> inspect(<span class="keyword">this</span>.toObject());
};</code></pre></div></div><hr class=""><div class="method "><h3 id="EmbeddedDocument-invalidate">EmbeddedDocument#invalidate(<code>path</code>, <code>error</code>)</h3><p>Invalidate</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.invalidate = <span class="function"><span class="keyword">function</span> <span class="params">(path, err)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.__parent) <span class="keyword">return</span> <span class="literal">false</span>;
  <span class="keyword">var</span> index = <span class="keyword">this</span>.__parentArray.indexOf(<span class="keyword">this</span>);
  <span class="keyword">var</span> parentPath = <span class="keyword">this</span>.__parentArray._path;
  <span class="keyword">var</span> fullPath = [parentPath, index, path].join(<span class="string">'.'</span>);
  <span class="keyword">this</span>.__parent.invalidate(fullPath, err);
  <span class="keyword">return</span> <span class="literal">true</span>;
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>of the field to invalidate</span></li><li><code>error</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>of the path.</span></li></ul></div><p>Report accurate embedded paths for invalidation.</p></div><hr class=""><div class="method "><h3 id="EmbeddedDocument-invalidate">EmbeddedDocument#invalidate()</h3><p>Module exports.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = EmbeddedDocument;</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/types/index.js">lib/types/index.js</a></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/types/objectid.js">lib/types/objectid.js</a></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/utils.js">lib/utils.js</a><div class="method private"><h3 id="function Object() { [native code] }-toCollectionName">function Object() { [native code] }#toCollectionName(<code>model</code>)</h3><p>Produces a collection name from a model name</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.toCollectionName = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'system.profile'</span> === name) <span class="keyword">return</span> name;
  <span class="keyword">if</span> (<span class="string">'system.indexes'</span> === name) <span class="keyword">return</span> name;
  <span class="keyword">return</span> pluralize(name.toLowerCase());
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>model</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>collection name</span></li></ul></div></div><hr class="private"><div class="method "><h3 id="function Object() { [native code] }-toCollectionName">function Object() { [native code] }#toCollectionName()</h3><p>Pluralization rules.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> rules = [
  [<span class="regexp">/(m)an$/gi</span>, <span class="string">'$1en'</span>],
  [<span class="regexp">/(pe)rson$/gi</span>, <span class="string">'$1ople'</span>],
  [<span class="regexp">/(child)$/gi</span>, <span class="string">'$1ren'</span>],
  [<span class="regexp">/^(ox)$/gi</span>, <span class="string">'$1en'</span>],
  [<span class="regexp">/(ax|test)is$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(octop|vir)us$/gi</span>, <span class="string">'$1i'</span>],
  [<span class="regexp">/(alias|status)$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(bu)s$/gi</span>, <span class="string">'$1ses'</span>],
  [<span class="regexp">/(buffal|tomat|potat)o$/gi</span>, <span class="string">'$1oes'</span>],
  [<span class="regexp">/([ti])um$/gi</span>, <span class="string">'$1a'</span>],
  [<span class="regexp">/sis$/gi</span>, <span class="string">'ses'</span>],
  [<span class="regexp">/(?:([^f])fe|([lr])f)$/gi</span>, <span class="string">'$1$2ves'</span>],
  [<span class="regexp">/(hive)$/gi</span>, <span class="string">'$1s'</span>],
  [<span class="regexp">/([^aeiouy]|qu)y$/gi</span>, <span class="string">'$1ies'</span>],
  [<span class="regexp">/(x|ch|ss|sh)$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(matr|vert|ind)ix|ex$/gi</span>, <span class="string">'$1ices'</span>],
  [<span class="regexp">/([m|l])ouse$/gi</span>, <span class="string">'$1ice'</span>],
  [<span class="regexp">/(quiz)$/gi</span>, <span class="string">'$1zes'</span>],
  [<span class="regexp">/s$/gi</span>, <span class="string">'s'</span>],
  [<span class="regexp">/$/gi</span>, <span class="string">'s'</span>]
];</code></pre></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-toCollectionName">function Object() { [native code] }#toCollectionName()</h3><p>Uncountable words.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> uncountables = [
  <span class="string">'advice'</span>,
  <span class="string">'energy'</span>,
  <span class="string">'excretion'</span>,
  <span class="string">'digestion'</span>,
  <span class="string">'cooperation'</span>,
  <span class="string">'health'</span>,
  <span class="string">'justice'</span>,
  <span class="string">'labour'</span>,
  <span class="string">'machinery'</span>,
  <span class="string">'equipment'</span>,
  <span class="string">'information'</span>,
  <span class="string">'pollution'</span>,
  <span class="string">'sewage'</span>,
  <span class="string">'paper'</span>,
  <span class="string">'money'</span>,
  <span class="string">'species'</span>,
  <span class="string">'series'</span>,
  <span class="string">'rain'</span>,
  <span class="string">'rice'</span>,
  <span class="string">'fish'</span>,
  <span class="string">'sheep'</span>,
  <span class="string">'moose'</span>,
  <span class="string">'deer'</span>,
  <span class="string">'news'</span>
];</code></pre></div></div><hr class=""><div class="method private"><h3 id="pluralize">pluralize(<code>string</code>)</h3><p>Pluralize function.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">pluralize</span> <span class="params">(str)</span> {</span>
  <span class="keyword">var</span> rule, found;
  <span class="keyword">if</span> (!~uncountables.indexOf(str.toLowerCase())){
    found = rules.filter(<span class="keyword">function</span>(rule){
      <span class="keyword">return</span> str.match(rule[<span class="number">0</span>]);
    });
    <span class="keyword">if</span> (found[<span class="number">0</span>]) <span class="keyword">return</span> str.replace(found[<span class="number">0</span>][<span class="number">0</span>], found[<span class="number">0</span>][<span class="number">1</span>]);
  }
  <span class="keyword">return</span> str;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>string</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>to pluralize</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="pluralize">pluralize(<code>event</code>, <code>listener</code>)</h3><p>Add <code>once</code> to EventEmitter if absent</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> Events = EventEmitter;

<span class="keyword">if</span> (!(<span class="string">'once'</span> <span class="keyword">in</span> EventEmitter.prototype)){

  Events = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    EventEmitter.apply(<span class="keyword">this</span>, arguments);
  };</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>event</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name</span></li><li><code>listener</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div></div><hr class="private"><div class="method "><h3 id="pluralize">pluralize()</h3><p>Inherit from EventEmitter.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Events.prototype.__proto__ = EventEmitter.prototype;</code></pre></div></div><hr class=""><div class="method "><h3 id="Events-once">Events#once()</h3><p>Add <code>once</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Events.prototype.once = <span class="function"><span class="keyword">function</span> <span class="params">(type, listener)</span> {</span>
    <span class="keyword">var</span> self = <span class="keyword">this</span>;
    self.on(type, <span class="function"><span class="keyword">function</span> <span class="title">g</span><span class="params">()</span>{</span>
      self.removeListener(type, g);
      listener.apply(<span class="keyword">this</span>, arguments);
    });
  };

}

exports.EventEmitter = Events;

<span class="comment">// Modified from node/lib/assert.js</span>
exports.deepEqual = <span class="function"><span class="keyword">function</span> <span class="title">deepEqual</span> <span class="params">(a, b)</span> {</span>
  <span class="keyword">if</span> (a === b) <span class="keyword">return</span> <span class="literal">true</span>;

  <span class="keyword">if</span> (a <span class="keyword">instanceof</span> Date &amp;&amp; b <span class="keyword">instanceof</span> Date)
    <span class="keyword">return</span> a.getTime() === b.getTime();

  <span class="keyword">if</span> (a <span class="keyword">instanceof</span> ObjectId &amp;&amp; b <span class="keyword">instanceof</span> ObjectId) {
    <span class="keyword">return</span> a.toString() === b.toString();
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> a !== <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> b !== <span class="string">'object'</span>)
    <span class="keyword">return</span> a == b;

  <span class="keyword">if</span> (a === <span class="literal">null</span> || b === <span class="literal">null</span> || a === <span class="literal">undefined</span> || b === <span class="literal">undefined</span>)
    <span class="keyword">return</span> <span class="literal">false</span>

  <span class="keyword">if</span> (a.prototype !== b.prototype) <span class="keyword">return</span> <span class="literal">false</span>;

  <span class="comment">// Handle MongooseNumbers</span>
  <span class="keyword">if</span> (a <span class="keyword">instanceof</span> Number &amp;&amp; b <span class="keyword">instanceof</span> Number) {
    <span class="keyword">return</span> a.valueOf() === b.valueOf();
  }

  <span class="keyword">if</span> (Buffer.isBuffer(a)) {
    <span class="keyword">if</span> (!Buffer.isBuffer(b)) <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">if</span> (a.length !== b.length) <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = a.length; i &lt; len; ++i) {
      <span class="keyword">if</span> (a[i] !== b[i]) <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">return</span> <span class="literal">true</span>;
  }

  <span class="keyword">if</span> (isMongooseObject(a)) a = a.toObject();
  <span class="keyword">if</span> (isMongooseObject(b)) b = b.toObject();

  <span class="keyword">try</span> {
    <span class="keyword">var</span> ka = Object.keys(a),
        kb = Object.keys(b),
        key, i;
  } <span class="keyword">catch</span> (e) {<span class="comment">//happens when one is a string literal and the other isn't</span>
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="comment">// having the same number of owned properties (keys incorporates</span>
  <span class="comment">// hasOwnProperty)</span>
  <span class="keyword">if</span> (ka.length != kb.length)
    <span class="keyword">return</span> <span class="literal">false</span>;

  <span class="comment">//the same set of keys (although not necessarily the same order),</span>
  ka.sort();
  kb.sort();

  <span class="comment">//~~~cheap key test</span>
  <span class="keyword">for</span> (i = ka.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
    <span class="keyword">if</span> (ka[i] != kb[i])
      <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="comment">//equivalent values for every corresponding key, and</span>
  <span class="comment">//~~~possibly expensive deep test</span>
  <span class="keyword">for</span> (i = ka.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
    key = ka[i];
    <span class="keyword">if</span> (!deepEqual(a[key], b[key])) <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="keyword">return</span> <span class="literal">true</span>;
};</code></pre></div></div><hr class=""><div class="method private"><h3 id="Events-once">Events#once(<code>object</code>, <code>options</code>)</h3><p>Object clone with Mongoose natives support.<br />Creates a minimal data Object.<br />It does not clone empty Arrays, empty Objects,<br />and undefined values.<br />This makes the data payload sent to MongoDB as minimal<br />as possible.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> clone = exports.clone = <span class="function"><span class="keyword">function</span> <span class="title">clone</span> <span class="params">(obj, options)</span> {</span>
  <span class="keyword">if</span> (obj === <span class="literal">undefined</span> || obj === <span class="literal">null</span>)
    <span class="keyword">return</span> obj;

  <span class="keyword">if</span> (Array.isArray(obj))
    <span class="keyword">return</span> cloneArray(obj, options);

  <span class="keyword">if</span> (isMongooseObject(obj)) {
    <span class="keyword">if</span> (options &amp;&amp; options.json &amp;&amp; <span class="string">'function'</span> === <span class="keyword">typeof</span> obj.toJSON) {
      <span class="keyword">return</span> obj.toJSON(options);
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> obj.toObject(options);
    }
  }

  <span class="keyword">if</span> (<span class="string">'Object'</span> === obj.constructor.name)
    <span class="keyword">return</span> cloneObject(obj, options);

  <span class="keyword">if</span> (<span class="string">'Date'</span> === obj.constructor.name || <span class="string">'Function'</span> === obj.constructor.name)
    <span class="keyword">return</span> <span class="keyword">new</span> obj.constructor(+obj);

  <span class="keyword">if</span> (<span class="string">'RegExp'</span> === obj.constructor.name)
    <span class="keyword">return</span> <span class="keyword">new</span> RegExp(obj.source);

  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ObjectId) {
    <span class="keyword">return</span> <span class="keyword">new</span> ObjectId(obj.id);
  }

  <span class="keyword">if</span> (obj.valueOf)
    <span class="keyword">return</span> obj.valueOf();
};

<span class="function"><span class="keyword">function</span> <span class="title">cloneObject</span> <span class="params">(obj, options)</span> {</span>
  <span class="keyword">var</span> retainKeyOrder = options &amp;&amp; options.retainKeyOrder
    , minimize = options &amp;&amp; options.minimize
    , ret = {}
    , hasKeys
    , keys
    , val
    , k
    , i

  <span class="keyword">if</span> (retainKeyOrder) {
    <span class="keyword">for</span> (k <span class="keyword">in</span> obj) {
      val = clone(obj[k], options);

      <span class="keyword">if</span> (!minimize || (<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> val)) {
        hasKeys || (hasKeys = <span class="literal">true</span>);
        ret[k] = val;
      }
    }
  } <span class="keyword">else</span> {
    <span class="comment">// faster</span>

    keys = Object.keys(obj);
    i = keys.length;

    <span class="keyword">while</span> (i--) {
      k = keys[i];
      val = clone(obj[k], options);

      <span class="keyword">if</span> (!minimize || (<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> val)) {
        <span class="keyword">if</span> (!hasKeys) hasKeys = <span class="literal">true</span>;
        ret[k] = val;
      }
    }
  }

  <span class="keyword">return</span> minimize
    ? hasKeys &amp;&amp; ret
    : ret;
};

<span class="function"><span class="keyword">function</span> <span class="title">cloneArray</span> <span class="params">(arr, options)</span> {</span>
  <span class="keyword">var</span> ret = [];
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = arr.length; i &lt; l; i++)
    ret.push(clone(arr[i], options));
  <span class="keyword">return</span> ret;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>object</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to clone</span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>- minimize , retainKeyOrder</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>cloned object</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="function Object() { [native code] }-options">function Object() { [native code] }#options(<code>defaults</code>, <code>options</code>)</h3><p>Copies and merges options with defaults.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.options = <span class="function"><span class="keyword">function</span> <span class="params">(defaults, options)</span> {</span>
  <span class="keyword">var</span> keys = Object.keys(defaults)
    , i = keys.length
    , k ;

  options = options || {};

  <span class="keyword">while</span> (i--) {
    k = keys[i];
    <span class="keyword">if</span> (!(k <span class="keyword">in</span> options)) {
      options[k] = defaults[k];
    }
  }

  <span class="keyword">return</span> options;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>defaults</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>(merged) object</span></li></ul></div></div><hr class="private"><div class="method private"><h3 id="function Object() { [native code] }-random">function Object() { [native code] }#random()</h3><p>Generates a random string</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.random = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> Math.random().toString().substr(<span class="number">3</span>);
};

exports.inGroupsOf = <span class="function"><span class="keyword">function</span> <span class="title">inGroupsOf</span> <span class="params">(card, arr, fn)</span> {</span>
  <span class="keyword">var</span> group = [];
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = arr.length; i &lt; l; i++) {
    <span class="keyword">if</span> (i &amp;&amp; i % card === <span class="number">0</span>) {
      fn.apply(<span class="keyword">this</span>, group);
      group.length = <span class="number">0</span>;
    }
    group.push(arr[i]);
  }
  fn.apply(<span class="keyword">this</span>, group);
};</code></pre></div></div><hr class="private"><div class="method "><h3 id="function Object() { [native code] }-merge">function Object() { [native code] }#merge(<code>to</code>, <code>from</code>)</h3><p>Merges <code>from</code> into <code>to</code> without overwriting<br />existing properties of <code>to</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.merge = <span class="function"><span class="keyword">function</span> <span class="title">merge</span> <span class="params">(to, from)</span> {</span>
  <span class="keyword">var</span> keys = Object.keys(from)
    , i = keys.length
    , key

  <span class="keyword">while</span> (i--) {
    key = keys[i];
    <span class="keyword">if</span> (<span class="string">'undefined'</span> === <span class="keyword">typeof</span> to[key]) {
      to[key] = from[key];
    } <span class="keyword">else</span> {
      merge(to[key], from[key]);
    }
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>to</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>from</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="function Object() { [native code] }-args">function Object() { [native code] }#args()</h3><p>A faster Array.prototype.slice.call(arguments) alternative</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.args = <span class="function"><span class="keyword">function</span> <span class="params">(args, slice, sliceEnd)</span> {</span>
  <span class="keyword">var</span> ret = [];
  <span class="keyword">var</span> start = slice || <span class="number">0</span>;
  <span class="keyword">var</span> end = <span class="number">3</span> === arguments.length
    ? sliceEnd
    : args.length;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = start; i &lt; end; ++i) {
    ret[i - start] = args[i];
  }

  <span class="keyword">return</span> ret;
}</code></pre></div></div><hr class=""><div class="method private"><h3 id="function Object() { [native code] }-tick">function Object() { [native code] }#tick(<code>callback</code>)</h3><p>process.nextTick helper.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.tick = <span class="function"><span class="keyword">function</span> <span class="title">tick</span> <span class="params">(callback)</span> {</span>
  <span class="keyword">if</span> (<span class="string">'function'</span> !== <span class="keyword">typeof</span> callback) <span class="keyword">return</span>;
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">try</span> {
      callback.apply(<span class="keyword">this</span>, arguments);
    } <span class="keyword">catch</span> (err) {
      <span class="comment">// only nextTick on err to get out of</span>
      <span class="comment">// the event loop and avoid state corruption.</span>
      process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">throw</span> err;
      });
    }
  }
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><p>Wraps <code>callback</code> in a try/catch + nextTick.</p>

<p>-native has a habit of state corruption<br /> when an error is immediately thrown from within<br /> a collection callback.</p></div><hr class="private"><div class="method "><h3 id="function Object() { [native code] }-tick">function Object() { [native code] }#tick()</h3><p>Returns if <code>v</code> is a mongoose object that has<br />a <code>toObject()</code> method we can use. This is for<br />compatibility with libs like Date.js which do<br />foolish things to Natives.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> isMongooseObject = exports.isMongooseObject = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
  Document || (Document = require(<span class="string">'./document'</span>));
  MongooseArray || (MongooseArray = require(<span class="string">'./types'</span>).Array);
  MongooseBuffer || (MongooseBuffer = require(<span class="string">'./types'</span>).Buffer);

  <span class="keyword">return</span> v <span class="keyword">instanceof</span> Document ||
         v <span class="keyword">instanceof</span> MongooseArray ||
         v <span class="keyword">instanceof</span> MongooseBuffer
}</code></pre></div></div><hr class=""></li><li class="module"><a href="https://github.com/LearnBoost/mongoose/tree/3.0.0alpha2/lib/virtualtype.js">lib/virtualtype.js</a><div class="method "><h3 id="VirtualType">VirtualType()</h3><p>VirtualType constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">VirtualType</span> <span class="params">(options)</span> {</span>
  <span class="keyword">this</span>.getters = [];
  <span class="keyword">this</span>.setters = [];
  <span class="keyword">this</span>.options = options || {};
}</code></pre></div><p>This is what mongoose uses to define virtual attributes via<br /><code>Schema.prototype.virtual</code></p></div><hr class=""><div class="method "><h3 id="VirtualType-get">VirtualType#get(<code>fn</code>)</h3><p>Adds a getter</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.get = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">this</span>.getters.push(fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#VirtualType">VirtualType</a>&gt; </span><span>this</span></li></ul></div></div><hr class=""><div class="method "><h3 id="VirtualType-set">VirtualType#set(<code>fn</code>)</h3><p>Adds a setter</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.set = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
  <span class="keyword">this</span>.setters.push(fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#VirtualType">VirtualType</a>&gt; </span><span>this</span></li></ul></div></div><hr class=""><div class="method "><h3 id="VirtualType-applyGetters">VirtualType#applyGetters(<code>value</code>, <code>scope</code>)</h3><p>Applies getters</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.applyGetters = <span class="function"><span class="keyword">function</span> <span class="params">(value, scope)</span> {</span>
  <span class="keyword">var</span> v = value;
  <span class="keyword">for</span> (<span class="keyword">var</span> l = <span class="keyword">this</span>.getters.length - <span class="number">1</span>; l >= <span class="number">0</span>; l--){
    v = <span class="keyword">this</span>.getters[l].call(scope, v);
  }
  <span class="keyword">return</span> v;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""><div class="method "><h3 id="VirtualType-applySetters">VirtualType#applySetters(<code>value</code>, <code>scope</code>)</h3><p>Applies setters</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.applySetters = <span class="function"><span class="keyword">function</span> <span class="params">(value, scope)</span> {</span>
  <span class="keyword">var</span> v = value;
  <span class="keyword">for</span> (<span class="keyword">var</span> l = <span class="keyword">this</span>.setters.length - <span class="number">1</span>; l >= <span class="number">0</span>; l--){
    <span class="keyword">this</span>.setters[l].call(scope, v);
  }
  <span class="keyword">return</span> v;
};

module.exports = VirtualType;</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div></div><hr class=""></li></ul></div><script>document.body.className = 'load';</script><script>/*
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1122274-9']);
  _gaq.push(['_trackPageview']);
  
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  
  // TODO
  // get number of groups members?
*/</script><script src="/docs/js/zepto.min.js"></script><script>$(".module").on("click", ".showcode", function (e) {
  $(this).closest(".method").find(".sourcecode").first().toggle();
});</script></body></html>